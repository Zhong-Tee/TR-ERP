<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - Order Management System</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet"/>
    
    <!-- Tesseract.js for Slip OCR & Waybill Sorter -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Libraries for Waybill Sorter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    
    <!-- Library for QR Code Generation (Added for Packing System) -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>


    <style>
        /* --- TR KIDS GENERAL STYLES --- */
	#products-table { width: 100%; border-collapse: collapse; table-layout: auto; margin-top: 10px; }
	#products-table th, #products-table td { padding: 10px; vertical-align: middle; border-bottom: 1px solid #eee; text-align: left; }
	#products-table th:first-child, #products-table td:first-child { width: 70px; text-align: center; }
	#products-table th:last-child, #products-table td:last-child { width: 160px; text-align: center; background-color: #fcfcfc; }
	.action-cell-buttons { display: flex; gap: 8px; justify-content: center; align-items: center; }
	.action-cell-buttons { display: flex; gap: 6px; justify-content: center; align-items: center; }
	.btn-sm { padding: 6px 10px; font-size: 13px; line-height: 1; }
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0071e3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}
        body{font-family:'Sarabun', -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease, transform .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:0;height:calc(100vh - var(--top-bar-height))}.system-content{display:none}.system-content.active{display:block}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar .sidebar-header .toggle-btn{display: none;}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}body.sidebar-collapsed .sidebar .toggle-btn{transform:rotate(180deg)}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}.full-page-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#f4f7f9;z-index:2000;display:flex;justify-content:center;align-items:center}#main-app-container{display:none}
        .container{max-width:1800px;margin:20px auto;background:#fff;padding:25px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
        .btn{padding:12px 20px;border:none;border-radius:4px;font-size:16px;cursor:pointer}
        .btn.btn-sm{padding:5px 10px;font-size:12px}
        .btn-primary{background-color:#0071e3;color:#fff}.btn-secondary{background-color:#6c757d;color:#fff}.btn-success{background-color:#28a745;color:#fff}.btn-warning{background-color:#ffc107;color:#000}.btn-danger{background-color:#dc3545;color:#fff}.btn-info{background-color:#17a2b8;color:#fff}
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:1500;font-size:2em}
        .action-cell-buttons { display: flex; gap: 5px; } /* For product & planner action buttons */
        
        /* --- ORDER SYSTEM SPECIFIC STYLES --- */
        #order-system-container .batch-actions{margin-bottom:20px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
        #order-system-container .tab-filter { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #order-system-container .tab-filter select { width: 200px; }
        #order-system-container .tab-filter input[type="text"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 250px; margin-left: auto; }
        @media (max-width: 576px) { #order-system-container .tab-filter { flex-direction: column; align-items: stretch; } #order-system-container .tab-filter input[type="text"], #order-system-container .tab-filter select { margin-left: 0; width: 100%; } }
        #order-system-container .order-list { display: flex; flex-direction: column; gap: 0; max-height: 70vh; overflow-y: auto; list-style: none; padding: 0; margin: 0; border: 1px solid #e0e0e0; border-radius: 8px; }
        #order-system-container .order-list-item { display: grid; grid-template-columns: 40px 1fr 280px; align-items: center; gap: 20px; padding: 12px 15px; background: #fff; border: none; border-bottom: 1px solid #e0e0e0; box-shadow: none; border-radius: 0; transition: background-color 0.2s; }
        #order-system-container .order-list-item:last-child { border-bottom: none; }
        #order-system-container .order-list-item:hover { background-color: #f8f9fa; }
        #order-system-container .order-info { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; min-width: 0; flex-grow: 1; }
        #order-system-container .order-list-item > * { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #order-system-container .order-list-item strong { font-size: 1.1em; color: #0071e3; cursor: pointer; flex-shrink: 0; }
        #order-system-container .order-list-item strong:hover { text-decoration: underline; }
        #order-system-container .order-list-item .customer-info { font-size: 1.0em; color: #555; min-width: 50px; }
        #order-system-container .order-list-item .shipping-details { font-size: 0.8em; color: #6c757d; }
        #order-system-container .order-list-item .order-tracking { font-size: 0.9em; color: #28a745; font-weight: 700; text-align: right; }
        #order-system-container .order-checkbox { justify-self: center; }
        #order-system-container .work-order-group{border:1px solid #ccc;border-radius:4px;margin-bottom:15px; background: #f8f9fa;}
        #order-system-container .work-order-header{background-color:#e9ecef;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;font-weight:700;cursor:pointer}
        #order-system-container .work-order-header:hover{background-color:#dee2e6}
        #order-system-container .wo-name{flex-grow:1}
        #order-system-container .wo-header-actions{display:flex;align-items:center;gap:10px;flex-wrap: wrap;}
        #order-system-container .work-order-bills{background-color:#f0f2f5;padding:0; max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out;border-top:1px solid transparent}
        #order-system-container .work-order-bills.show{max-height:1500px;padding:15px;transition:max-height .5s ease-in,padding .5s ease-in;border-top:1px solid #ddd}
        #order-system-container .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        #order-system-container .form-grid.form-grid-main { display: grid; grid-template-columns: 1fr 1fr 2.5fr; gap: 20px; }
        #order-system-container .form-group.full-width { grid-column: 1 / -1; }
        #order-system-container label{margin-bottom:5px;font-weight:600}#order-system-container input,#order-system-container select,#order-system-container textarea{width: 100%; padding:10px;border:1px solid #ccc;border-radius:4px;font-size:16px;box-sizing:border-box}#order-system-container hr{border:0;height:1px;background:#e0e0e0;margin:25px 0}#order-system-container .tabs{border-bottom:2px solid #dee2e6;display:flex;flex-wrap:wrap;margin-bottom:20px}#order-system-container .tab-link{padding:10px 15px;cursor:pointer;background:0 0;border:none;font-size:16px;border-bottom:3px solid transparent}#order-system-container .tab-link.active{border-bottom-color:#0071e3;font-weight:600;color:#0071e3}#order-system-container .tab-content{display:none}#order-system-container .tab-content.active{display:block}
        #order-system-container .items-table-container{overflow-x:auto}#order-system-container #items-table{width:100%;border-collapse:collapse;margin-bottom:10px;table-layout:fixed;}#order-system-container #items-table th,#order-system-container #items-table td{border:1px solid #ddd;padding:2px;text-align:left;vertical-align:top;word-wrap:break-word;}#order-system-container #items-table th{background-color:#f8f9fa;font-size:14px;padding:8px;white-space:nowrap}
        #items-table th:nth-child(1) { width: 250px; } #items-table th:nth-child(2) { width: 120px; } #items-table th:nth-child(3) { width: 80px; } #items-table th:nth-child(4) { width: 120px; } #items-table th:nth-child(5) { width: 100px; } #items-table th:nth-child(6) { width: 120px; } #items-table th:nth-child(7) { width: 150px; } #items-table th:nth-child(8) { width: 150px; } #items-table th:nth-child(9) { width: 150px; } #items-table th:nth-child(10) { width: 70px; } #items-table th:nth-child(11) { width: 180px; } #items-table th:nth-child(12) { width: 120px; } #items-table th:nth-child(13) { width: 50px; }
        #order-system-container #items-table input,#order-system-container #items-table select{width:100%;font-size:14px;padding:6px;border:none;background:0 0;box-sizing:border-box}#order-system-container #items-table input:focus,#order-system-container #items-table select:focus{outline:2px solid #0071e3;background:#fff}
        #order-system-container #items-table .select2-container{width:100%!important}
        #order-system-container #items-table .select2-selection--single{height:32px!important;border:none!important; display: flex; align-items: center;}
        #order-system-container #items-table .select2-selection__rendered{padding-left: 0 !important; line-height: normal !important;}
        #order-system-container #items-table .select2-selection__arrow{height:30px!important}
        #order-system-container .form-grid .select2-container .select2-selection--single { height: 42px !important; display: flex; align-items: center; }
        #order-system-container .form-grid .select2-container .select2-selection__rendered { padding-top: 0 !important; padding-bottom: 0 !important; }
        #order-system-container .form-grid .select2-container .select2-selection__arrow { height: 40px !important; }
        #order-system-container #items-table .quantity-input{width:70px;text-align:center}#order-system-container #items-table .action-cell{width:50px;text-align:center}#order-system-container #items-table .remove-item-btn{font-size:12px;padding:4px 8px}
        #order-system-container .btn-edit-tracking { background: transparent; border: none; cursor: pointer; padding: 0 5px; font-size: 14px; }
        #order-system-container .tracking-edit-container { display: flex; gap: 5px; align-items: center; }
        #order-system-container .tracking-input { padding: 4px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 100px; }
        .channel-summary { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 12px 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; min-height: 50px; align-items: center; }
        .channel-summary-item { background-color: #0071e3; color: white; padding: 6px 14px; border-radius: 16px; font-size: 14px; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; }
        .channel-summary-item:hover { background-color: #0056b3; }
        .channel-summary-placeholder { color: #6c757d; font-style: italic; }
        #order-system-container .quantity-input-group { display: flex; align-items: center; gap: 8px; }
        #order-system-container .quantity-input-group input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

        /* --- STYLES FOR TAX INVOICE SECTION (NEW & MODIFIED) --- */
        #tax-invoice-details-section {
            display: none;
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #0071e3;
            border-radius: 8px;
            background-color: #f8fbff;
        }
        #tax-invoice-details-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #0071e3;
            border-bottom: 1px solid #d6e8ff;
            padding-bottom: 10px;
        }
        #tax-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #tax-items-table th, #tax-items-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #tax-items-table th {
            background-color: #e9ecef;
        }
        #tax-items-table input {
            width: 100%;
            padding: 6px;
            font-size: 14px;
        }
        #tax-items-table .tax-item-qty {
            text-align: center;
            background-color: #f8f9fa;
        }
        #tax-items-table .tax-item-total {
            text-align: right;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .billing-checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
        }
        .billing-checkbox-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .billing-checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        #vat-display-container input {
            background-color: #e9ecef;
            font-weight: bold;
            text-align: right;
        }


        /* --- PACKING SYSTEM SPECIFIC STYLES --- */
        #packing-system-container{padding:0}#packing-system-container .header{text-align:center;padding:15px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap;margin-bottom:0}#packing-system-container .header h1{margin:0;font-size:24px;color:var(--primary-color)}#packing-system-container .header .action-buttons{display:flex;gap:10px}#packing-system-container .btn-back{background-color:#6c757d;color:#fff}#work-order-selection-view{padding:40px;text-align:center}#work-order-selection-view h2{margin-top:0}#work-order-list{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;list-style:none;padding:0}.work-order-item button{display:flex; align-items:center; gap: 10px; padding:20px 30px;font-size:1.1em;cursor:pointer;border:1px solid #0071e3;background-color:#f0f8ff;border-radius:8px;transition:all .2s}.work-order-item button:hover{background-color:#e0effc;box-shadow:0 2px 5px rgba(0,0,0,.1)}.work-order-item button.no-tracking { border-color: #ffc107; background-color: #fff8e1; } .work-order-item button .status-icon { font-size: 1.2em; } #packing-main-view{display:none}#packing-main-view .main-container{display:flex;height:calc(100vh - var(--top-bar-height) - 100px)}#packing-main-view #order-nav-panel{width:300px;background:#fff;border-right:1px solid #d2d2d7;display:flex;flex-direction:column;flex-shrink:0}#packing-main-view #nav-header{padding:15px;border-bottom:1px solid #d2d2d7;text-align:center}#packing-main-view #order-counter{font-size:16px;font-weight:600}#packing-main-view #search-input{width:calc(100% - 24px);padding:8px 12px;margin-top:10px;border:1px solid #d2d2d7;border-radius:6px}#packing-main-view #order-list{list-style:none;padding:0;margin:0;overflow-y:auto;flex-grow:1}#packing-main-view .order-item{padding:12px 15px;border-bottom:1px solid #e5e5e5;cursor:pointer;-webkit-user-select:none;user-select:none}#packing-main-view .order-item.active{background-color:#e0effc}#packing-main-view .order-item.completed{color:#28a745}#packing-main-view .order-item .tracking-id{font-weight:700;display:block}#packing-main-view .order-item .customer-name{font-size:.9em;color:#6e6e73}#packing-main-view #content-panel{flex-grow:1;display:flex;flex-direction:column;overflow:hidden;background:#fff}#packing-main-view #action-panel{padding:20px;flex-shrink:0;background-color:#f8f8fa;border-bottom:1px solid #d2d2d7}
.ink-tag {
    display: inline-flex;  /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô flex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    align-items: center;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 12px;      /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.ink-icon {
    font-size: 28px;      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
    margin-right: 8px;
    line-height: 1;
}
.ink-fabric { background-color: #e3f2fd; border: 1px solid #bbdefb; } /* ‡∏ú‡πâ‡∏≤ - ‡∏ü‡πâ‡∏≤ */
.ink-plastic { background-color: #fff3e0; border: 1px solid #ffe0b2; } /* ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å - ‡∏™‡πâ‡∏° */
.ink-paper { background-color: #f5f5f5; border: 1px solid #e0e0e0; } /* ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© - ‡πÄ‡∏ó‡∏≤ */
        #packing-main-view .action-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        #packing-main-view .action-step{margin-bottom:0}
        #packing-main-view .action-step:last-child{margin-bottom:0}#packing-main-view .action-step h3{margin:0 0 10px;font-size:18px;text-align:center}
        
        #packing-main-view .action-step input{font-size:16px;padding:10px;text-align:center;border:2px solid;border-radius:8px;max-width:400px;width:100%;display:block;margin:0 auto; text-transform: uppercase;}
        
        #packing-main-view #parcel-scan-input{border-color:#28a745}
        #packing-main-view #item-scan-input{border-color:#0071e3}
        #packing-main-view input:disabled{background-color:#e9ecef;border-color:#ced4da;cursor:not-allowed}#packing-main-view #status-message{margin-top:15px;font-size:20px;font-weight:700;height:28px;text-align:center}#packing-main-view .status-success{color:#28a745}#packing-main-view .status-error{color:#dc3545}#packing-main-view #result-container{padding:25px;overflow-y:auto;flex-grow:1}#packing-main-view table{width:100%;border-collapse:collapse;margin-top:15px}
        #packing-main-view th, #packing-main-view td{padding: 8px 6px; font-size: 14px; border:1px solid #d2d2d7;text-align:left;transition:background-color .3s;white-space:normal; vertical-align: middle;}
        #packing-main-view .qr-code-container { display: flex; justify-content: center; align-items: center; min-height: 80px; }
        #packing-main-view thead{background-color:#f0f0f0}#packing-main-view tr.item-scanned{background-color:#e2f0e3}#packing-main-view tr.item-scanned td:first-child::before{content:""}

        /* --- PRODUCT SYSTEM SPECIFIC STYLES --- */
        #product-system-container .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        #product-system-container .table-container { overflow-x: auto; }
        #product-system-container table { width: 100%; border-collapse: collapse; }
        #product-system-container th, #product-system-container td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #product-system-container th { background-color: #f8f9fa; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1600; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content h2 { margin-top: 0; }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .modal-form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .modal-actions { text-align: right; margin-top: 20px; flex-shrink: 0; }
        
        /* --- PICKING SLIP MODAL SPECIFIC STYLES --- */
        #picking-slip-preview { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; }
        #picking-slip-preview h3 { margin-top: 0; }
        #picking-slip-preview table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
        #picking-slip-preview th, #picking-slip-preview td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #picking-slip-preview th { background-color: #f2f2f2; }
        #picking-slip-png-container { 
    position: absolute; 
    left: -9999px; 
    top: 0; 
    width: 148mm; 
    min-height: 210mm; 
    padding: 10mm; 
    background: white; 
    font-family: 'Sarabun', sans-serif; 
    color: black; 
    display: flex; 
    flex-direction: column; 
    box-sizing: border-box;
}
#picking-slip-png-container table { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed; }
#picking-slip-png-container th, #picking-slip-png-container td { 
    border: 1px solid black; 
    padding: 3px 5px; /* ‡∏•‡∏î Padding ‡∏•‡∏á */
    text-align: left; 
    font-size: 11px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    word-wrap: break-word; 
}
#picking-slip-png-container h3 { font-size: 13px; margin: 10px 0 5px 0; }
        
        /* --- RESPONSIVE DESIGN --- */
        #mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        @media (max-width: 992px) { body.sidebar-collapsed .page-wrapper { margin-left: var(--sidebar-width-collapsed); } }
        @media (max-width: 768px) {
            #mobile-menu-toggle { display: block; }
            .sidebar { transform: translateX(-100%); z-index: 1100; }
            body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); }
            .page-wrapper, body.sidebar-collapsed .page-wrapper { margin-left: 0; }
            .sidebar .sidebar-header .toggle-btn { display: none; }
            .container { padding: 15px; }
            #order-system-container .form-grid.form-grid-main { grid-template-columns: 1fr; }
            #order-system-container .batch-actions { flex-direction: column; align-items: stretch; }
            #order-system-container .batch-actions .btn { width: 100%; margin-bottom: 5px; }
            #packing-main-view .main-container { flex-direction: column; height: auto; }
            #packing-main-view #order-nav-panel { width: 100%; border-right: none; border-bottom: 1px solid #d2d2d7; height: 40vh; }
            #packing-main-view #content-panel { height: 60vh; }
            .top-bar { padding: 0 15px; }
            #user-info-bar #welcome-message { display: none; }
        }

        /* --- PRODUCTION PLANNER STYLES (SCOPED) --- */
        #planner-system-container{ --primary:#2563eb; --muted:#6b7280; --bg:#f7fafc; --card:#fff; --border:#e5e7eb; --ink:#111827 }
        #planner-system-container .main-content { padding: 0 !important; }
        #planner-system-container header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--border)}
        #planner-system-container header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:100%;margin:0 auto}
        #planner-system-container h1{font-size:20px;margin:0}
        #planner-system-container .wrap{max-width:100%;margin:0 auto;padding:16px 24px 80px;}
        #planner-system-container .wrap-dashboard { max-width: 100%; padding: 16px 24px 80px; }
        #planner-system-container .grid{display:grid;gap:12px}
        #planner-system-container .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
        #planner-system-container .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
        #planner-system-container .grid-2-1{grid-template-columns:2fr 1fr}
        @media (max-width:980px){ #planner-system-container .g-2, #planner-system-container .g-3, #planner-system-container .grid-2-1{grid-template-columns:1fr} }
        #planner-system-container .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
        #planner-system-container .card h2, #planner-system-container .card h3{margin:0 0 8px;padding:12px 14px;border-bottom:1px solid var(--border);font-size:18px}
        #planner-system-container .card .inner{padding:12px 14px}
        #planner-system-container label{font-size:13px;color:var(--muted);display:block;margin-bottom:2px;}
        #planner-system-container input, #planner-system-container select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
        #planner-system-container .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
        #planner-system-container .row+.row{margin-top:8px}
        #planner-system-container .btn{appearance:none;border:1px solid var(--primary);background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
        #planner-system-container .btn.secondary{background:#fff;color:var(--primary)}
        #planner-system-container .btn.gray{background:#f3f4f6;color:#111;border-color:#e5e7eb}
        #planner-system-container .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
        #planner-system-container .btn:disabled{opacity:.6;cursor:not-allowed}
        #planner-system-container .btn.active{outline:2px solid var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
        #planner-system-container .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
        #planner-system-container .list{display:flex;flex-direction:column;gap:10px;min-height:60px;}
        #planner-system-container .job{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px; transition: background-color 0.3s, border-color 0.3s;}
        #planner-system-container .job.dragging{opacity:0.5;border-style:dashed;}
        #planner-system-container .jobhead{display:flex;gap:10px;align-items:center;padding-bottom:8px;border-bottom:1px solid var(--border);}
        #planner-system-container .drag{cursor:grab;user-select:none;font-size:18px;line-height:1;padding:2px 8px}
        #planner-system-container .job .title{font-weight:700}
        #planner-system-container .job small{color:var(--muted)}
        #planner-system-container .procwrap{padding:10px 0 0}
        #planner-system-container .proc{border:1px dashed var(--border);border-radius:12px;padding:8px;background:#fdfdfd}
        #planner-system-container .proc+.proc{margin-top:6px;}
        #planner-system-container .proc h4{margin:0 0 4px;font-size:14px}
        #planner-system-container .proc .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
        #planner-system-container .proc .timebox{display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center}
        #planner-system-container .proc .act{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
        #planner-system-container .proc .act .btn{padding:6px 10px;border-radius:10px;font-size:12px}
        #planner-system-container .rowcols{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:8px}
        #planner-system-container .rowcols>div{display:flex;flex-direction:column;gap:6px}
        #planner-system-container table{width:100%;border-collapse:separate;border-spacing:0}
        #planner-system-container th, #planner-system-container td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align: top;}
        #planner-system-container th{font-size:12px;color:#374151;background:#f9fafb;position:sticky;top:0; white-space: nowrap;}
        #planner-system-container .dept-divider { border-left: 2px solid #dde4ed; }
        #planner-system-container .cut-time-divider { border-left: 2px solid #dde4ed; }
        #planner-system-container tr:hover td{background:#fafafa}
        #planner-system-container tr.dragging td { background: #ebf8ff; border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); }
        #planner-system-container .drag-handle { cursor: grab; padding-right: 10px; font-size: 16px; color: #9ca3af; }
        #planner-system-container .footerbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:8px 12px;display:flex;gap:8px;justify-content:center; z-index: 10;}
        #planner-system-container .hidden{display:none}
        #planner-system-container .help{font-size:12px;color:var(--muted)}
        #planner-system-container .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border); font-size:12px; background:#f9fafb;}
        #planner-system-container .right{margin-left:auto}
        #planner-system-container .inline{display:inline-flex;gap:6px;align-items:center}
        #planner-system-container .mini{padding:4px 8px;font-size:12px;border-radius:8px}
        #planner-system-container .toolbar{display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin-bottom:12px}
        #planner-system-container input::placeholder{ color:#9ca3af }
        #planner-system-container .toggle{margin-left:auto}
        #planner-system-container .dept-board{ display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        #planner-system-container .line-container{ padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: #f9fafb; }
        #planner-system-container .line-container h3{ margin: 0 0 10px; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        #planner-system-container .line-assign-select { font-size: 12px; padding: 4px 6px; border-radius: 8px; min-width: 85px; }
        #planner-system-container .qty-pills-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        #planner-system-container .status-cell { display: flex; flex-direction: column; align-items: start; gap: 4px; }
        #planner-system-container .nav-group { display: inline-flex; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #planner-system-container .nav-group .btn { flex: 1; text-align: center; background: #fff; color: var(--ink); border: none; border-radius: 0; border-left: 1px solid var(--border); font-weight: 600; padding: 8px 16px; }
        #planner-system-container .nav-group .btn:first-child { border-left: none; }
        #planner-system-container .nav-group .btn.active, #planner-system-container .nav-group .btn:hover { background: var(--primary); color: #fff; z-index: 1; }
        #planner-system-container .nav-group .btn.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        #planner-system-container .status-badge { display: inline-block; padding: 3px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; border: 1px solid transparent; background-color: #f3f4f6; color: #374151; border-color: #e5e7eb; }
        #planner-system-container .status-badge.status-progress { background-color: #e0f2fe; color: #0c4a6e; border-color: #bae6fd; }
        #planner-system-container .status-badge.status-done { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        #planner-system-container tr.status-row-progress td { background-color: #f0f9ff !important; }
        #planner-system-container tr.status-row-done td { background-color: #f0fdf4 !important; }
        #planner-system-container .job.job-card-progress { background-color: #f0f9ff; border-color: #bae6fd; }
        #planner-system-container .job.job-card-done { background-color: #f0fdf4; border-color: #bbf7d0; }
        #planner-system-container .checkbox-cell { width: 40px; text-align: center; }
        #planner-system-container tr.row-selected td { background-color: #fffbeb !important; }
        #planner-system-container .plan-time-hint { color: #9ca3af; font-weight: normal; font-size: 11px; }
        
        /* --- STYLES for Job Editor Modal --- */
        #job-editor-title {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 22px;
            color: var(--ink, #111827);
        }
        .planner-form-grid {
            display: grid;
            margin-bottom: 20px;
        }
        .planner-section-title {
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border, #e5e7eb);
            color: #333;
        }
        .planner-form-group label, .planner-qty-group label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #555;
        }
        #job-editor-modal-container input[type="date"],
        #job-editor-modal-container input[type="time"],
        #job-editor-modal-container input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #job-editor-modal-container input:focus {
            outline: none;
            border-color: var(--primary, #2563eb);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        .planner-qty-group {
            display: grid;
            grid-template-columns: 80px 1fr;
            align-items: center;
            gap: 10px;
        }
        .planner-qty-group label {
            margin-bottom: 0;
            font-weight: normal;
            text-align: right;
            color: var(--muted, #6b7280);
        }
        #job-editor-modal-container .modal-actions {
            margin-top: 30px;
        }
        
        /* --- SALES REPORT SYSTEM SPECIFIC STYLES --- */
        #sales-report-system-container .report-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 25px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; }
        #sales-report-system-container .control-group { display: flex; flex-direction: column; }
        #sales-report-system-container .control-group label { margin-bottom: 5px; font-size: 14px; font-weight: 600; color: #495057; }
        #sales-report-system-container .control-group input[type="date"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #sales-report-system-container .report-results-container { max-height: 65vh; overflow-y: auto; }
        #sales-report-system-container #report-table { width: 100%; border-collapse: collapse; }
        #sales-report-system-container #report-table th, #sales-report-system-container #report-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
        #sales-report-system-container #report-table th { background-color: #e9ecef; position: sticky; top: 0; z-index: 1; }
        #sales-report-system-container #report-table tr:nth-child(even) { background-color: #f8f9fa; }
        #sales-report-system-container #report-table td:last-child { font-weight: bold; text-align: center; }
        #sales-report-system-container #report-placeholder { text-align: center; color: #6c757d; padding: 40px; font-style: italic; }
.packing-product-img {
            transition: transform 0.2s ease-in-out;
            cursor: zoom-in;
            position: relative;
            z-index: 1;
        }
        .packing-product-img:hover {
            transform: scale(4); 
            transform-origin: left center; 
            z-index: 9999;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 2px solid #fff;
        }
        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ã‡∏π‡∏° */
        .table-container, 
        #product-system-container .table-container, 
        #pattern-system-container .container,
        #packing-main-view td {
            overflow: visible !important;
        }
        #products-table td, #patterns-table td, #packing-main-view td {
            position: relative;
        }
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ */
        #packing-main-view td { word-wrap: break-word; white-space: normal !important; }
    </style>
</head>
<body class="sidebar-collapsed">
<div id="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div id="login-overlay" class="full-page-overlay">
        <div id="login-container" style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px;">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
            <form id="login-form">
                <div style="margin-bottom: 20px; text-align: left;"><label for="email" style="display: block; margin-bottom: 5px; font-weight: 600;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="email" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <div style="margin-bottom: 20px; text-align: left;"><label for="password" style="display: block; margin-bottom: 5px; font-weight: 600;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="password" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <button type="submit" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; background-color: #0071e3; color: white;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p id="error-message" style="color: #dc3545; margin-top: 15px; height: 20px;"></p>
            </form>
        </div>
    </div>
    
    <div id="main-app-container" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>TR Kids</h2>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-target="order-system-container"><span class="icon">üìù</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</span></a></li>
                    <li id="nav-planner"><a href="#" class="nav-link" data-target="planner-system-container"><span class="icon">üóìÔ∏è</span><span class="nav-text">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Export)</span></a></li>
                    <li><a href="#" class="nav-link" data-target="packing-system-container"><span class="icon">üì¶</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span></a></li>
                    <li id="nav-product"><a href="#" class="nav-link" data-target="product-system-container"><span class="icon">üè∑Ô∏è</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></a></li>
	<li id="nav-pattern"><a href="#" class="nav-link" data-target="pattern-system-container"><span class="icon">üñºÔ∏è</span><span class="nav-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</span></a></li>
                    <li id="nav-sales-report"><a href="#" class="nav-link" data-target="sales-report-system-container"><span class="icon">üìà</span><span class="nav-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span></a></li>
                    <li id="nav-accounting"><a href="accounting.html" class="nav-link"><span class="icon">üìä</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="page-wrapper">
            <header class="top-bar">
                <button id="mobile-menu-toggle">‚ò∞</button>
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="main-content">
                <!-- ==================== ORDER SYSTEM ==================== -->
                <div id="order-system-container" class="system-content active">
                    <div class="container">
                        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
                        
                        <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; flex-wrap: wrap;">
                            <div class="control-group">
                                <label for="master-status-start-date" style="font-weight: 600; font-size: 14px; display: block; margin-bottom: 5px;">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°)</label>
                                <input type="date" id="master-status-start-date" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                            </div>
                            <div class="control-group">
                                <label for="master-status-end-date" style="font-weight: 600; font-size: 14px; display: block; margin-bottom: 5px;">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°)</label>
                                <input type="date" id="master-status-end-date" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                            </div>
                            <button id="export-master-status-btn" class="btn btn-success">üìä Export ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏° (Excel)</button>
                        </div>
                        
                        <input type="file" id="tracking-file-input" style="display: none;" accept=".csv, text/csv">
                        <input type="file" id="import-orders-file-input" style="display: none;" accept=".csv, .xlsx, .xls">
                        
                        <input type="file" id="slip-file-input" style="display: none;" accept="image/*">

                        <div class="tabs">
                            <button class="tab-link active" data-tab="tab-create">‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="tab-link" data-tab="tab-waiting">‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            <button class="tab-link" data-tab="tab-complete">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                            <button class="tab-link" data-tab="tab-work-orders">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)</button>
                            <button class="tab-link" data-tab="tab-shipped">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
                            <button class="tab-link" data-tab="tab-cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                        <div id="tab-create" class="tab-content active">
                            <h2 id="form-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</h2>
                            <form id="order-form">
                                <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å</h3>
                                <div class="form-grid form-grid-main">
                                    <div class="form-group"><label for="channel_code">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select id="channel_code" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option></select></div>
                                    <div class="form-group"><label for="admin_user">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label><input type="text" id="admin_user" required readonly></div>
                                    <div class="form-group"><label for="customer_name">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="customer_name" required></div>
                                    <div class="form-group full-width"><label for="customer_address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><textarea id="customer_address" rows="4" required></textarea></div>
                                </div>
                                
                                <div id="claim-details-section" style="display: none; margin-top: 20px;">
                                    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</h4>
                                    <div class="form-grid" style="grid-template-columns: 1fr;">
                                        <div class="form-group">
                                            <label for="claim_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏•‡∏°</label>
                                            <input type="text" id="claim_type">
                                        </div>
                                        <div class="form-group">
                                            <label for="claim_details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏•‡∏°</label>
                                            <textarea id="claim_details" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr>
                                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                <div class="batch-actions">
                                    <button type="button" id="download-template-btn" class="btn btn-info">üì• Template (Standard)</button>
                                    <button type="button" id="download-pgtr-template-btn" class="btn btn-info">üì• Template (PGTR)</button>
                                    <button type="button" id="download-wy-template-btn" class="btn btn-info">üì• Template (WY)</button>
                                    <button type="button" id="import-orders-btn" class="btn btn-success">üì§ Import Orders from File</button>
                                </div>
                                <div class="items-table-container"><table id="items-table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å</th><th>‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</th><th>‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô</th><th>‡∏ü‡∏≠‡∏ô‡∏ï‡πå</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th><th></th></tr></thead><tbody id="items-tbody"></tbody></table></div><button type="button" id="add-item-btn" class="btn btn-secondary">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button><hr>
                                
                                <div id="payment-info-section">
                                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                                    <div class="form-grid" style="grid-template-columns: repeat(5, 1fr); gap: 15px;">
                                        <div class="form-group"><label for="price">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="price" value="0" step="0.01"></div>
                                        <div class="form-group"><label for="shipping_cost">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</label><input type="number" id="shipping_cost" value="0" step="0.01"></div>
                                        <div class="form-group"><label for="discount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label><input type="number" id="discount" value="0" step="0.01"></div>
                                        <div class="form-group" id="vat-display-container" style="display: none;">
                                            <label for="vat_amount">VAT (7%)</label>
                                            <input type="number" id="vat_amount" readonly>
                                        </div>
                                        <div class="form-group"><label for="total_amount">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label><input type="number" id="total_amount" readonly></div>
                                    </div>
                                    <div class="form-grid" style="margin-top: 20px;">
                                        <div class="form-group">
                                            <label for="payment_method">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                                            <select id="payment_method"><option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option><option value="COD">COD</option></select>
                                        </div>
                                        <div class="form-group"><label for="promotion">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</label><select id="promotion" style="width: 100%;"></select></div>
                                        <div class="form-group"><label for="payment_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label><input type="date" id="payment_date"></div>
                                        <div class="form-group"><label for="payment_time">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label><input type="time" id="payment_time"></div>
                                    </div>
                                    
                                    <div style="margin-top: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                        <button type="button" id="upload-slip-btn" class="btn btn-info">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</button>
                                        <span id="slip-status" style="font-weight: bold; font-size: 16px;"></span>
                                        <div class="billing-checkbox-group" style="margin-left: auto;">
                                            <label><input type="checkbox" id="request-tax-invoice-cb"> ‡∏Ç‡∏≠‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</label>
                                            <label><input type="checkbox" id="request-cash-bill-cb"> ‡∏Ç‡∏≠‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
                                        </div>
                                    </div>
                                </div>

                                <div id="tax-invoice-details-section">
                                    <hr>
                                    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h4>
                                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                        <div class="form-group full-width"><label for="tax-customer-name">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label><input type="text" id="tax-customer-name"></div>
                                        <div class="form-group full-width"><label for="tax-customer-address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><textarea id="tax-customer-address" rows="3"></textarea></div>
                                        <div class="form-group"><label for="tax-id">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (TAX ID)</label><input type="text" id="tax-id"></div>
                                    </div>
                                    <h5>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</h5>
                                    <div class="items-table-container">
                                        <table id="tax-items-table">
                                            <thead>
                                                <tr>
                                                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                                    <th style="width: 100px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                                    <th style="width: 150px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞</th>
                                                    <th style="width: 150px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tax-items-tbody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="form-actions" style="margin-top: 25px; text-align: right;"></div>
                            </form>
                        </div>
                        <div id="tab-waiting" class="tab-content"><div class="tab-filter"><label for="filter-waiting">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-waiting"></select><input type="text" id="search-waiting" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏û‡∏±‡∏™‡∏î‡∏∏..."></div><div class="batch-actions"><button id="select-all-waiting-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button><button id="move-to-complete-from-waiting-btn" class="btn btn-success">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button><button id="cancel-selected-waiting-btn" class="btn btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button></div><ul class="order-list"></ul></div>
                        <div id="tab-complete" class="tab-content">
                            <div class="tab-filter">
                                <label for="filter-complete">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label>
                                <select id="filter-complete"></select>
                                <input type="text" id="search-complete" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏û‡∏±‡∏™‡∏î‡∏∏...">
                            </div>
                            <div id="channel-summary-container" class="channel-summary"></div>
                            <div class="batch-actions">
                                <div class="quantity-input-group">
                                    <input type="number" id="create-wo-by-quantity-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)" min="1" style="width: 180px;">
                                    <button id="create-wo-smart-btn" class="btn btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á)</button>
                                </div>
                                <hr style="flex-basis: 100%; border: none; margin: 5px 0;">
                                <button id="move-to-waiting-btn" class="btn btn-warning">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</button>
                                <button id="cancel-selected-complete-btn" class="btn btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏• (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</button>
                            </div>
                            <ul class="order-list"></ul>
                        </div>
                        <div id="tab-work-orders" class="tab-content">
                            <div class="tab-filter">
                                <label for="filter-work-orders">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label>
                                <select id="filter-work-orders"></select>
                                <input type="text" id="search-work-orders" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏á‡∏≤‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
                            </div>
                            <div id="work-orders-list-container"></div>
                        </div>
                        <div id="tab-shipped" class="tab-content">
                            <div class="tab-filter"><label for="filter-shipped">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-shipped"></select><input type="text" id="search-shipped" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏û‡∏±‡∏™‡∏î‡∏∏..."></div>
                            <div class="batch-actions">
                                <button id="select-all-shipped-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button id="claim-selected-shipped-btn" class="btn btn-info">‡πÄ‡∏Ñ‡∏•‡∏°‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                <button id="export-shipped-btn" class="btn btn-success">Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
	             <button id="export-tracking-csv-btn" class="btn" style="background-color: #6610f2; color: white;">Export CSV ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
                            </div>
                            <ul class="order-list"></ul>
                        </div>
                        <div id="tab-cancelled" class="tab-content"><div class="tab-filter"><label for="filter-cancelled">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-cancelled"></select><input type="text" id="search-cancelled" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏û‡∏±‡∏™‡∏î‡∏∏..."></div><div class="batch-actions"><button id="select-all-cancelled-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button><button id="restore-to-waiting-btn" class="btn btn-warning">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</button><button id="restore-to-complete-btn" class="btn btn-info">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button></div><ul class="order-list"></ul></div>
                    </div>
                </div>
<!-- ==================== PACKING SYSTEM ==================== -->
                <div id="packing-system-container" class="system-content">
                    <div id="work-order-selection-view">
                        <div class="container">
                            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</h2><p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï" ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p><ul id="work-order-list"></ul>
                        </div>
                    </div>
                    <div id="packing-main-view">
                        <header class="header">
                            <h1 id="packing-header-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</h1>
                            <div class="action-buttons">
                                <button id="back-to-wo-selection" class="btn btn-back">‚ùÆ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>
	             <button id="ship-all-scanned-btn" class="btn btn-info" style="display: none; background-color: #28a745;">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
                                <button id="reset-packing-btn" class="btn btn-warning">‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏°‡πà</button>
                                <button id="finalize-wo-btn" class="btn btn-success" style="display: none;">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"</button>
                            </div>
                        </header>
                        <div class="main-container">
                            <nav id="order-nav-panel">
                                <div id="nav-header">
                                    <span id="order-counter">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏...">
                                </div>
                                <ul id="order-list"></ul>
                            </nav>
                            <main id="content-panel">
                                <div id="action-panel" style="display: none;">
                                    <div class="action-panel-grid">
                                        <div class="action-step">
                                            <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</h3>
                                            <input type="text" id="parcel-scan-input" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á" disabled>
                                        </div>
                                        <div class="action-step">
                                            <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                            <input type="text" id="item-scan-input" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î Item UID" disabled>
                                        </div>
                                    </div>
                                    <p id="status-message"></p>
                                </div>
                                <div id="result-container"></div>
                            </main>
                        </div>
                    </div>
                    <audio id="success-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
                    <audio id="error-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
                </div>

                <!-- ==================== PRODUCT SYSTEM ==================== -->
                <div id="product-system-container" class="system-content">
                    <div class="container">
                        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Products)</h1>
                        <input type="file" id="import-product-input" style="display: none;" accept=".xlsx, .xls, .csv">
                        <div class="toolbar">
                            <div>
                                <button id="add-product-btn" class="btn btn-success">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                                <button id="import-product-btn" class="btn btn-info">üì• Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                                <button id="download-product-template-btn" class="btn btn-secondary">üìã Download Template</button>
	             <button id="bulk-upload-images-btn" class="btn" style="background-color: #6610f2; color: white;">üñºÔ∏è Import ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</button>
	             <input type="file" id="bulk-image-input" style="display: none;" accept="image/*" multiple>
                            </div>
                            <input type="text" id="search-product-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
                        </div>
                        <div class="table-container">
                            <table id="products-table">
                                <thead>
    	<tr>
        	<th>‡∏£‡∏π‡∏õ</th>
        	<th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        	<th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        	<th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
        	<th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        	<th>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤‡∏á</th>
        	<th>‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</th>
        	<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    	</tr>
	</thead>
                                <tbody id="products-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
<div id="pattern-system-container" class="system-content">
    <div class="container">
       <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</h1>
        <div class="toolbar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button id="add-pattern-btn" class="btn btn-success">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                <button id="bulk-upload-patterns-btn" class="btn" style="background-color: #6610f2; color: white;">üñºÔ∏è Import ‡∏•‡∏≤‡∏¢ (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</button>
                <input type="file" id="bulk-pattern-input" style="display: none;" accept="image/*" multiple>
            </div>
            <input type="text" id="search-pattern-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏¢..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
        </div>
        <table id="patterns-table" style="width:100%; border-collapse: collapse; margin-top:20px;">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th style="padding:12px; border:1px solid #ddd; width:100px; text-align:center;">‡∏£‡∏π‡∏õ</th>
                    <th style="padding:12px; border:1px solid #ddd; text-align:left;">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏¢</th>
                    <th style="padding:12px; border:1px solid #ddd; width:160px; text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="patterns-tbody"></tbody>
        </table>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢ -->
<div id="pattern-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h2 id="pattern-modal-title-text">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</h2> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° id ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
        <form id="pattern-form">
            <div class="modal-form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏¢</label><input type="text" id="pattern-name-input" required style="width:100%;"></div>
            <div class="modal-form-group"><label>‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ</label><input type="file" id="pattern-image-input" accept="image/*"></div>
            <div class="modal-actions">
                <button type="button" id="cancel-pattern-modal-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </form>
    </div>
</div>

                <!-- ==================== PLANNER SYSTEM ==================== -->
                <div id="planner-system-container" class="system-content">
                    <header>
                        <div class="bar">
                          <div style="display:flex;align-items:center;gap:10px">
                            <h1>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Export)</h1>
                          </div>
                        </div>
                    </header>
                    <div class="wrap">
                        <section class="card hidden" id="viewForm"></section>
                        <section class="card" id="viewJobs">
                          <h2>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)</h2>
                          <div class="inner">
                            <div class="toolbar">
                              <div><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label><select id="j_date"></select></div>
                              <div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="j_search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠" style="width:260px;"></div>
                              <button class="btn gray" id="j_clear">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                              <div class="right" style="display: flex; gap: 8px;">
                                <button class="btn btn-success" id="btnExportForSorting">Export for Sorting System (.xlsx)</button>
                                <button class="btn danger hidden" id="j_deleteSelected">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (0)</button>
                              </div>
                            </div>
                            <div class="tablewrap" style="overflow-x:auto;max-height:520px;border:1px solid var(--border);border-radius:12px">
                              <table id="tableJobs"><thead><tr>
                                <th class="checkbox-cell"><input type="checkbox" id="j_selectAll"></th>
                                <th style="min-width:160px">‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡∏î</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                <th style="min-width:160px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                              </tr></thead><tbody></tbody></table>
                            </div>
                          </div>
                        </section>
                    </div>
                </div>

                <!-- ==================== SALES REPORT SYSTEM ==================== -->
                <div id="sales-report-system-container" class="system-content">
                    <div class="container">
                        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                        <div class="report-controls">
                            <div class="control-group">
                                <label for="report-start-date">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="report-start-date">
                            </div>
                            <div class="control-group">
                                <label for="report-end-date">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="report-end-date">
                            </div>
                            <!-- === ADDED FILTERS START === -->
                            <div class="control-group">
                                <label for="report-category-filter">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                <select id="report-category-filter" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; min-width: 200px;">
                                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="report-product-search">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                <input type="text" id="report-product-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; width: 250px;">
                            </div>
                             <!-- === ADDED FILTERS END === -->
                            <button id="generate-report-btn" class="btn btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            <button id="export-report-btn" class="btn btn-success" style="display: none; margin-left: auto;">Export to Excel</button>
                        </div>
                        <div class="report-results-container">
                            <table id="report-table">
                                <thead>
                                    <tr>
                                        <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                                    </tr>
                                </thead>
                                <tbody id="report-tbody">
                                </tbody>
                            </table>
                            <div id="report-placeholder">
                                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & GLOBAL STATE ---
        const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let loggedInUsername = null;
        let loggedInUserRole = null;

        // --- CORE UI ELEMENTS ---
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const systemContents = document.querySelectorAll('.system-content');
        const loginOverlay = document.getElementById('login-overlay');
        const mainAppContainer = document.getElementById('main-app-container');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');

        // --- CORE APP LOGIC ---
        mobileMenuToggle.addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));

    navLinks.forEach(link => {
    if (link.getAttribute('href') === '#' || link.hasAttribute('data-target')) {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πà‡∏≤‡∏á‡πÜ
            if (targetId === 'product-system-container' && !(loggedInUserRole === 'superadmin' || loggedInUserRole === 'manager')) return;
            if (targetId === 'pattern-system-container' && !(loggedInUserRole === 'superadmin' || loggedInUserRole === 'manager')) return;
            if (targetId === 'planner-system-container' && !(loggedInUserRole === 'superadmin' || loggedInUserRole === 'production' || loggedInUserRole === 'manager')) return;
            if (targetId === 'sales-report-system-container' && !(loggedInUserRole === 'superadmin' || loggedInUserRole === 'manager')) return;

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            systemContents.forEach(content => content.classList.toggle('active', content.id === targetId));

            if (targetId === 'packing-system-container') { window.packingSystem.loadWorkOrdersForPacking(); }
            
            if (window.innerWidth <= 768) { document.body.classList.add('sidebar-collapsed'); }
        });
    }
});
        
        function handleInitialTab() {
            const target = localStorage.getItem('navigateTo');
            if (target) {
                const targetLink = document.querySelector(`.nav-link[data-target*="${target}"]`);
                if (targetLink) {
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.system-content.active')?.classList.remove('active');
                    targetLink.classList.add('active');
                    const targetContent = document.getElementById(targetLink.dataset.target);
                    if (targetContent) { targetContent.classList.add('active'); }
                    if (target === 'packing') { window.packingSystem.loadWorkOrdersForPacking(); }
                    else if (target === 'product' && loggedInUserRole === 'superadmin') { window.productSystem.initializeApp(); }
                    else if (target === 'planner' && (loggedInUserRole === 'superadmin' || loggedInUserRole === 'production')) { window.plannerSystem.initializeApp(loggedInUserRole); }
                    else if (target === 'sales-report' && loggedInUserRole === 'superadmin') { window.salesReportSystem.initializeApp(); }
                }
            }
            localStorage.removeItem('navigateTo');
        }

        async function mainAppInitializer(user) {
            loadingOverlay.style.display = 'flex';
            try {
                const { data: userData, error } = await supabaseClient.from('users').select('username, role').eq('id', user.id).single();
                if (error || !userData) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                loggedInUsername = userData.username; 
                loggedInUserRole = userData.role;
                
                welcomeMessage.textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${loggedInUsername} (${loggedInUserRole})`;

                const isSuperAdmin = loggedInUserRole === 'superadmin'; 
                const isProduction = loggedInUserRole === 'production';
                const isManager = loggedInUserRole === 'manager';

                // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π
                document.getElementById('nav-product').style.display = (isSuperAdmin || isManager) ? '' : 'none';
                document.getElementById('nav-pattern').style.display = (isSuperAdmin || isManager) ? '' : 'none';
                document.getElementById('nav-planner').style.display = (isSuperAdmin || isProduction || isManager) ? '' : 'none';
                document.getElementById('nav-sales-report').style.display = (isSuperAdmin || isManager) ? '' : 'none';
                document.getElementById('nav-accounting').style.display = isSuperAdmin ? '' : 'none';

                loginOverlay.style.display = 'none'; 
                mainAppContainer.style.display = 'flex';

                await window.orderSystem.initializeApp(loggedInUsername, loggedInUserRole);

                if (isSuperAdmin || isManager) { 
                    window.productSystem.initializeApp();
                    window.patternSystem.initializeApp(); 
                    window.plannerSystem.initializeApp(loggedInUserRole);
                    window.salesReportSystem.initializeApp();
                } else if (isProduction) {
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.system-content.active')?.classList.remove('active');
                    document.querySelector('.nav-link[data-target="planner-system-container"]').classList.add('active');
                    document.getElementById('planner-system-container').classList.add('active');
                    window.plannerSystem.initializeApp(loggedInUserRole);
                }
                handleInitialTab();
            } catch (err) { 
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); 
                await logout(); 
            } finally { 
                loadingOverlay.style.display = 'none'; 
            }
        }
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); errorMessage.textContent = ''; loadingOverlay.style.display = 'flex';
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            loadingOverlay.style.display = 'none';
            if (error) { errorMessage.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; } 
            else if (data.user) { await mainAppInitializer(data.user); }
        });

        async function logout() { await supabaseClient.auth.signOut(); loggedInUsername = null; loggedInUserRole = null; mainAppContainer.style.display = 'none'; loginOverlay.style.display = 'flex'; document.getElementById('email').value = ''; document.getElementById('password').value = ''; errorMessage.textContent = ''; }
        logoutBtn.addEventListener('click', logout);

        async function checkAuth() { const { data: { session } } = await supabaseClient.auth.getSession(); if (session) { await mainAppInitializer(session.user); } else { loginOverlay.style.display = 'flex'; mainAppContainer.style.display = 'none'; } }
        
        // --- SLIP PROCESSING MODULE ---
        const slipProcessor = (() => {
            const slipStatusEl = document.getElementById('slip-status'); const totalAmountEl = document.getElementById('total_amount'); const paymentDateEl = document.getElementById('payment_date'); const paymentTimeEl = document.getElementById('payment_time'); const paymentMethodEl = document.getElementById('payment_method');
            const monthMap = { '01': ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏Ñ', '‡∏°.‡∏Ñ.', 'january', 'jan'], '02': ['‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏Å‡∏û', '‡∏Å.‡∏û.', 'february', 'feb'], '03': ['‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏µ‡∏Ñ', '‡∏°‡∏µ.‡∏Ñ.', 'march', 'mar'], '04': ['‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡πÄ‡∏°‡∏¢', '‡πÄ‡∏°.‡∏¢.', 'april', 'apr'], '05': ['‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏Ñ', '‡∏û.‡∏Ñ.', 'may'], '06': ['‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏°‡∏¥‡∏¢', '‡∏°‡∏¥.‡∏¢.', 'june', 'jun'], '07': ['‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏Ñ', '‡∏Å.‡∏Ñ.', 'july', 'jul'], '08': ['‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏Ñ', '‡∏™.‡∏Ñ.', 'august', 'aug'], '09': ['‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏¢', '‡∏Å.‡∏¢.', 'september', 'sep', 'sept'], '10': ['‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏ï‡∏Ñ', '‡∏ï.‡∏Ñ.', 'october', 'oct', '0.a.', '0a'], '11': ['‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏û‡∏¢', '‡∏û.‡∏¢.', 'november', 'nov'], '12': ['‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°', '‡∏ò‡∏Ñ', '‡∏ò.‡∏Ñ.', 'december', 'dec'] };
            function normalizeDate(rawDateStr) { if (!rawDateStr) return null; const dateParts = rawDateStr.match(/(\d{1,2})\s+(\S+)\s+(\d{2,4})/); if (!dateParts) return null; let day = dateParts[1]; const monthStr = dateParts[2].toLowerCase().replace(/[.,]/g, ''); let year = dateParts[3]; let month = null; for (const monthNum in monthMap) { if (monthMap[monthNum].includes(monthStr)) { month = monthNum; break; } } if (!month) return null; if (year.length === 2) year = `25${year}`; if (day.length === 1) day = `0${day}`; return `${day}/${month}/${year}`; }
            function buddhistToISO(buddhistDate) { if (!buddhistDate) return null; const parts = buddhistDate.split('/'); if (parts.length !== 3) return null; const day = parts[0]; const month = parts[1]; const buddhistYear = parseInt(parts[2], 10); if (isNaN(buddhistYear)) return null; const gregorianYear = buddhistYear - 543; return `${gregorianYear}-${month}-${day}`; }
            function extractSlipInfo(text) { const info = { amount: null, date: null, time: null }; let amountMatch = text.match(/(?:‡∏à‡πç‡∏≤‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô|Amount|‡∏à‡πç‡∏≤‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô|‡∏à‡πç‡∏≤‡∏ô‡∏ß‡∏ô)\s*([\d,]+\.\d{2})/); if (amountMatch && amountMatch[1]) { info.amount = amountMatch[1]; } else { amountMatch = text.match(/([\d,]+\.\d{2})\s*‡∏ö‡∏≤‡∏ó/); if (amountMatch && amountMatch[1]) { info.amount = amountMatch[1]; } else { amountMatch = text.match(/^\|?\s*([1-9][\d,]*\.\d{2})\s*$/m); if (amountMatch && amountMatch[1]) { info.amount = amountMatch[1]; } } } const dateTimeRegex = /(\d{1,2}\s+\S+\s+\d{2,4})\s*[,]?\s*(\d{2}:\d{2}(?::\d{2})?)/; const dateTimeMatch = text.match(dateTimeRegex); if (dateTimeMatch) { info.date = normalizeDate(dateTimeMatch[1]); info.time = dateTimeMatch[2].trim().substring(0, 5); } return info; }
            async function process(file) { if (!file) return; loadingOverlay.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏•‡∏¥‡∏õ...'; loadingOverlay.style.display = 'flex'; slipStatusEl.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; slipStatusEl.style.color = '#0056b3'; try { const worker = await Tesseract.createWorker('tha+eng', 1, { logger: m => { if (m.status === 'recognizing text') { loadingOverlay.textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏•‡∏¥‡∏õ... ${Math.round(m.progress * 100)}%`; } }, }); const { data: { text } } = await worker.recognize(file); await worker.terminate(); const slipData = extractSlipInfo(text); if (slipData.date || slipData.time || slipData.amount) { paymentMethodEl.value = '‡πÇ‡∏≠‡∏ô'; } if (slipData.date) { paymentDateEl.value = buddhistToISO(slipData.date); } if (slipData.time) { paymentTimeEl.value = slipData.time; } if (slipData.amount) { const slipAmount = parseFloat(slipData.amount.replace(/,/g, '')); const totalAmount = parseFloat(totalAmountEl.value); if (Math.abs(slipAmount - totalAmount) < 0.01) { slipStatusEl.textContent = `‚úÖ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (${slipAmount.toFixed(2)} ‡∏ö‡∏≤‡∏ó)`; slipStatusEl.style.color = '#28a745'; } else { slipStatusEl.textContent = `‚ùå ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á! (‡∏™‡∏•‡∏¥‡∏õ: ${slipAmount.toFixed(2)}, ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${totalAmount.toFixed(2)})`; slipStatusEl.style.color = '#dc3545'; } } else { slipStatusEl.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)'; slipStatusEl.style.color = '#ffc107'; } } catch (error) { console.error("Slip error:", error); slipStatusEl.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; slipStatusEl.style.color = '#dc3545'; } finally { loadingOverlay.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'; loadingOverlay.style.display = 'none'; document.getElementById('slip-file-input').value = ''; } }
            return { process };
        })();
 // --- WAYBILL SORTER MODULE ---
        window.waybillSorter = (() => {
            if (window.pdfjsLib) { pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js`; }
            const modal = document.getElementById('waybill-sorter-modal'); const woNameEl = document.getElementById('waybill-sorter-wo-name'); const selectFolderBtn = document.getElementById('select-pdf-folder-btn'); const folderInput = document.getElementById('pdf-folder-input'); const statCsv = document.getElementById('ws-stat-csv'); const statPdf = document.getElementById('ws-stat-pdf'); const statFound = document.getElementById('ws-stat-found'); const progressBar = document.getElementById('ws-progress-bar'); const statusLog = document.getElementById('ws-status-log'); const downloadMissingBtn = document.getElementById('ws-download-missing-btn'); const closeBtn = document.getElementById('ws-close-btn'); const cropTopInput = document.getElementById('ws-crop-top'); const batchSizeInput = document.getElementById('ws-batch-size');
            let trackingNumbersRaw = [];

            function log(message, overwrite = false) { if(overwrite){ const lines = statusLog.textContent.split('\n'); lines[0] = message; statusLog.textContent = lines.join('\n'); } else { statusLog.textContent = message + '\n' + statusLog.textContent; } }
            function updateProgress(current, total) { progressBar.style.width = (total > 0 ? (current / total) * 100 : 0) + '%'; }
            function resetUI() { statCsv.textContent = '--'; statPdf.textContent = '--'; statFound.textContent = '--'; progressBar.style.width = '0%'; statusLog.textContent = ''; downloadMissingBtn.disabled = true; downloadMissingBtn.onclick = null; folderInput.value = ''; }
            function normText(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }
            function normOCR(s){ return normText(s).replace(/O/g,'0').replace(/I/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8'); }
            function downloadCSV(filename, rows){ const csv='‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö\n'+rows.join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
            const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

            async function pageTextNormalized(page){ const tc = await page.getTextContent(); let text=''; tc.items.forEach(it=>text+=it.str+' '); return normText(text); }
            async function renderPageToCanvas(page, scale=2){ const viewport=page.getViewport({scale}); const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); canvas.width=viewport.width; canvas.height=viewport.height; await page.render({canvasContext:ctx, viewport}).promise; return canvas; }
            function cropTop(canvas, percent){ const p=Math.max(5,Math.min(60,percent)); const h=canvas.height,w=canvas.width, ch=Math.round(h*(p/100)); const c2=document.createElement('canvas'); c2.width=w; c2.height=ch; c2.getContext('2d').drawImage(canvas,0,0,w,ch,0,0,w,ch); return c2; }
            async function ocrCanvasToNorm(canvas, worker){ const { data: { text } } = await worker.recognize(canvas); return normOCR(text||''); }

            async function mapTrackingInFile(file, targetsTextSet, targetsOCRSet, ocr2textMap, worker, cropTopPct){
                const buf=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:buf}).promise; const results=[];
                for(let i=1;i<=pdf.numPages;i++){
                    const page=await pdf.getPage(i);
                    log(`>> ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏à‡∏≤‡∏Å Text...`, true);
                    const textNorm = await pageTextNormalized(page);
                    let keyText=null;
                    for(const t of targetsTextSet){ if(textNorm.includes(t)){ keyText=t; break; } }
                    if(keyText){ log(`‚úÖ ‡∏û‡∏ö‡∏à‡∏≤‡∏Å Text!`, true); }
                    if(!keyText){
                        log(`>> ‡πÑ‡∏°‡πà‡∏û‡∏ö, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô OCR ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô...`, true);
                        const fullCanvas=await renderPageToCanvas(page,2); const topCanvas=cropTop(fullCanvas, cropTopPct);
                        const topNorm=await ocrCanvasToNorm(topCanvas, worker);
                        for(const k of targetsOCRSet){ if(topNorm.includes(k)){ keyText=ocr2textMap.get(k); break; } }
                        if(keyText){ log(`‚úÖ ‡∏û‡∏ö‡∏à‡∏≤‡∏Å OCR ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô!`, true); }
                        if(!keyText){
                            log(`>> ‡πÑ‡∏°‡πà‡∏û‡∏ö, ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤...`, true);
                            const fullNorm=await ocrCanvasToNorm(fullCanvas, worker);
                            for(const k of targetsOCRSet){ if(fullNorm.includes(k)){ keyText=ocr2textMap.get(k); break; } }
                            if(keyText){ log(`‚úÖ ‡∏û‡∏ö‡∏à‡∏≤‡∏Å OCR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤!`, true); }
                        }
                    }
                    if(keyText){ results.push({ trackingKeyText:keyText, pageIndex:i-1 }); }
                }
                return { fileArrayBuffer: buf, pages: results };
            }

            async function processFiles(pdfFilesArray) {
                if (!pdfFilesArray || pdfFilesArray.length === 0) { log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF'); return; }
                const pdfFiles = Array.from(pdfFilesArray); statPdf.textContent = pdfFiles.length;
                let worker = null;
                try {
                    const cropTopPct = parseInt(cropTopInput.value, 10) || 25; const batchSize = parseInt(batchSizeInput.value, 10) || 25;
                    log('‚è≥ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏...');
                    const targetsText = trackingNumbersRaw.map(normText); const targetsOCR  = trackingNumbersRaw.map(normOCR); const targetsTextSet=new Set(targetsText); const targetsOCRSet =new Set(targetsOCR); const ocr2textMap=new Map(); for(let i=0;i<trackingNumbersRaw.length;i++){ ocr2textMap.set(targetsOCR[i], targetsText[i]); }
                    log('‚è≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö OCR...');
                    worker = await Tesseract.createWorker('eng', 1, { logger: m => { if (m.status === 'recognizing text') { const progress = (m.progress * 100).toFixed(0); log(`(OCR ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô... ${progress}%)`, true); } } });
                    await worker.setParameters({ tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' });
                    log(`‚è≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô ${pdfFiles.length} ‡πÑ‡∏ü‡∏•‡πå PDF...`);
                    const mapping=new Map(); const fileBuffers=new Array(pdfFiles.length); let processed=0; updateProgress(0,pdfFiles.length);
                    for(let idx=0; idx<pdfFiles.length; idx++){
                        const file=pdfFiles[idx]; log(`üîé ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${file.name} (${processed+1}/${pdfFiles.length})`);
                        const { fileArrayBuffer, pages } = await mapTrackingInFile(file, targetsTextSet, targetsOCRSet, ocr2textMap, worker, cropTopPct);
                        fileBuffers[idx]=fileArrayBuffer;
                        for(const p of pages){ if(!mapping.has(p.trackingKeyText)){ mapping.set(p.trackingKeyText, { fileIndex: idx, pageIndex: p.pageIndex }); statFound.textContent = `${mapping.size}`; } }
                        processed++; updateProgress(processed,pdfFiles.length);
                        await sleep(0);
                    }
                    log('‚è≥ ‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö...');
                    const merged = await PDFLib.PDFDocument.create(); const docCache=new Map(); const missing=[];
                    for(let i=0;i<trackingNumbersRaw.length;i++){
                        const keyText = targetsText[i]; const original = trackingNumbersRaw[i];
                        if(mapping.has(keyText)){ const { fileIndex, pageIndex } = mapping.get(keyText); let srcDoc = docCache.get(fileIndex); if(!srcDoc){ srcDoc = await PDFLib.PDFDocument.load(fileBuffers[fileIndex]); docCache.set(fileIndex, srcDoc); } const [copied] = await merged.copyPages(srcDoc, [pageIndex]); merged.addPage(copied); } 
                        else { missing.push(original); }
                        if((i+1)%batchSize===0){ log(`üß© ‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤... ${i+1}/${trackingNumbersRaw.length}`); await sleep(0); }
                    }
                    if(missing.length > 0){ log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö ${missing.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`); downloadMissingBtn.disabled=false; downloadMissingBtn.onclick=()=>downloadCSV('missing_tracking.csv', missing); } 
                    else { log(`‚úÖ ‡∏û‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡∏Ç`); }
                    log('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF...'); await sleep(0);
                    const outBytes = await merged.save(); const blob = new Blob([outBytes], {type:'application/pdf'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`sorted_waybills_${woNameEl.textContent.split(': ')[1]}.pdf`; a.click();
                    log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß`);
                } catch (err) { console.error(err); log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err?.message || err));
                } finally { if (worker) { await worker.terminate(); log('‚ìò ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö OCR ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } folderInput.value = ''; }
            }
            function start(workOrderName, allOrders) {
                const ordersInWorkOrder = allOrders.filter(order => order.work_order_name === workOrderName && order.tracking_number);
                trackingNumbersRaw = ordersInWorkOrder.map(order => order.tracking_number);
                if (trackingNumbersRaw.length === 0) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ"); return; }
                resetUI();
                woNameEl.textContent = `‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${workOrderName}`;
                statCsv.textContent = trackingNumbersRaw.length;
                log('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå PDF');
                modal.style.display = 'flex';
            }
            selectFolderBtn.addEventListener('click', () => folderInput.click());
            folderInput.addEventListener('change', (e) => processFiles(e.target.files));
            closeBtn.addEventListener('click', () => { modal.style.display = 'none'; folderInput.value = ''; });
            modal.addEventListener('click', (e) => { if(e.target === modal) { modal.style.display = 'none'; folderInput.value = ''; }});
            return { start };
        })();
        // --- ORDER SYSTEM MODULE ---
         window.orderSystem = (() => {
            const container = document.getElementById('order-system-container');
            const adminUserInput = container.querySelector('#admin_user');
            const itemsTbody = container.querySelector('#items-tbody');
            const formActions = container.querySelector('#form-actions');
            const orderForm = container.querySelector('#order-form');
            const tabLinks = container.querySelectorAll('.tab-link');
            const addItemBtn = container.querySelector('#add-item-btn');
            const trackingFileInput = document.getElementById('tracking-file-input');
            const workOrdersListContainer = document.getElementById('work-orders-list-container');
            const importOrdersBtn = document.getElementById('import-orders-btn');
            const importOrdersFileInput = document.getElementById('import-orders-file-input');
            
            const requestTaxInvoiceCb = document.getElementById('request-tax-invoice-cb');
            const requestCashBillCb = document.getElementById('request-cash-bill-cb');
            const taxInvoiceSection = document.getElementById('tax-invoice-details-section');
            const taxItemsTbody = document.getElementById('tax-items-tbody');
            const taxCustomerNameInput = document.getElementById('tax-customer-name');
            const taxCustomerAddressInput = document.getElementById('tax-customer-address');
            const vatDisplayContainer = document.getElementById('vat-display-container');
            const vatAmountInput = document.getElementById('vat_amount');
            let searchDebounceTimer; 
            let eventListenersInitialized = false; 
            let productList = [], cartoonPatternList = [], fullProductList = [], channelList = [], allOrdersData = [], allWorkOrdersData = [], inkTypeList = [], promotionList = [], currentEditingOrderId = null;
            let currentUserRole = null;

            const standardFonts = ['F01','F03','F04','F12','F14','TH01','TH02','TH03'];
            const wyFonts = ['fontA', 'fontB', 'fontC', 'fontD', 'fontE', 'fontF', 'fontG', 'fontH'];
            const ecommerceChannels = ['SPTR', 'FSPTR', 'LZTR', 'TTTR', 'SHOP'];

            async function performDatabaseSearch(searchTerm) {
                try {
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('*, order_items(*)')
                        .or(`bill_no.ilike.%${searchTerm}%,customer_name.ilike.%${searchTerm}%,tracking_number.ilike.%${searchTerm}%`)
                        .order('created_at', { ascending: false })
                        .limit(100);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        allOrdersData = data;
                        renderAllTabs();
                    }
                } catch (err) {
                    console.error('Search Error:', err);
                }
            }

            async function initializeApp(username, role) {
                adminUserInput.value = username;
                currentUserRole = role;
                $('#promotion').select2({ tags: true, placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà', tokenSeparators: [','] });
                await loadInitialData(); 
                setFormMode('create'); 
                initializeEventListeners();
                setupRealtimeSubscriptions();
                document.getElementById('upload-slip-btn').addEventListener('click', () => document.getElementById('slip-file-input').click());
                document.getElementById('slip-file-input').addEventListener('change', (e) => slipProcessor.process(e.target.files[0]));
            }

            function setupRealtimeSubscriptions() {
                const handleRealtimeUpdate = async (payload) => {
                    console.log('Realtime change received:', payload);
                    const { eventType, new: newRecord, old: oldRecord, table } = payload;
                    let needsReRender = false;

                    if (table === 'orders') {
                        needsReRender = true;
                        switch (eventType) {
                            case 'INSERT':
                                allOrdersData.push(newRecord);
                                break;
                            case 'UPDATE':
                                const indexToUpdate = allOrdersData.findIndex(order => order.id === newRecord.id);
                                if (indexToUpdate > -1) {
                                    const existingItems = allOrdersData[indexToUpdate].order_items;
                                    allOrdersData[indexToUpdate] = { ...newRecord, order_items: newRecord.order_items || existingItems };
                                }
                                break;
                            case 'DELETE':
                                allOrdersData = allOrdersData.filter(order => order.id !== oldRecord.id);
                                break;
                        }
                    } else if (table === 'order_items') {
                        const orderId = newRecord?.order_id || oldRecord?.order_id;
                        if(orderId) {
                            const { data: updatedOrder, error } = await supabaseClient
                                .from('orders')
                                .select('*, order_items(*)')
                                .eq('id', orderId)
                                .single();

                            if (updatedOrder) {
                                const indexToUpdate = allOrdersData.findIndex(order => order.id === updatedOrder.id);
                                if (indexToUpdate > -1) {
                                    allOrdersData[indexToUpdate] = updatedOrder;
                                    needsReRender = true;
                                }
                            }
                        }
                    }
                    if (needsReRender) { renderAllTabs(); }
                };

                const channel = supabaseClient.channel('public:orders_and_items');
                channel.on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, handleRealtimeUpdate)
                       .on('postgres_changes', { event: '*', schema: 'public', table: 'order_items' }, handleRealtimeUpdate)
                       .on('postgres_changes', { event: '*', schema: 'public', table: 'work_orders' }, () => loadInitialData(true)) 
                       .subscribe();
            }

            async function loadInitialData(isSilent = false) {
                if (window.isLoadingData) return;
                window.isLoadingData = true;

                if (!isSilent) { loadingOverlay.style.display = 'flex'; }
                
                try {
                   const [productsRes, channelsRes, workOrdersRes, inkTypesRes, promotionsRes, patternsRes] = await Promise.all([
    supabaseClient.from('products').select('*'),
    supabaseClient.from('channels').select('channel_code, channel_name'),
    supabaseClient.from('work_orders').select('*').eq('status', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï').order('created_at', { ascending: false }),
    supabaseClient.from('ink_types').select('ink_name').order('id'),
    supabaseClient.from('orders').select('promotion').neq('promotion', '').not('promotion', 'is', null),
    supabaseClient.from('cartoon_patterns').select('*') // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô array
]);

if (patternsRes.error) throw patternsRes.error;
cartoonPatternList = patternsRes.data || [];
                    const activeOrdersPromise = supabaseClient.from('orders')
                        .select('*, order_items(*)')
                        .in('status', ['‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)'])
                        .order('created_at', { ascending: false });

                    const finishedOrdersPromise = supabaseClient.from('orders')
                        .select('*, order_items(*)')
                        .in('status', ['‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'])
                        .order('created_at', { ascending: false })
                        .limit(500);

                    const [{ data: activeOrders, error: activeError }, { data: finishedOrders, error: finishedError }] = await Promise.all([
                        activeOrdersPromise,
                        finishedOrdersPromise
                    ]);

                    if (activeError || finishedError) {
                        const err = activeError || finishedError;
						alert("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message + "\nHint: " + err.hint);
						console.error("Detail Error:", err);
                    }

                    allOrdersData = [...(activeOrders || []), ...(finishedOrders || [])];

                    if (productsRes.error) throw new Error('Could not load products');
                    fullProductList = productsRes.data;
                    productList = productsRes.data.filter(p => p.is_active !== false).map(p => ({ id: p.id, text: p.product_name }));
                    
                    if (channelsRes.error) throw new Error('Could not load channels');
                    channelList = channelsRes.data; 
                    if (!channelList.some(ch => ch.channel_code === 'CLAIM')) { channelList.push({ channel_code: 'CLAIM', channel_name: 'CLAIM' }); }
	 if (!channelList.some(ch => ch.channel_code === 'INFU')) { channelList.push({ channel_code: 'INFU', channel_name: 'INFU' }); }
                    channelList.sort((a, b) => a.channel_code.localeCompare(b.channel_code));
                    
                    if (inkTypesRes.error) throw new Error('Could not load ink types');
                    inkTypeList = inkTypesRes.data;

                    const isEditingOrder = isSilent && container.querySelector('#tab-create')?.classList.contains('active');
                    if (!isEditingOrder) {
                        const uniquePromotions = [...new Set(promotionsRes.data.map(p => p.promotion))];
                        const promotionSelect = $('#promotion'); 
                        const currentValue = promotionSelect.val();
                        promotionSelect.empty();
                        uniquePromotions.forEach(promo => { const option = new Option(promo, promo, false, false); promotionSelect.append(option); });
                        promotionSelect.val(currentValue).trigger('change');
                        populateChannelDropdowns();
                    }
                    
                    if (workOrdersRes.error) throw workOrdersRes.error;
                    allWorkOrdersData = workOrdersRes.data;
                    
                    renderAllTabs();
                } catch(err) { 
                    console.error(err); 
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message); 
                } finally { 
                    if (!isSilent) { loadingOverlay.style.display = 'none'; }
                    setTimeout(() => { window.isLoadingData = false; }, 500); 
                }
            }
            
            function renderAllTabs() {
                const globalSearchTerm = (container.querySelector('#search-complete')?.value || '').toLowerCase().trim();
                const searchTerms = { waiting: globalSearchTerm, complete: globalSearchTerm, cancelled: globalSearchTerm, shipped: globalSearchTerm, work_orders: globalSearchTerm };
                const filters = { waiting: container.querySelector('#filter-waiting').value, complete: container.querySelector('#filter-complete').value, cancelled: container.querySelector('#filter-cancelled').value, shipped: container.querySelector('#filter-shipped').value, work_orders: container.querySelector('#filter-work-orders').value };
                const lists = { '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': container.querySelector('#tab-waiting .order-list'), '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': container.querySelector('#tab-complete .order-list'), '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': container.querySelector('#tab-cancelled .order-list'), '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß': container.querySelector('#tab-shipped .order-list') };
                const summaryContainer = container.querySelector('#channel-summary-container');
                if (summaryContainer) { const completedOrders = allOrdersData.filter(order => order.status === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'); const channelCounts = completedOrders.reduce((acc, order) => { const channel = order.channel_code || 'N/A'; acc[channel] = (acc[channel] || 0) + 1; return acc; }, {}); summaryContainer.innerHTML = ''; const sortedChannels = Object.keys(channelCounts).sort(); if (sortedChannels.length > 0) { let summaryHTML = ''; for (const channel of sortedChannels) { summaryHTML += `<span class="channel-summary-item" data-channel="${channel}">${channel}: ${channelCounts[channel]} ‡∏ö‡∏¥‡∏•</span>`; } summaryContainer.innerHTML = summaryHTML; } else { summaryContainer.innerHTML = `<span class="channel-summary-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</span>`; } }
                workOrdersListContainer.innerHTML = ''; Object.values(lists).forEach(list => { if(list) list.innerHTML = ''; });
                
                const renderOrderListItems = (orders, listElement, filterValue, searchTerm) => {
                    let htmlContent = '';
                    orders.forEach(order => {
                        const matchesSearch = !searchTerm || (order.bill_no && order.bill_no.toLowerCase().includes(searchTerm)) || (order.customer_name && order.customer_name.toLowerCase().includes(searchTerm)) || (order.tracking_number && order.tracking_number.toLowerCase().includes(searchTerm));
                        if ((filterValue === 'all' || filterValue === order.channel_code) && matchesSearch) {
                            const trackingHTML = `<span class="order-tracking">
    <span class="tracking-text" style="${order.tracking_number ? '' : 'color: #ccc;'}">${order.tracking_number || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'}</span> 
    <button class="btn btn-sm btn-edit-tracking" title="${order.tracking_number ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'}">‚úèÔ∏è</button>
</span>`;
                            
                            let billingIndicator = '';
                            if (order.billing_details) {
                                if (order.billing_details.request_tax_invoice) {
                                    billingIndicator = ` <span style="font-size: 0.8em; color: #c82333; background-color: #fdd; border: 1px solid #c82333; padding: 2px 6px; border-radius: 4px; font-weight: bold;">üìÑ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>`;
                                } else if (order.billing_details.request_cash_bill) {
                                    billingIndicator = ` <span style="font-size: 0.8em; color: #007bff; background-color: #e7f3ff; border: 1px solid #007bff; padding: 2px 6px; border-radius: 4px; font-weight: bold;">üíµ ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>`;
                                }
                            }
                            let infoHTML = `<div><strong data-order-id="${order.id}">${order.bill_no || 'N/A'}</strong> <span class="customer-info">${order.customer_name || 'N/A'}${billingIndicator}</span></div>`;

                            if (order.channel_code === 'CLAIM' && (order.claim_type || order.claim_details)) {
                                const claimType = order.claim_type ? `<strong>${order.claim_type}</strong>` : '';
                                const claimDetails = order.claim_details || '';
                                const separator = claimType && claimDetails ? ': ' : '';
                                infoHTML += `<div class="shipping-details" style="color: #c82333; font-size: 0.8em; white-space: normal;">‡πÄ‡∏Ñ‡∏•‡∏°: ${claimType}${separator}${claimDetails}</div>`;
                            }

                            if (order.status === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' && order.shipped_by) {
                                const shippedTime = new Date(order.shipped_time).toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
                                infoHTML += `<div class="shipping-details">‡πÇ‡∏î‡∏¢: ${order.shipped_by} (${shippedTime})</div>`;
                            }
                            htmlContent += `<li class="order-list-item" data-order-id="${order.id}"><input type="checkbox" class="order-checkbox"><div class="order-info">${infoHTML}</div>${trackingHTML}</li>`;
                        }
                    });
                    listElement.innerHTML = htmlContent;
                };

                const shippedOrders = allOrdersData
                    .filter(o => o.status === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß')
                    .sort((a, b) => (b.shipped_time || '').localeCompare(a.shipped_time || ''));
                
                const otherStatuses = ['‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'];
                otherStatuses.forEach(status => {
                    const ordersForStatus = allOrdersData
                        .filter(o => o.status === status)
                        .sort((a, b) => (b.bill_no || '').localeCompare(a.bill_no || ''));
                    
                    let tabKey;
                    if (status === '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') tabKey = 'waiting';
                    else if (status === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') tabKey = 'complete';
                    else if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') tabKey = 'cancelled';
                    
                    if (tabKey && lists[status]) {
                        renderOrderListItems(ordersForStatus, lists[status], filters[tabKey], searchTerms[tabKey]);
                    }
                });
                
                if(lists['‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß']) {
                    renderOrderListItems(shippedOrders, lists['‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'], filters.shipped, searchTerms.shipped);
                }

                const workOrdersFilter = filters.work_orders; const workOrdersSearch = searchTerms.work_orders;
                allWorkOrdersData.forEach(wo => {
                    const billsInWorkOrder = allOrdersData.filter(order => order.work_order_name === wo.work_order_name);
                    if (workOrdersFilter !== 'all' && wo.channel_code !== workOrdersFilter) return;
                    if (workOrdersSearch) { 
                        const woNameMatches = wo.work_order_name.toLowerCase().includes(workOrdersSearch); 
                        const anyBillMatches = billsInWorkOrder.some(bill => (bill.bill_no && bill.bill_no.toLowerCase().includes(workOrdersSearch)) || (bill.customer_name && bill.customer_name.toLowerCase().includes(workOrdersSearch)) || (bill.tracking_number && bill.tracking_number.toLowerCase().includes(workOrdersSearch))); 
                        if (!woNameMatches && !anyBillMatches) return; 
                    }
                    
                    const allHaveTracking = billsInWorkOrder.length > 0 && billsInWorkOrder.every(bill => bill.tracking_number && bill.tracking_number.trim() !== '');
                    const trackingStatusIcon = allHaveTracking ? '<span style="color: green; font-weight: bold; margin-left: 8px;">‚úì</span>' : '';
                    const groupEl = document.createElement('div'); 
                    groupEl.className = 'work-order-group'; 
                    
                    let billsHTML = '<ul class="order-list">';
                    billsInWorkOrder.sort((a, b) => (a.bill_no || '').localeCompare(b.bill_no || '')).forEach(bill => { 
                        // ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
                        let billingIndicator = '';
                        if (bill.billing_details) {
                            if (bill.billing_details.request_tax_invoice) {
                                billingIndicator = ` <span style="font-size: 0.8em; color: #c82333; background-color: #fdd; border: 1px solid #c82333; padding: 2px 6px; border-radius: 4px; font-weight: bold;">üìÑ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>`;
                            } else if (bill.billing_details.request_cash_bill) {
                                billingIndicator = ` <span style="font-size: 0.8em; color: #007bff; background-color: #e7f3ff; border: 1px solid #007bff; padding: 2px 6px; border-radius: 4px; font-weight: bold;">üíµ ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>`;
                            }
                        }

                        const trackingHTML = `<span class="order-tracking">
    <span class="tracking-text" style="${bill.tracking_number ? '' : 'color: #ccc;'}">${bill.tracking_number || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'}</span> 
    <button class="btn btn-sm btn-edit-tracking" title="${bill.tracking_number ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'}">‚úèÔ∏è</button>
</span>`;
                        
                        billsHTML += `<li class="order-list-item" data-order-id="${bill.id}"><input type="checkbox" class="order-checkbox"><div class="order-info"><div><strong data-order-id="${bill.id}">${bill.bill_no}</strong><span class="customer-info">${bill.customer_name || 'N/A'}${billingIndicator}</span></div></div>${trackingHTML}</li>`; 
                    });
                    billsHTML += '</ul>';

                    const waybillSortChannels = ['FSPTR', 'SPTR', 'TTTR', 'LZTR', 'SHOP']; 
                    const isWaybillSortChannel = waybillSortChannels.includes(wo.channel_code);
                    
                    let actionButtonsHTML = `<button class="btn btn-success btn-sm picking-slip-btn" data-work-order-name="${wo.work_order_name}">üìã ‡∏ó‡∏≥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</button><button class="btn btn-primary btn-sm export-production-btn" data-work-order-name="${wo.work_order_name}">üì§ Export (‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏¥‡∏ï)</button><button class="btn btn-sm export-qc-btn" style="background-color: #6f42c1; color: white; border: none;" data-work-order-name="${wo.work_order_name}">üîç Export for QC</button><button class="btn btn-sm export-barcode-btn" style="background-color: #3f51b5; color: white; border: none;" data-work-order-name="${wo.work_order_name}">üè∑Ô∏è ‡∏ó‡∏≥ Barcode</button>`;
                    if (isWaybillSortChannel) { 
                        actionButtonsHTML += `<button class="btn btn-warning btn-sm export-waybill-sort-btn" data-work-order-name="${wo.work_order_name}">üì§ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤</button>`;
                    } else { 
                        actionButtonsHTML += `<button class="btn btn-warning btn-sm prepare-waybill-btn" data-work-order-name="${wo.work_order_name}">üì§ Export (‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤)</button><button class="btn btn-info btn-sm import-wo-csv-btn" data-work-order-name="${wo.work_order_name}">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>`; 
                    }
                    
                    if (currentUserRole === 'superadmin' || currentUserRole === 'manager') { 
                        actionButtonsHTML += `<button class="btn btn-danger btn-sm cancel-wo-btn" data-work-order-name="${wo.work_order_name}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>`; 
                    }
                    
                    const batchActionsHTML = `
                        <div class="batch-actions" ${(currentUserRole !== 'superadmin' && currentUserRole !== 'manager') ? 'style="display: none;"' : ''}>
                            <button class="btn btn-secondary select-all-in-wo-btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            <button class="btn btn-warning revert-to-waiting-btn" data-work-order-name="${wo.work_order_name}">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</button>
                            <button class="btn btn-info revert-to-complete-btn" data-work-order-name="${wo.work_order_name}">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button>
                            <button class="btn btn-danger cancel-bills-from-wo-btn" data-work-order-name="${wo.work_order_name}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        </div>`;

                    groupEl.innerHTML = `<div class="work-order-header"><span class="wo-name">${wo.work_order_name} (${billsInWorkOrder.length} ‡∏ö‡∏¥‡∏•)${trackingStatusIcon}</span><div class="wo-header-actions">${actionButtonsHTML}</div></div><div class="work-order-bills">${batchActionsHTML}${billsHTML}</div>`;
                    
                    workOrdersListContainer.appendChild(groupEl);
                });
                updateSmartWorkOrderButton();
            }
            
            let isOpeningWindow = false;
            function prepareForWaybill(workOrderName) { if (isOpeningWindow) return; isOpeningWindow = true; const ordersToProcess = allOrdersData.filter(order => order.work_order_name === workOrderName); if (ordersToProcess.length === 0) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå"); isOpeningWindow = false; return; } const headers = ['bill_no', 'customer_address', 'payment_method', 'total_amount']; const rows = ordersToProcess.map(order => { const escapeCsvField = (field) => { const strField = String(field || ''); if (strField.includes(',') || strField.includes('"') || strField.includes('\n')) { return `"${strField.replace(/"/g, '""')}"`; } return strField; }; const addressForExport = ecommerceChannels.includes(order.channel_code) ? '' : order.customer_address; return [escapeCsvField(order.bill_no), escapeCsvField(addressForExport), escapeCsvField(order.payment_method), escapeCsvField(order.total_amount)].join(','); }); const csvContent = [headers.join(','), ...rows].join('\n'); try { localStorage.setItem('waybillDataForFlash', csvContent); localStorage.setItem('workOrderNameForFlash', workOrderName); window.open('flash_express_tool.html', '_blank'); } catch (e) { console.error("Error:", e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); } finally { setTimeout(() => { isOpeningWindow = false; }, 1000); } }
            
            async function handleTrackingImport(file) { if (!file) return; loadingOverlay.style.display = 'flex'; const reader = new FileReader(); reader.onload = async (event) => { try { const csv = event.target.result; const lines = csv.split(/[\r\n]+/).filter(line => line.trim() !== ''); if (lines.length <= 1) throw new Error('‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤'); const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '')); const billNoIndex = headers.indexOf('bill_no'); const trackingIndex = headers.indexOf('tracking_number'); if (billNoIndex === -1 || trackingIndex === -1) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ bill_no ‡πÅ‡∏•‡∏∞ tracking_number'); const updates = lines.slice(1).map(line => { const values = line.split(','); const bill_no = values[billNoIndex]?.trim().replace(/"/g, ''); const tracking_number = values[trackingIndex]?.trim().replace(/"/g, ''); if (!bill_no || !tracking_number) return null; return { bill_no, tracking_number }; }).filter(Boolean); if (updates.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); const { data: updatedCount, error } = await supabaseClient.rpc('update_tracking_numbers_batch', { p_updates: updates }); if (error) throw error; alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${updatedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`); } catch (err) { console.error('Error:', err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { loadingOverlay.style.display = 'none'; trackingFileInput.value = ''; } }; reader.readAsText(file, 'UTF-8'); }

            function downloadStandardOrderTemplate() { const headers = ["‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å", "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô", "‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô", "‡∏ü‡∏≠‡∏ô‡∏ï‡πå", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö"]; const sampleData = [["SP", "‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", "123/45 ‡∏ñ.‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á ‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡∏Å‡∏ó‡∏°. 10110", 300, 30, 0, "‡πÇ‡∏≠‡∏ô", "‡πÇ‡∏õ‡∏£ 9.9", "2025-10-15", "10:30", "‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏µ‡∏î‡∏ï‡∏¥‡∏î", "‡∏î‡∏≥", "1", "‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", "‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥", "TH01", "‡∏î.‡∏ä. ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏ä‡∏±‡πâ‡∏ô ‡∏õ.1", "", 2, "‡πÑ‡∏°‡πà‡∏°‡∏µ", ""]]; const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "OrderTemplate"); XLSX.writeFile(workbook, "TRKids_Multi_Order_Template_Simple.xlsx"); }
            function downloadPgtrTemplate() { const headers = ['#', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î', '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á', 'coupon', '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î admin', '‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô', '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', '‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ü‡∏≠‡∏ô‡∏ï‡πå', '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö', 'Underline', 'Ink', '‡∏™‡∏µ', 'Label1', 'Label2', 'Label3', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'comment', 'remark', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö', '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏ï‡∏≥‡∏ö‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á', '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏©‡∏ì‡∏µ‡∏¢‡πå', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°']; const sampleData = [[]]; const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "PGTR_Template"); XLSX.writeFile(workbook, "TRKids_PGTR_Order_Template.xlsx"); }
            function downloadWyTemplate() { const headers = ["‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", "‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏≥‡∏£‡∏∞", "‡∏£‡∏´‡∏±‡∏™", "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î1", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î2", "font", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏", "‡∏ä‡∏∑‡πà‡∏≠", "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•", "‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", "‡πÄ‡∏•‡∏Ç‡πÑ‡∏õ‡∏©‡∏ì‡∏µ‡∏¢‡πå", "‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"]; const sampleData = [[]]; const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "WY_Template"); XLSX.writeFile(workbook, "TRKids_WY_Order_Template.xlsx"); }

            function applyStampInkLogicToOrderObject(order) { const originalItems = [...order.items]; originalItems.forEach(item => { const product = fullProductList.find(p => p.id === item.product_id); if (!product || !product.product_category || !product.product_category.toUpperCase().includes('STAMP')) { return; } const inkColor = item.ink_color || ''; const targetColors = { '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡∏î‡∏≥': '‡∏î‡∏≥', '‡πÅ‡∏î‡∏á': '‡πÅ‡∏î‡∏á', '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô': '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô' }; const matchedColor = Object.keys(targetColors).find(c => inkColor.includes(c) && inkColor.includes('‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å')); if (!matchedColor) { return; } const inkProductName = `‡∏´‡∏°‡∏∂‡∏Å‡πÅ‡∏ü‡∏•‡∏ä‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å 5 ml. (${matchedColor})`; const inkProductToAdd = fullProductList.find(p => p.product_name === inkProductName); if (inkProductToAdd) { if (!order.items.some(existingItem => existingItem.product_id === inkProductToAdd.id)) { order.items.push({ product_id: inkProductToAdd.id, product_name: inkProductToAdd.product_name, quantity: 1, ink_color: "", product_type: "", cartoon_pattern: "", line_pattern: "", font: "", line_1: "", line_2: "", line_3: "", notes: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏°", file_attachment: "" }); } } else { console.warn(`Could not find giveaway product: ${inkProductName}`); } }); }
            
            async function processAndSaveImportedOrders(ordersToImport, useProvidedBillNo = false) { loadingOverlay.style.display = 'flex'; let successCount = 0; let totalItemsCount = 0; let failedOrders = []; let skippedOrders = []; for (const order of ordersToImport) { try { const billNo = useProvidedBillNo ? order.bill_no : await generateNextBillNo(order.channel_code); if (!billNo) { failedOrders.push({ name: order.customer_name || 'N/A', reason: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' }); continue; } if (allOrdersData.some(o => o.bill_no === billNo)) { console.warn(`Skipping existing bill_no: ${billNo}`); skippedOrders.push(billNo); continue; } applyStampInkLogicToOrderObject(order); const orderData = { ...order }; delete orderData.items; const { data: insertedOrder, error: orderError } = await supabaseClient.from('orders').insert({ ...orderData, bill_no: billNo }).select().single(); if (orderError) throw orderError; const allItemsToInsert = []; let itemSequence = 1; for (const item of order.items) { const quantity = item.quantity || 1; const baseItemData = { ...item }; delete baseItemData.quantity; for (let i = 0; i < quantity; i++) { allItemsToInsert.push({ ...baseItemData, order_id: insertedOrder.id, bill_no: billNo, item_uid: `${billNo}-${itemSequence++}` }); } } if (allItemsToInsert.length > 0) { const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert); if (itemsError) throw itemsError; totalItemsCount += allItemsToInsert.length; } successCount++; } catch (err) { console.error(`Error processing order for ${order.customer_name}:`, err); const billNoForError = useProvidedBillNo ? order.bill_no : 'N/A'; if (err.message.includes('duplicate key')) { failedOrders.push({ name: order.customer_name || 'N/A', reason: `‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡∏ã‡πâ‡∏≥: ${billNoForError}`}); } else { failedOrders.push({ name: order.customer_name || 'N/A', reason: err.message }); } } } loadingOverlay.style.display = 'none'; let alertMessage = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå (${totalItemsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`; if (skippedOrders.length > 0) { alertMessage += `\n\n‡∏Ç‡πâ‡∏≤‡∏° ${skippedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡∏ã‡πâ‡∏≥): ${skippedOrders.length <= 10 ? skippedOrders.join(', ') : ''}.`; } if (failedOrders.length > 0) { const failedReasons = failedOrders.map(f => `${f.name} (${f.reason})`).join(', '); alertMessage += `\n\n‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${failedReasons}.`; } alert(alertMessage); }

            const findHeader = (headers, possibleNames) => { const lowerCaseNames = possibleNames.map(name => name.toLowerCase().trim()); for (const header of headers) { if (lowerCaseNames.includes(header.toLowerCase().trim())) { return header; } } return null; };
            function excelDateToJSDate(serial) { if (typeof serial !== 'number' || isNaN(serial)) return null; const utc_days = Math.floor(serial - 25569); const utc_value = utc_days * 86400; const date_info = new Date(utc_value * 1000); const fractional_day = serial - Math.floor(serial) + 0.0000001; let total_seconds = Math.floor(86400 * fractional_day); const seconds = total_seconds % 60; total_seconds -= seconds; const hours = Math.floor(total_seconds / (60 * 60)); const minutes = Math.floor(total_seconds / 60) % 60; return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds); }

            function handleExcelImport(file) { if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const rowsData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false }); if (rowsData.length <= 1) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); const processedOrders = []; let currentOrder = null; for (let i = 1; i < rowsData.length; i++) { const row = rowsData[i]; if (row.every(cell => String(cell).trim() === '')) continue; const channelCode = String(row[0]).trim(); const customerName = String(row[1]).trim(); const productNameOrCode = String(row[10]).trim(); if (channelCode && customerName) { const price = parseFloat(row[3]) || 0; const shippingCost = parseFloat(row[4]) || 0; const discount = parseFloat(row[5]) || 0; let paymentDate = row[8] ? String(row[8]).trim() : null; let paymentTime = row[9] ? String(row[9]).trim() : null; if (paymentDate && !isNaN(paymentDate) && Number(paymentDate) > 1) { const jsDate = excelDateToJSDate(Number(paymentDate)); if(jsDate) { paymentDate = jsDate.toISOString().split('T')[0]; } } if (paymentTime && !isNaN(paymentTime) && Number(paymentTime) < 1) { const jsDate = excelDateToJSDate(Number(paymentTime)); if(jsDate) { paymentTime = jsDate.toTimeString().split(' ')[0].substring(0,5); } } currentOrder = { channel_code: channelCode, customer_name: customerName, customer_address: String(row[2]).trim(), price: price, shipping_cost: shippingCost, discount: discount, total_amount: price + shippingCost - discount, payment_method: String(row[6]).trim(), promotion: String(row[7]).trim(), payment_date: paymentDate, payment_time: paymentTime, admin_user: loggedInUsername, status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', entry_date: new Date().toISOString().slice(0, 10), items: [] }; if (ecommerceChannels.includes(channelCode)) { currentOrder.tracking_number = currentOrder.customer_address.replace(/\s/g, ''); } processedOrders.push(currentOrder); } if (productNameOrCode) { if (!currentOrder) throw new Error(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${productNameOrCode}' ‡πÅ‡∏ñ‡∏ß ${i + 1} ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå`); const searchTerm = productNameOrCode.toLowerCase(); const product = fullProductList.find(p => p.product_code.toLowerCase() === searchTerm || p.product_name.toLowerCase().includes(searchTerm)); if (!product) { console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${productNameOrCode}' ‡πÅ‡∏ñ‡∏ß ${i+1} - ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ`); continue; } const itemData = { product_id: product.id, product_name: product.product_name, ink_color: String(row[11]).trim(), product_type: String(row[12]).trim(), cartoon_pattern: String(row[13]).trim(), line_pattern: String(row[14]).trim(), font: String(row[15]).trim(), line_1: String(row[16]).trim(), line_2: String(row[17]).trim(), line_3: String(row[18]).trim(), quantity: parseInt(row[19]) || 1, notes: String(row[20]).trim(), file_attachment: String(row[21]).trim() }; currentOrder.items.push(itemData); } } if (processedOrders.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå"); if (confirm(`‡∏û‡∏ö ${processedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤?`)) { await processAndSaveImportedOrders(processedOrders); } } catch (err) { console.error('Excel Import Error:', err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { importOrdersFileInput.value = ''; } }; reader.readAsArrayBuffer(file); }
            function handlePgtrImport(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                        if (jsonData.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

                        const headers = Object.keys(jsonData[0]);
                        const orderNumberHeader = findHeader(headers, ['‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', 'Order Number']);
                        const paymentDateHeader = findHeader(headers, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠']);
                        const paymentTimeHeader = findHeader(headers, ['‡πÄ‡∏ß‡∏•‡∏≤']);
                        
                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Header ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mapping ‡πÉ‡∏´‡∏°‡πà
                        const productCodeHeader = findHeader(headers, ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']);
                        const productNameHeader = findHeader(headers, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']);

                        if (!orderNumberHeader) {
                            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö '‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå'");
                        }

                        const ordersMap = new Map();
                        for (const row of jsonData) {
                            const orderNumberRaw = String(row[orderNumberHeader] || '').trim();
                            if (!orderNumberRaw) continue;

                            let orderNumber = orderNumberRaw;
                            const lastHyphenIndex = orderNumber.lastIndexOf('-');
                            if (lastHyphenIndex > 0) {
                                const lastSegment = orderNumber.substring(lastHyphenIndex + 1);
                                if (!isNaN(parseInt(lastSegment)) && /^\d{1,2}$/.test(lastSegment)) {
                                    orderNumber = orderNumber.substring(0, lastHyphenIndex);
                                }
                            }

                            if (!ordersMap.has(orderNumber)) {
                                const price = parseFloat(row["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"]) || 0;
                                const shippingCost = parseFloat(row["‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á"]) || 0;
                                const discount = parseFloat(row["‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î admin"]) || 0;
                                let paymentDate = null;
                                let paymentTime = null;

                                if (paymentDateHeader && row[paymentDateHeader]) {
                                    const rawDate = row[paymentDateHeader];
                                    if (typeof rawDate === 'number' && !isNaN(rawDate)) {
                                        const jsDate = excelDateToJSDate(rawDate);
                                        if (jsDate) paymentDate = jsDate.toISOString().split('T')[0];
                                    } else if (typeof rawDate === 'string' && rawDate.trim() !== '') {
                                        const dateParts = rawDate.trim().split('/');
                                        if (dateParts.length === 3 && dateParts[2].length === 4) {
                                            paymentDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                                        }
                                    }
                                }

                                if (paymentTimeHeader && row[paymentTimeHeader]) {
                                    const rawTime = row[paymentTimeHeader];
                                    if (typeof rawTime === 'number' && !isNaN(rawTime) && rawTime < 1) {
                                        const jsDate = excelDateToJSDate(rawTime);
                                        if (jsDate) paymentTime = jsDate.toTimeString().split(' ')[0].substring(0, 5);
                                    } else if (typeof rawTime === 'string' && rawTime.trim() !== '') {
                                        paymentTime = rawTime.trim().substring(0, 5);
                                    }
                                }

                                const orderData = {
                                    bill_no: orderNumber,
                                    channel_code: 'PGTR',
                                    customer_name: String(row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"] || '').trim(),
                                    customer_address: (`${row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"] || ''},${row["‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°"] || ''},${row["‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] || ''}`).trim(),
                                    price: price,
                                    shipping_cost: shippingCost,
                                    discount: discount,
                                    total_amount: price + shippingCost - discount,
                                    payment_method: "‡πÇ‡∏≠‡∏ô",
                                    promotion: "",
                                    payment_date: paymentDate,
                                    payment_time: paymentTime,
                                    admin_user: loggedInUsername,
                                    status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                                    entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                ordersMap.set(orderNumber, orderData);
                            }

                            const currentOrder = ordersMap.get(orderNumber);

                            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏µ‡∏î) ---
                            const rawProductCode = String(row[productCodeHeader] || '').trim();
                            const cleanProductCode = rawProductCode.split('-')[0].trim(); // ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ -
                            
                            const product = fullProductList.find(p => p.product_code === cleanProductCode);

                            if (!product) {
                                console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ '${cleanProductCode}' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${rawProductCode}) - ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ`);
                                continue;
                            }

                            const comment = String(row["comment"] || "").trim();
                            const remark = String(row["remark"] || "").trim();

                            const itemData = {
                                product_id: product.id,
                                product_name: product.product_name,
                                ink_color: (`${row["Ink"] || ''}${row["‡∏™‡∏µ"] || ''}`).trim(),
                                product_type: "",
                                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà ‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô (cartoon_pattern) ---
                                cartoon_pattern: String(row[productNameHeader] || '').trim(),
                                line_pattern: String(row["Underline"] || '').trim(),
                                font: String(row["‡∏ü‡∏≠‡∏ô‡∏ï‡πå"] || '').trim(),
                                line_1: String(row["Label1"] || '').trim(),
                                line_2: String(row["Label2"] || '').trim(),
                                line_3: String(row["Label3"] || '').trim(),
                                quantity: parseInt(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]) || 1,
                                notes: comment && remark ? `${comment},${remark}` : (comment || remark),
                                file_attachment: ""
                            };
                            currentOrder.items.push(itemData);
                        }

                        const processedOrders = Array.from(ordersMap.values());
                        if (processedOrders.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                        if (confirm(`‡∏û‡∏ö ${processedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤?`)) {
                            await processAndSaveImportedOrders(processedOrders, true);
                        }
                    } catch (err) {
                        console.error('Error importing PGTR:', err);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                    } finally {
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function handleWyImport(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        if (jsonData.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");

                        const headers = Object.keys(jsonData[0]);
                        const billNoHeader = findHeader(headers, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'bill_no', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•']);
                        const dateTimeHeader = findHeader(headers, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠']);
                        const customerNameHeader = findHeader(headers, ['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']);
                        const customerAddressHeader = findHeader(headers, ['‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö']);
                        const productIdentifierHeader = findHeader(headers, ['‡∏£‡∏´‡∏±‡∏™']); 

                        if (!billNoHeader) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•'"); }
                        if (!customerNameHeader) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'"); }
                        if (!customerAddressHeader) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö'"); }
                        if (!productIdentifierHeader) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏£‡∏´‡∏±‡∏™'"); }


                        const ordersMap = new Map();
                        for (const row of jsonData) {
                            const billNo = String(row[billNoHeader]).trim();
                            if (!billNo) continue;

                            if (!ordersMap.has(billNo)) {
                                const price = parseFloat(row['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î']) || 0;
                                const shippingCost = parseFloat(row['‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á']) || 0;
                                const discount = parseFloat(row['‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î']) || 0;
                                
                                const customerName = String(row[customerNameHeader] || '').trim();
                                const customerAddress = String(row[customerAddressHeader] || '').trim();

                                let paymentDate = null;
                                let paymentTime = null;

                                if (dateTimeHeader && row[dateTimeHeader]) {
                                    const rawDateTime = String(row[dateTimeHeader]).trim();
                                    if (rawDateTime.includes(' ')) {
                                        const parts = rawDateTime.split(' ');
                                        paymentDate = parts[0]; 
                                        if (parts[1] && parts[1].length >= 5) {
                                           paymentTime = parts[1].substring(0, 5); 
                                        }
                                    }
                                }
                                
                                const orderData = {
                                    bill_no: billNo,
                                    channel_code: 'WY',
                                    customer_name: customerName,
                                    customer_address: customerAddress,
                                    price: price,
                                    shipping_cost: shippingCost,
                                    discount: discount,
                                    total_amount: parseFloat(row['‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥']) || (price + shippingCost - discount),
                                    payment_method: '‡πÇ‡∏≠‡∏ô',
                                    promotion: String(row['‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î'] || '').trim(),
                                    payment_date: paymentDate,
                                    payment_time: paymentTime,
                                    admin_user: loggedInUsername,
                                    status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                                    entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                ordersMap.set(billNo, orderData);
                            }

                            const currentOrder = ordersMap.get(billNo);
                            const productNameFromFile = String(row[productIdentifierHeader]).trim();
                            
                            const product = fullProductList.find(p => p.product_name.toLowerCase() === productNameFromFile.toLowerCase());
                            
                            if (product) {
                                const itemData = {
                                    product_id: product.id,
                                    product_name: product.product_name,
                                    ink_color: "",
                                    product_type: "",
                                    cartoon_pattern: "",
                                    line_pattern: "",
                                    font: String(row['font'] || '').trim(),
                                    line_1: String(row['‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î1'] || '').trim(),
                                    line_2: String(row['‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î2'] || '').trim(),
                                    line_3: "",
                                    quantity: parseInt(row['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']) || 1,
                                    notes: String(row['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'] || '').trim(),
                                    file_attachment: ""
                                };
                                currentOrder.items.push(itemData);
                            } else {
                                console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ '${productNameFromFile}' ‡πÉ‡∏ô‡∏ö‡∏¥‡∏• ${billNo} - ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ`);
                            }
                        }

                        const processedOrders = Array.from(ordersMap.values());
                        if (processedOrders.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");
                        if (confirm(`‡∏û‡∏ö ${processedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                            await processAndSaveImportedOrders(processedOrders, true);
                        }
                    } catch (err) {
                        console.error('Error importing WY:', err);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå WY: ' + err.message);
                    } finally {
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function handleSmartImport(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', bookFiles: true });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        if (jsonData.length === 0) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

                        const firstRow = jsonData[0];
                        const headers = Object.keys(firstRow);
                        
                        const orderNumberHeader = findHeader(headers, ['‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', 'Order Number']);
                        if (orderNumberHeader && String(firstRow[orderNumberHeader]).toUpperCase().startsWith('S2Y')) {
                            console.log("PGTR template detected.");
                            handlePgtrImport(file);
                            return;
                        }

                        const billNoHeader = findHeader(headers, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'bill_no', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•']);
                        if (billNoHeader && String(firstRow[billNoHeader]).toUpperCase().startsWith('WY')) {
                            console.log("WY template detected.");
                            handleWyImport(file);
                            return;
                        }

                        console.log("Standard template detected.");
                        handleExcelImport(file);

                    } catch (err) {
                        console.error('Error detecting file type:', err);
                        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: " + err.message);
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function toggleWorkOrder(headerElement) { const content = headerElement.nextElementSibling; if (content) { content.classList.toggle('show'); } }
            function populateChannelDropdowns() { const dropdowns = [ container.querySelector('#channel_code'), container.querySelector('#filter-waiting'), container.querySelector('#filter-complete'), container.querySelector('#filter-cancelled'), container.querySelector('#filter-shipped'), container.querySelector('#filter-work-orders') ]; const currentFormChannel = container.querySelector('#channel_code').value; dropdowns.forEach(dropdown => { if (!dropdown) return; const isFilter = dropdown.id.startsWith('filter-'); dropdown.innerHTML = isFilter ? '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' : '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>'; channelList.forEach(ch => { const opt = document.createElement('option'); opt.value = ch.channel_code; opt.textContent = ch.channel_name; dropdown.appendChild(opt); }); }); container.querySelector('#channel_code').value = currentFormChannel; }
            
            function updateSmartWorkOrderButton() {
                const smartBtn = document.getElementById('create-wo-smart-btn');
                const qtyInput = document.getElementById('create-wo-by-quantity-input');
                if (!smartBtn || !qtyInput) return;

                const checkedCount = container.querySelectorAll('#tab-complete .order-checkbox:checked').length;
                const qtyValue = parseInt(qtyInput.value, 10);

                if (checkedCount > 0) {
                    smartBtn.textContent = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (${checkedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)`;
                    smartBtn.className = 'btn btn-success';
                    qtyInput.disabled = true;
                    qtyInput.value = '';
                } else if (qtyValue > 0) {
                    smartBtn.textContent = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (${qtyValue} ‡∏ö‡∏¥‡∏•)`;
                    smartBtn.className = 'btn btn-primary';
                    qtyInput.disabled = false;
                } else {
                    smartBtn.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á)';
                    smartBtn.className = 'btn btn-info';
                    qtyInput.disabled = false;
                }
            }
            
            function openTab(evt, tabName) { 
                container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active')); 
                container.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active')); 
                container.querySelector(`#${tabName}`).classList.add('active'); 
                evt.currentTarget.classList.add('active'); 
                if (tabName === 'tab-create') { setFormMode('create'); }
                if (tabName === 'tab-complete') { updateSmartWorkOrderButton(); }
            }
            
            function setFormMode(mode, order = null) {
                orderForm.reset();
                itemsTbody.innerHTML = '';
                currentEditingOrderId = null;
                adminUserInput.value = loggedInUsername;
                document.getElementById('slip-status').textContent = '';
                container.querySelector('label[for="customer_address"]').textContent = '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
                $(container.querySelectorAll('select')).not('#promotion').val(null).trigger('change');
                $('#promotion').val(null).trigger('change');

                requestTaxInvoiceCb.checked = false;
                requestCashBillCb.checked = false;
                taxInvoiceSection.style.display = 'none';
                taxItemsTbody.innerHTML = '';
                
                const claimSection = document.getElementById('claim-details-section');
                claimSection.style.display = 'none';
                
                const allControls = orderForm.querySelectorAll('input, select, textarea, button');
                allControls.forEach(el => el.disabled = false);
                $(orderForm.querySelectorAll('.select2-hidden-accessible')).prop('disabled', false).trigger('change');
                addItemBtn.style.display = 'block';
                document.getElementById('upload-slip-btn').style.display = 'block';
                document.getElementById('payment-info-section').style.display = 'block';

                if (mode === 'create') {
                    container.querySelector('#form-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà';
                    addItemRow();
                    formActions.innerHTML = `<button type="button" class="btn btn-secondary" id="save-waiting-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</button> <button type="button" class="btn btn-success" id="save-complete-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö)</button>`;
                } else if (mode === 'edit' && order) {
                    container.querySelector('#form-title').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${order.bill_no}`;
                    currentEditingOrderId = order.id;

                    Object.keys(order).forEach(key => {
                        const input = container.querySelector(`#${key}`);
                        if (input) {
                            if (input.tagName === 'SELECT') {
                                if (key === 'promotion') {
                                    if (order[key] && !$('#promotion').find(`option[value='${order[key]}']`).length) {
                                        var newOption = new Option(order[key], order[key], true, true);
                                        $('#promotion').append(newOption).trigger('change');
                                    }
                                    $('#promotion').val(order[key]).trigger('change');
                                } else { $(input).val(order[key]).trigger('change'); }
                            } else { input.value = order[key]; }
                        }
                    });

                    // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    if (order.billing_details) {
                        const bd = order.billing_details;
                        requestTaxInvoiceCb.checked = bd.request_tax_invoice || false;
                        requestCashBillCb.checked = bd.request_cash_bill || false;
                        
                        document.getElementById('tax-customer-name').value = bd.tax_customer_name || '';
                        document.getElementById('tax-customer-address').value = bd.tax_customer_address || '';
                        document.getElementById('tax-id').value = bd.tax_id || '';
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                        if (bd.request_tax_invoice || bd.request_cash_bill) {
                            taxInvoiceSection.style.display = 'block';
                            document.getElementById('tax-id').closest('.form-group').style.display = bd.request_tax_invoice ? 'block' : 'none';
                            
                            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0)
                            if (bd.tax_items && bd.tax_items.length > 0) {
                                populateTaxItems(bd.tax_items);
                            } else {
                                populateTaxItems(); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            }
                        }
                    }
                    
                    if (order.channel_code === 'CLAIM' || order.channel_code === 'INFU') {
                        claimSection.style.display = 'block';
                        document.getElementById('payment-info-section').style.display = 'none';
                    }

                    const sortedItems = (order.order_items || []).sort((a, b) => (a.item_uid || "").localeCompare(b.item_uid || "", undefined, {numeric: true}));
                    const itemGroups = []; const groupMap = {};
                    sortedItems.forEach(item => {
                        const product = fullProductList.find(p => p.id === item.product_id);
                        let uniqueKeyPart = (product && product.product_category && product.product_category.toUpperCase().includes('CONDO STAMP')) ? item.item_uid : '';
                        const key = [item.product_id, item.ink_color, item.product_type, item.cartoon_pattern, item.line_pattern, item.font, item.line_1, item.line_2, item.line_3, item.notes, item.file_attachment, uniqueKeyPart].join('||');
                        if (!groupMap[key]) { groupMap[key] = { ...item, quantity: 1 }; itemGroups.push(groupMap[key]); } else { groupMap[key].quantity++; }
                    });
                    itemGroups.forEach(groupedItem => { addItemRow(groupedItem); });

                    if (order.status === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß') {
                        container.querySelector('#channel_code').disabled = true;
                        container.querySelector('#customer_name').disabled = true;
                        container.querySelector('#customer_address').disabled = true;
                        $(container.querySelector('#channel_code')).prop('disabled', true).trigger('change');

                        itemsTbody.querySelectorAll('input, select, button').forEach(el => {
                            el.disabled = true;
                        });
                        $(itemsTbody).find('select').prop('disabled', true).trigger('change');
                        itemsTbody.querySelectorAll('.remove-item-btn').forEach(btn => btn.style.display = 'none');
                        addItemBtn.style.display = 'none';
                        
                        const paymentFields = ['price', 'shipping_cost', 'discount', 'payment_method', 'payment_date', 'payment_time'];
                        paymentFields.forEach(id => { container.querySelector(`#${id}`).disabled = false; });
                        $('#promotion').prop('disabled', false).trigger('change');
                        
                        document.getElementById('upload-slip-btn').style.display = 'none';
                        formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-payment-only-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`;
                    } else {
                        if (order.status === '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)' && (currentUserRole !== 'superadmin' && currentUserRole !== 'manager')) {
                            allControls.forEach(el => el.disabled = true);
                            $(orderForm.querySelectorAll('.select2-hidden-accessible')).prop('disabled', true).trigger('change');
                            addItemBtn.style.display = 'none';
                            formActions.innerHTML = `<p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${order.status} (‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</p>`;
                        } else if (order.status === '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)') {
                            formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-work-order-bill-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>`;
                        } else if (order.status === '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                            formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-waiting-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button> <button type="button" class="btn btn-success" id="move-to-complete-btn">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö"</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>`;
                        } else if (order.status === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
                            formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-complete-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>`;
                        }
                    }
                }
                adminUserInput.readOnly = true;
                container.querySelector('#total_amount').readOnly = true;
                attachFormActionListeners(order);
                calculateTotal();
            }

            async function loadOrderForEditing(orderId) { 
                const orderData = allOrdersData.find(o => o.id == orderId);
                loadingOverlay.style.display = 'flex'; 
                try { 
                    if(!orderData) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); 
                    openTab({ currentTarget: container.querySelector('.tab-link[data-tab="tab-create"]') }, 'tab-create'); 
                    setFormMode('edit', orderData); 
                } catch (error) { alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + error.message); } 
                finally { loadingOverlay.style.display = 'none'; } 
            }
            
            async function moveOrder(orderId, newStatus) { 
                if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÑ‡∏õ "${newStatus}"?`)) return; 
                loadingOverlay.style.display = 'flex'; 
                try { 
                    const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); 
                    if (error) throw error; 
                    alert(`‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`); 
                    setFormMode('create'); 
                } catch(error) { 
                    alert('‡∏û‡∏•‡∏≤‡∏î: ' + error.message); 
                } finally { 
                    loadingOverlay.style.display = 'none'; 
                } 
            }

            function getFontOptionsForChannel(channelCode) { const fontList = (channelCode === 'WY') ? wyFonts : standardFonts; const options = fontList.map(f => `<option value="${f}">${f}</option>`).join(''); return `<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>${options}`; }
            function updateAllFontDropdowns(channelCode) { const newFontOptionsHTML = getFontOptionsForChannel(channelCode); const fontDropdowns = itemsTbody.querySelectorAll('.item-font'); fontDropdowns.forEach(fontSelect => { const selectedValue = fontSelect.value; fontSelect.innerHTML = newFontOptionsHTML; if (fontSelect.querySelector(`option[value="${selectedValue}"]`)) { fontSelect.value = selectedValue; } else { fontSelect.value = ""; } }); }

            function addItemRow(item = null, rowUid = null) {
                const newUid = rowUid || 'row-' + Date.now() + Math.random(); const row = itemsTbody.insertRow(); row.dataset.rowUid = newUid;
                const shelfOptions = ['1', '2', '3', '4', '5'].map(n => `<option value="${n}">${n}</option>`).join('');
                const currentChannel = container.querySelector('#channel_code').value; const fontOptions = getFontOptionsForChannel(currentChannel);
                row.innerHTML = `<td><select class="item-product"></select></td><td><select class="item-ink_color"><option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ--</option></select></td><td><select class="item-shelf_location"><option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>${shelfOptions}</select></td><td><input type="text" class="item-cartoon_pattern"></td><td><input type="text" class="item-line_pattern"></td><td><select class="item-font">${fontOptions}</select></td><td><input type="text" class="item-line_1"></td><td><input type="text" class="item-line_2"></td><td><input type="text" class="item-line_3"></td><td><input type="number" class="item-quantity quantity-input" value="1" min="1"></td><td><input type="text" class="item-notes"></td><td><input type="text" class="item-file_attachment"></td><td class="action-cell"><button type="button" class="btn btn-danger remove-item-btn">X</button></td>`;
                const productSelect = $(row.querySelector('.item-product')); productSelect.select2({ data: productList, placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', width: '100%' });
                const inkSelect = row.querySelector('.item-ink_color'); inkTypeList.forEach(ink => { const opt = document.createElement('option'); opt.value = ink.ink_name; opt.textContent = ink.ink_name; inkSelect.appendChild(opt); });
                if (item) { 
                    productSelect.val(item.product_id).trigger('change.select2'); 
                    inkSelect.value = item.ink_color || ''; 
                    row.querySelector('.item-shelf_location').value = item.product_type || ''; 
                    row.querySelector('.item-cartoon_pattern').value = item.cartoon_pattern || ''; 
                    row.querySelector('.item-line_pattern').value = item.line_pattern || ''; 
                    row.querySelector('.item-font').value = item.font || ''; 
                    row.querySelector('.item-line_1').value = item.line_1 || ''; 
                    row.querySelector('.item-line_2').value = item.line_2 || ''; 
                    row.querySelector('.item-line_3').value = item.line_3 || ''; 
                    
                    const notesValue = item.notes || '';
                    const displayNotes = notesValue.replace(/\[SET-.*?\]/g, '').trim();
                    row.querySelector('.item-notes').value = displayNotes;
                    
                    row.querySelector('.item-file_attachment').value = item.file_attachment || ''; 
                    row.querySelector('.item-quantity').value = item.quantity || 1; 
                }
                return row;
            }
            
            function getSelectedOrderIds(listContainer) { return Array.from(listContainer.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId); }
            
            async function createWorkOrder(orderIdsToProcess) {
                if (!orderIdsToProcess || orderIdsToProcess.length === 0) { return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô'); }
                const selectedOrders = allOrdersData.filter(o => orderIdsToProcess.includes(String(o.id)));
                const ordersByChannel = selectedOrders.reduce((acc, order) => { const channel = order.channel_code; if (!acc[channel]) { acc[channel] = []; } acc[channel].push(order); return acc; }, {});
                const channelGroups = Object.keys(ordersByChannel);
                let confirmationMessage = "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:\n";
                channelGroups.forEach(channel => { confirmationMessage += `- ${channel}: ${ordersByChannel[channel].length} ‡∏ö‡∏¥‡∏•\n`; });
                if (!confirm(confirmationMessage + "\n‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?")) return;
                loadingOverlay.style.display = 'flex'; let successMessages = []; let errorMessages = [];
                for (const channelCode of channelGroups) { const groupSelectedIds = ordersByChannel[channelCode].map(o => o.id); try { const today = new Date(); const datePart = today.toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, ''); const workOrderDate = today.toISOString().slice(0, 10); const { data, error } = await supabaseClient.from('work_orders').select('batch_number').eq('channel_code', channelCode).eq('production_date', workOrderDate).order('batch_number', { ascending: false }).limit(1); if (error) throw error; const lastBatchNumber = data.length > 0 ? data[0].batch_number : 0; const batchNumber = lastBatchNumber + 1; const workOrderName = `${channelCode}-${datePart}-R${batchNumber}`; const { error: woError } = await supabaseClient.from('work_orders').insert({ work_order_name: workOrderName, channel_code: channelCode, production_date: workOrderDate, batch_number: batchNumber, order_count: groupSelectedIds.length, created_by: loggedInUsername, status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' }); if (woError) throw woError; const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)', work_order_name: workOrderName }).in('id', groupSelectedIds); if (updateError) throw updateError; const billsInWorkOrder = ordersByChannel[channelCode]; const qty = { STAMP: 0, STK: 0, CTT: 0, LASER: 0, TUBE: 0, PACK: billsInWorkOrder.length }; billsInWorkOrder.forEach(order => { (order.order_items || []).forEach(item => { const product = fullProductList.find(p => p.id === item.product_id); if (product && product.product_category) { const category = product.product_category.toUpperCase(); if (category.includes('STAMP')) qty.STAMP++; if (category.includes('STK')) qty.STK++; if (category.includes('UV')) qty.CTT++; if (category.includes('LASER')) qty.LASER++; if (category.includes('TUBE')) qty.TUBE++; } }); }); const creationTime = new Date(); const cutTime = `${String(creationTime.getHours()).padStart(2, '0')}:${String(creationTime.getMinutes()).padStart(2, '0')}`; const { error: plannerError } = await supabaseClient.from('jobs').insert({ name: workOrderName, date: workOrderDate, cut: cutTime, qty: qty, }); if (plannerError) { console.error('Planner Sync failed:', plannerError); throw new Error(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà Sync ‡πÑ‡∏õ Planner ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`); } successMessages.push(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`); } catch (error) { console.error(`Error for channel ${channelCode}:`, error); errorMessages.push(`‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á ${channelCode}: ${error.message}`); } }
                loadingOverlay.style.display = 'none'; let finalAlertMessage = successMessages.join('\n'); if(errorMessages.length > 0) { finalAlertMessage += '\n\n‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n' + errorMessages.join('\n'); }
                alert(finalAlertMessage);
	            await loadInitialData(true);
            }

            async function cancelSelectedOrders(tabKey) { const selectedIds = getSelectedOrderIds(container.querySelector(`#tab-${tabKey} .order-list`)); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå'); if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ${selectedIds.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).in('id', selectedIds); if (error) throw error; alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); } catch (error) { alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            
            async function moveSelectedOrders(tabKey, newStatus) { 
                const listContainer = container.querySelector(`#tab-${tabKey} .order-list`); 
                const selectedIds = getSelectedOrderIds(listContainer); 
                if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå'); 
                if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ ${selectedIds.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "${newStatus}"?`)) return; 
                loadingOverlay.style.display = 'flex'; 
                try { 
                    const { error } = await supabaseClient.from('orders').update({ status: newStatus }).in('id', selectedIds); 
                    if (error) throw error; 
                    alert('‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); 
                } catch (error) { 
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); 
                } finally { 
                    loadingOverlay.style.display = 'none'; 
                } 
            }

            async function restoreSelectedOrders(newStatus) { const selectedIds = getSelectedOrderIds(container.querySelector('#tab-cancelled .order-list')); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå'); const statusText = newStatus === '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'; if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á ${selectedIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà "${statusText}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: newStatus }).in('id', selectedIds); if (error) throw error; alert('‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); } catch (error) { alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            function selectAllInWorkOrder(buttonElement) { const billsContainer = buttonElement.closest('.work-order-bills'); const checkboxes = billsContainer.querySelectorAll('.order-checkbox'); const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
            async function updateWorkOrderCount(workOrderName) { const { count, error: countError } = await supabaseClient.from('orders').select('id', { count: 'exact', head: true }).eq('work_order_name', workOrderName); if (countError) { console.error('Error counting:', countError); throw countError; } if (count === 0) { console.log(`WO "${workOrderName}" is empty. Updating status.`); const { error: updateError } = await supabaseClient.from('work_orders').update({ status: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' }).eq('work_order_name', workOrderName); if (updateError) { console.error('Error updating empty WO:', updateError); throw updateError; } } else { const { error: updateError } = await supabaseClient.from('work_orders').update({ order_count: count }).eq('work_order_name', workOrderName); if (updateError) { console.error('Error updating WO count:', updateError); throw updateError; } } }
            async function updatePlannerJob(workOrderName, selectedIds = []) { const remainingBills = allOrdersData.filter(order => order.work_order_name === workOrderName && !selectedIds.includes(String(order.id))); if (remainingBills.length > 0) { const newQty = { STAMP: 0, STK: 0, CTT: 0, LASER: 0, TUBE: 0, PACK: 0 }; newQty.PACK = remainingBills.length; remainingBills.forEach(order => { (order.order_items || []).forEach(item => { const product = fullProductList.find(p => p.id === item.product_id); if (product && product.product_category) { const category = product.product_category.toUpperCase(); if (category.includes('STAMP')) newQty.STAMP++; if (category.includes('STK')) newQty.STK++; if (category.includes('UV')) newQty.CTT++; if (category.includes('LASER')) newQty.LASER++; if (category.includes('TUBE')) newQty.TUBE++; } }); }); const { error: updateJobError } = await supabaseClient.from('jobs').update({ qty: newQty }).eq('name', workOrderName); if (updateJobError) console.error('Failed to update job qty:', updateJobError); } else { const { error: deleteJobError } = await supabaseClient.from('jobs').delete().eq('name', workOrderName); if (deleteJobError) console.error('Failed to delete job:', deleteJobError); } }
            async function revertSelectedBills(buttonElement, newStatus) { const workOrderName = buttonElement.dataset.workOrderName; const groupEl = buttonElement.closest('.work-order-group'); const selectedIds = getSelectedOrderIds(groupEl); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•'); if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô ${selectedIds.length} ‡∏ö‡∏¥‡∏• ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "${newStatus}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: newStatus, work_order_name: null }).in('id', selectedIds); if (updateError) throw updateError; await updateWorkOrderCount(workOrderName); await updatePlannerJob(workOrderName, selectedIds); alert('‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');  await loadInitialData(true);} catch (error) { console.error('Error reverting:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            async function cancelSelectedBillsFromWorkOrder(buttonElement) { const workOrderName = buttonElement.dataset.workOrderName; const groupEl = buttonElement.closest('.work-order-group'); const selectedIds = getSelectedOrderIds(groupEl); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•'); if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å** ${selectedIds.length} ‡∏ö‡∏¥‡∏•?`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', work_order_name: null }).in('id', selectedIds); if (updateError) throw updateError; await updateWorkOrderCount(workOrderName); await updatePlannerJob(workOrderName, selectedIds); alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await loadInitialData(true); } catch (error) { console.error('Error cancelling:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            async function cancelWorkOrder(workOrderName) { if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô** "${workOrderName}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', work_order_name: null }).eq('work_order_name', workOrderName); if (updateError) throw updateError; const { error: deleteError } = await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName); if (deleteError) throw deleteError; const { error: deleteJobError } = await supabaseClient.from('jobs').delete().eq('name', workOrderName); if (deleteJobError) console.error(`Failed to delete job ${workOrderName}:`, deleteJobError.message); alert(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);await loadInitialData(true); } catch (error) { console.error('Error cancelling WO:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            
            function validateOrderForCompletion(order) {
                if (!order) return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå" };

                if (!order.customer_name || !order.customer_name.trim()) {
                    return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" };
                }
                if (!order.customer_address || !order.customer_address.trim()) {
                    return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏" };
                }

                if (order.channel_code !== 'CLAIM' && order.channel_code !== 'INFU') {
                    if (order.total_amount <= 0) {
                        return { isValid: false, reason: "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" };
                    }
                    if (!order.payment_method) {
                        return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" };
                    }
                    if (order.payment_method === '‡πÇ‡∏≠‡∏ô' && (!order.payment_date || !order.payment_time)) {
                        return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏≠‡∏ô" };
                    }
                }

                if (!order.order_items || order.order_items.length === 0) {
                    return { isValid: false, reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" };
                }

                for (const item of order.order_items) {
                    const product = fullProductList.find(p => p.id === item.product_id);
                    if (!product || !product.product_category) continue;

                    const category = product.product_category.toUpperCase();
                    const productName = product.product_name;

                    const check = (value, fieldName) => {
                        if (!value || !String(value).trim()) {
                            return `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${productName}' ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${fieldName})`;
                        }
                        return null;
                    };

                    let errorReason = null;
                    if (category.includes('STAMP')) {
                        errorReason = check(item.ink_color, '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å') || check(item.cartoon_pattern, '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô') || check(item.line_1, '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1') || check(item.quantity, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                    } else if (category.includes('UV') || category.includes('LASER') || category.includes('TUBE')) {
                        errorReason = check(item.cartoon_pattern, '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô') || check(item.line_1, '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1') || check(item.quantity, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                    } else if (category.includes('STK')) {
                        errorReason = check(item.line_1, '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1') || check(item.quantity, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                    }
                    if (errorReason) return { isValid: false, reason: errorReason };
                }

                return { isValid: true };
            }

            async function saveOrUpdateOrder(status) {
                loadingOverlay.style.display = 'flex';
                const isUpdate = !!currentEditingOrderId;
                try {
                    const oldOrder = isUpdate ? allOrdersData.find(o => o.id === currentEditingOrderId) : null;
                    const effectiveStatusForValidation = status || (oldOrder ? oldOrder.status : null);

                    const channelCode = container.querySelector('#channel_code').value || $('#channel_code').val();
                    const customerName = container.querySelector('#customer_name').value.trim();
                    const customerAddress = container.querySelector('#customer_address').value.trim();
                    const paymentMethod = container.querySelector('#payment_method').value;
                    const paymentDate = container.querySelector('#payment_date').value;
                    const paymentTime = container.querySelector('#payment_time').value;
                    const totalAmount = parseFloat(container.querySelector('#total_amount').value) || 0;

                    if (!customerName) {
                        throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                    }

                    if (effectiveStatusForValidation === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
                        if (!customerAddress) {
                            throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                        }

                        if (channelCode !== 'CLAIM') {
                            if (totalAmount <= 0) {
                                throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏£‡∏≤‡∏Ñ‡∏≤' ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)");
                            }
                            
                            if (!paymentMethod) {
                                throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞");
                            }
                            if (paymentMethod === '‡πÇ‡∏≠‡∏ô') {
                                if (!paymentDate || !paymentTime) {
                                    throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' ‡πÅ‡∏•‡∏∞ '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                                }
                            }
                        }

                        let hasAtLeastOneItem = false;
                        for (const row of itemsTbody.rows) {
                            if ($(row).find('.item-product').select2('data')[0]?.id) {
                                hasAtLeastOneItem = true;
                                break;
                            }
                        }
                        if (!hasAtLeastOneItem) {
                            throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                        }

                        let rowIndex = 1;
                        for (const row of itemsTbody.rows) {
                            const selectedData = $(row).find('.item-product').select2('data')[0];
                            if (!selectedData || !selectedData.id) {
                                rowIndex++;
                                continue;
                            }

                            const product = fullProductList.find(p => p.id == selectedData.id);
                            if (!product || !product.product_category) {
                                rowIndex++;
                                continue;
                            }

                            const category = product.product_category.toUpperCase();
                            const productName = product.product_name;

                            const validateField = (fieldClass, fieldName) => {
                                const element = row.querySelector(`.${fieldClass}`);
                                if (!element || !element.value.trim()) {
                                    throw new Error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${rowIndex} (${productName}): ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '${fieldName}'`);
                                }
                            };
                            
                            if (category.includes('STAMP')) {
                                validateField('item-ink_color', '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å');
                                validateField('item-cartoon_pattern', '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô');
                                validateField('item-line_1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1');
                                validateField('item-quantity', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                            } else if (category.includes('UV') || category.includes('LASER') || category.includes('TUBE')) {
                                validateField('item-cartoon_pattern', '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô');
                                validateField('item-line_1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1');
                                validateField('item-quantity', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                            } else if (category.includes('STK')) {
                                validateField('item-line_1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1');
                                validateField('item-quantity', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                            }
                            
                            rowIndex++;
                        }
                    }

                    if (!isUpdate && !channelCode) {
                        throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                    }

                    let billNo;
                    let currentStatus = status;

                    if (!isUpdate) {
                        billNo = await generateNextBillNo(channelCode);
                        currentStatus = status;
                    } else {
                        billNo = oldOrder.bill_no;
                        currentStatus = status || oldOrder.status;
                    }

                    const orderData = {
                        channel_code: channelCode,
                        bill_no: billNo,
                        status: currentStatus,
                        price: parseFloat(container.querySelector('#price').value) || 0,
                        shipping_cost: parseFloat(container.querySelector('#shipping_cost').value) || 0,
                        discount: parseFloat(container.querySelector('#discount').value) || 0,
                        total_amount: totalAmount,
                        payment_method: paymentMethod,
                        promotion: ($('#promotion').val() || '').trim(),
                        payment_date: paymentDate || null,
                        payment_time: paymentTime || null,
                        customer_name: customerName,
                        customer_address: customerAddress
                    };

                    if (channelCode === 'CLAIM') {
                        orderData.claim_type = document.getElementById('claim_type').value.trim();
                        orderData.claim_details = document.getElementById('claim_details').value.trim();
                    }

                    const taxInvoiceData = {
                        request_tax_invoice: requestTaxInvoiceCb.checked,
                        request_cash_bill: requestCashBillCb.checked,
                        tax_customer_name: document.getElementById('tax-customer-name').value,
                        tax_customer_address: document.getElementById('tax-customer-address').value,
                        tax_id: document.getElementById('tax-id').value,
                        tax_items: []
                    };
                    if(requestTaxInvoiceCb.checked || requestCashBillCb.checked) {
                        taxItemsTbody.querySelectorAll('tr').forEach(row => {
                            taxInvoiceData.tax_items.push({
                                product_name: row.cells[0].textContent,
                                quantity: parseInt(row.querySelector('.tax-item-qty').value),
                                unit_price: parseFloat(row.querySelector('.tax-item-unit-price').value)
                            });
                        });
                    }
                    orderData.billing_details = taxInvoiceData;

                    let targetOrderId = currentEditingOrderId;
                    if (isUpdate) {
                        const { error } = await supabaseClient.from('orders').update(orderData).eq('id', currentEditingOrderId);
                        if (error) throw error;
                    } else {
                        orderData.admin_user = adminUserInput.value;
                        orderData.entry_date = new Date().toISOString().slice(0, 10);
                        const { data: insertedOrder, error } = await supabaseClient.from('orders').insert(orderData).select().single();
                        if (error) throw error;
                        targetOrderId = insertedOrder.id;
                    }

                    if (currentStatus !== '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß') {
                        await supabaseClient.from('order_items').delete().eq('order_id', targetOrderId);
                        
                        let allItemsToInsert = [];
                        let itemSequence = 1;
                        for (const row of itemsTbody.rows) {
                            const selectedData = $(row).find('.item-product').select2('data')[0];
                            if (!selectedData || !selectedData.id) continue;
                            
                            const originalProduct = fullProductList.find(p => p.id == selectedData.id);
                            const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                            
                            const baseItemData = {
                                order_id: targetOrderId, 
                                bill_no: billNo, 
                                product_id: originalProduct.id,
                                product_name: originalProduct.product_name,
                                ink_color: row.querySelector('.item-ink_color').value,
                                product_type: row.querySelector('.item-shelf_location').value,
                                cartoon_pattern: row.querySelector('.item-cartoon_pattern').value,
                                line_pattern: row.querySelector('.item-line_pattern').value,
                                font: row.querySelector('.item-font').value,
                                line_1: row.querySelector('.item-line_1').value,
                                line_2: row.querySelector('.item-line_2').value,
                                line_3: row.querySelector('.item-line_3').value,
                                notes: row.querySelector('.item-notes').value,
                                file_attachment: row.querySelector('.item-file_attachment').value
                            };
                            
                            for (let i = 0; i < quantity; i++) {
                                allItemsToInsert.push({ 
                                    ...baseItemData, 
                                    item_uid: `${billNo}-${itemSequence++}` 
                                });
                            }
                        }
                        
                        if (allItemsToInsert.length > 0) {
                            const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert);
                            if (itemsError) throw itemsError;
                        }
                    }

                    alert(isUpdate ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${billNo}`);
                    setFormMode('create');
                    if (window.orderSystem) window.orderSystem.loadInitialData(true);

                } catch (error) {
                    console.error('Save error:', error);
                    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function enterTrackingEditMode(trackingSpan) { 
                const orderItem = trackingSpan.closest('.order-list-item');
                const orderId = orderItem.dataset.orderId;
                
                const trackingTextEl = trackingSpan.querySelector('.tracking-text'); 
                const currentText = trackingTextEl ? trackingTextEl.textContent : ''; 
                
                // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏≠ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏" ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Input ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                const inputValue = (currentText === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏') ? '' : currentText;
                
                trackingSpan.dataset.originalHtml = trackingSpan.innerHTML; 
                trackingSpan.innerHTML = `
                    <div class="tracking-edit-container">
                        <input type="text" class="tracking-input" value="${inputValue}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏...">
                        <button class="btn btn-sm btn-success btn-save-tracking-confirm">‚úì</button>
                        <button class="btn btn-sm btn-secondary btn-cancel-tracking-edit">X</button>
                    </div>`; 
                trackingSpan.querySelector('.tracking-input').focus(); 
            }

            function exitTrackingEditMode(trackingSpan, newTrackingNumber = null) { 
                const orderItem = trackingSpan.closest('.order-list-item'); 
                const orderId = orderItem.dataset.orderId;
                const orderData = allOrdersData.find(o => String(o.id) === String(orderId));
                
                // ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å Database
                let finalTracking = newTrackingNumber !== null ? newTrackingNumber : (orderData ? orderData.tracking_number : null); 
                
                const displayText = finalTracking || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏';
                const displayStyle = finalTracking ? '' : 'color: #ccc;';

                trackingSpan.innerHTML = `
                    <span class="tracking-text" style="${displayStyle}">${displayText}</span> 
                    <button class="btn btn-sm btn-edit-tracking" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏">‚úèÔ∏è</button>
                `; 
            }
            async function saveTrackingNumber(trackingSpan) { const orderItem = trackingSpan.closest('.order-list-item'); const orderId = orderItem.dataset.orderId; const newTrackingNumber = trackingSpan.querySelector('.tracking-input').value.trim(); if (!newTrackingNumber) { alert('‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á'); return; } loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ tracking_number: newTrackingNumber }).eq('id', orderId); if (error) throw error; alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); } catch (error) { console.error('Error updating tracking:', error); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); exitTrackingEditMode(trackingSpan); } finally { loadingOverlay.style.display = 'none'; } }
            async function generateNextBillNo(channelCode) { const today = new Date(); const year = String(today.getFullYear() + 543).slice(-2); const month = String(today.getMonth() + 1).padStart(2, '0'); const prefix = `${channelCode}${year}${month}`; const { data, error } = await supabaseClient.from('orders').select('bill_no').like('bill_no', `${prefix}%`).order('bill_no', { ascending: false }).limit(1); if (error) throw new Error(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏¥‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`); let nextSequence = 1; if (data.length > 0) { const lastBillNo = data[0].bill_no; const lastSequence = parseInt(lastBillNo.slice(prefix.length), 10); if (!isNaN(lastSequence)) { nextSequence = lastSequence + 1; } } return `${prefix}${String(nextSequence).padStart(5, '0')}`; }
            
            function calculateTotal() {
                const price = parseFloat(container.querySelector('#price').value) || 0;
                const shipping = parseFloat(container.querySelector('#shipping_cost').value) || 0;
                const discount = parseFloat(container.querySelector('#discount').value) || 0;
                
                const preTaxBase = price + shipping - discount;
                let total = preTaxBase; 
                let vat = 0;

                if (requestTaxInvoiceCb.checked) {
                    vat = preTaxBase * 0.07;
                    total = preTaxBase + vat;
                    
                    vatAmountInput.value = vat.toFixed(2);
                    vatDisplayContainer.style.display = 'block';
                } else {
                    vatAmountInput.value = '0.00';
                    vatDisplayContainer.style.display = 'none';
                }

                container.querySelector('#total_amount').value = total.toFixed(2);
            }

            function exportForProduction(workOrderName) {
                const ordersInWorkOrder = allOrdersData
                    .filter(order => order.work_order_name === workOrderName)
                    .sort((a, b) => (a.bill_no || '').localeCompare(b.bill_no || ''));

                if (ordersInWorkOrder.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    return;
                }
                const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Item UID', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å', '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà', '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô', '‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô', '‡∏ü‡∏≠‡∏ô‡∏ï‡πå', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'];
                const dataToExport = [];
                
                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Spreadsheet ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô)
                const forceText = (val) => {
                    const str = String(val || '').trim();
                    if (str === '') return '';
                    // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ + ‡∏´‡∏£‡∏∑‡∏≠ 0 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° Zero Width Space (\u200B) ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
                    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Excel ‡πÑ‡∏°‡πà‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£
                    if (str.startsWith('+') || str.startsWith('0')) {
                        return "\u200B" + str; 
                    }
                    return str;
                };

                ordersInWorkOrder.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const cleanNotes = (item.notes || '').replace(/\[SET-.*?\]/g, '').trim();
                            dataToExport.push([
                                workOrderName, 
                                item.bill_no, 
                                item.item_uid, 
                                item.product_name,
                                item.ink_color, 
                                item.product_type, 
                                item.cartoon_pattern, 
                                item.line_pattern,
                                item.font, 
                                forceText(item.line_1),
                                forceText(item.line_2),
                                forceText(item.line_3),
                                1,
                                cleanNotes,
                                item.file_attachment
                            ]);
                        });
                    }
                });

                if (dataToExport.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                    return;
                }

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);

                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô String
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    for (let C = 9; C <= 11; ++C) {
                        const cell_address = XLSX.utils.encode_cell({r: R, c: C});
                        if (!worksheet[cell_address]) continue;
                        worksheet[cell_address].t = 's';
                    }
                }

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ProductionData");
                XLSX.writeFile(workbook, `Production_${workOrderName}.xlsx`);
            }

            function exportForQC(workOrderName) {
                const ordersInWorkOrder = allOrdersData
                    .filter(order => order.work_order_name === workOrderName)
                    .sort((a, b) => (a.bill_no || '').localeCompare(b.bill_no || ''));

                if (ordersInWorkOrder.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    return;
                }
                
                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏π‡∏ï‡∏£ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô)
                const forceText = (val) => {
                    const str = String(val || '').trim();
                    if (str === '') return '';
                    if (str.startsWith('+') || str.startsWith('0')) {
                        return "\u200B" + str;
                    }
                    return str;
                };

                const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Item UID', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å', '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà', '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô', '‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô', '‡∏ü‡∏≠‡∏ô‡∏ï‡πå', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'];
                const dataToExport = [];

                ordersInWorkOrder.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const cleanNotes = (item.notes || '').replace(/\[SET-.*?\]/g, '').trim();
                            const productDetails = fullProductList.find(p => p.id === item.product_id);
                            const productCode = productDetails ? productDetails.product_code : 'N/A';
                            const productCategory = productDetails ? productDetails.product_category : 'N/A';

                            dataToExport.push([
                                workOrderName, 
                                item.bill_no, 
                                item.item_uid, 
                                productCode,
                                item.product_name,
                                productCategory,
                                item.ink_color, 
                                item.product_type, 
                                item.cartoon_pattern, 
                                item.line_pattern,
                                item.font, 
                                forceText(item.line_1), // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1
                                forceText(item.line_2), // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2
                                forceText(item.line_3), // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3
                                1,
                                cleanNotes,
                                item.file_attachment
                            ]);
                        });
                    }
                });

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);

                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1, 2, 3 ‡πÄ‡∏õ‡πá‡∏ô String (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå L, M, N ‡∏´‡∏£‡∏∑‡∏≠ index 11, 12, 13)
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    for (let C = 11; C <= 13; ++C) {
                        const cell_address = XLSX.utils.encode_cell({r: R, c: C});
                        if (!worksheet[cell_address]) continue;
                        worksheet[cell_address].t = 's';
                    }
                }

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "QC_Data");
                XLSX.writeFile(workbook, `QC_${workOrderName}.xlsx`);
            }

	function exportForBarcode(workOrderName) {
                const ordersInWorkOrder = allOrdersData
                    .filter(order => order.work_order_name === workOrderName);

                if (ordersInWorkOrder.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    return;
                }

                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏π‡∏ï‡∏£ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô)
                const forceText = (val) => {
                    const str = String(val || '').trim();
                    if (str === '') return '';
                    if (str.startsWith('+') || str.startsWith('0')) {
                        return "\u200B" + str;
                    }
                    return str;
                };

                const headers = ['Item UID', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1', '‡∏´‡∏°‡∏ß‡∏î'];
                const dataToExport = [];

                ordersInWorkOrder.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const productDetails = fullProductList.find(p => p.id === item.product_id);
                            const category = productDetails ? (productDetails.product_category || 'N/A') : 'N/A';

                            dataToExport.push([
                                item.item_uid,
                                item.product_name,
                                item.ink_color,
                                forceText(item.line_1), // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1
                                category
                            ]);
                        });
                    }
                });

                if (dataToExport.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                    return;
                }

                const csvContent = "\uFEFF" + [headers, ...dataToExport].map(e => e.map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Barcode_${workOrderName}.csv`;
                link.click();
            }
            
            function exportShippedData() {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-shipped .order-list'));
                if (selectedIds.length === 0) {
                    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export');
                }
                const ordersToExport = allOrdersData.filter(order => selectedIds.includes(String(order.id)));
                
                const headers = ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', '‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', 'Item UID', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏•‡∏°', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏•‡∏°'];

                const dataToExport = [];
                ordersToExport.forEach(order => {
                    const shippedTime = order.shipped_time ? new Date(order.shipped_time).toLocaleString('th-TH') : 'N/A';
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const cleanNotes = (item.notes || '').replace(/\[SET-.*?\]/g, '').trim();
                            const details = [item.line_1, item.line_2, item.line_3, item.font, item.ink_color, cleanNotes].filter(Boolean).join(" | ");
                            
                            dataToExport.push([ order.bill_no, order.customer_name, order.tracking_number, order.shipped_by, shippedTime, item.item_uid, item.product_name, details, order.claim_type || '', order.claim_details || '' ]);
                        });
                    } else {
                        dataToExport.push([ order.bill_no, order.customer_name, order.tracking_number, order.shipped_by, shippedTime, 'N/A', 'N/A', 'N/A', order.claim_type || '', order.claim_details || '' ]);
                    }
                });
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Shipped Data");
                XLSX.writeFile(workbook, `ShippedData_${new Date().toISOString().slice(0,10)}.xlsx`);
            }
            
            function openCarrierSelection() {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-shipped .order-list'));
                if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export');
                document.getElementById('carrier-selection-modal').style.display = 'flex';
            }

            function processTrackingExport() {
                const carrierName = $('#carrier-select').val();
                if (!carrierName) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á');

                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-shipped .order-list'));
                const ordersToExport = allOrdersData.filter(order => selectedIds.includes(String(order.id)));

                const headers = ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Trackno', '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á'];
                const rows = ordersToExport.map(order => [
                    order.bill_no,
                    order.tracking_number || '',
                    carrierName
                ]);

                const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Tracking_${carrierName}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                document.getElementById('carrier-selection-modal').style.display = 'none';
            }

            function exportMasterStatusReport() {
                const startDate = document.getElementById('master-status-start-date').value;
                const endDate = document.getElementById('master-status-end-date').value;

                if (!startDate || !endDate) {
                    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°');
                }

                const statusesToExport = ['‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)', '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'];
                
                const ordersToExport = allOrdersData.filter(order => {
                    const statusMatch = statusesToExport.includes(order.status);
                    
                    const createdDate = order.created_at ? order.created_at.substring(0, 10) : null;
                    const scanDate = (order.packing_meta && order.packing_meta.scanTime) ? order.packing_meta.scanTime.substring(0, 10) : null;

                    const isNewOrder = (createdDate >= startDate && createdDate <= endDate);
                    const isScannedInRange = (scanDate >= startDate && scanDate <= endDate);

                    const dateMatch = isNewOrder || isScannedInRange;
                    
                    return statusMatch && dateMatch;
                });

                if (ordersToExport.length === 0) {
                    return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                }
                
                loadingOverlay.style.display = 'flex';

                try {
                    const headers = ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Item UID', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡πà‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏•‡∏°', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏•‡∏°'];
                    const dataToExport = [];

                    ordersToExport.forEach(order => {
                        const createdDate = order.created_at ? order.created_at.substring(0, 10) : null;
                        const scanDate = (order.packing_meta && order.packing_meta.scanTime) ? order.packing_meta.scanTime.substring(0, 10) : null;
                        
                        let displayStatus = order.status;
                        if (order.status === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' && scanDate) {
                            if ((scanDate >= startDate && scanDate <= endDate) && (createdDate < startDate)) {
                                displayStatus = '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô)';
                            }
                        }

                        if (order.order_items && order.order_items.length > 0) {
                            order.order_items.forEach(item => {
                                const productDetails = fullProductList.find(p => p.id === item.product_id);
                                const category = productDetails ? productDetails.product_category : 'N/A';
                                
                                const cleanNotes = (item.notes || '').replace(/\[SET-.*?\]/g, '').trim();
                                const details = [item.line_1, item.line_2, item.line_3, item.font, item.ink_color, cleanNotes].filter(Boolean).join(" | ");

                                dataToExport.push([
                                    order.bill_no,
                                    item.item_uid,
                                    item.product_name,
                                    category,
                                    details,
                                    displayStatus,
                                    scanDate ? new Date(order.packing_meta.scanTime).toLocaleString('th-TH') : '-',
                                    order.claim_type || '',
                                    order.claim_details || ''
                                ]);
                            });
                        }
                    });

                    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Master Status Report");

                    worksheet['!cols'] = [
                        { wch: 20 }, { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 50 }, { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 40 }
                    ];

                    XLSX.writeFile(workbook, `Master_Status_Report_${startDate}_to_${endDate}.xlsx`);

                } catch (err) {
                    console.error("Master Export Error:", err);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£ Export: " + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function attachFormActionListeners(order) { 
                const idMap = { 
                    'save-waiting-btn': () => saveOrUpdateOrder('‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'), 
                    'save-complete-btn': () => saveOrUpdateOrder('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'), 
                    'update-waiting-btn': () => saveOrUpdateOrder(null), 
                    'move-to-complete-btn': () => saveOrUpdateOrder('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'), 
                    'update-complete-btn': () => saveOrUpdateOrder(null), 
                    'cancel-bill-btn': () => moveOrder(order.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'), 
                    'update-work-order-bill-btn': () => saveOrUpdateOrder(null),
                    'update-payment-only-btn': () => saveOrUpdateOrder(null)
                }; 
                for(const id in idMap) { const btn = document.getElementById(id); if (btn) btn.addEventListener('click', idMap[id]); } 
            }
            function checkAndApplyStampInkLogic(rowElement) { const linkedInkRowUid = rowElement.dataset.linkedInkRowUid; if (linkedInkRowUid) { const oldInkRow = itemsTbody.querySelector(`tr[data-row-uid="${linkedInkRowUid}"]`); if (oldInkRow) { $(oldInkRow).find('.item-product').select2('destroy'); oldInkRow.remove(); } } rowElement.removeAttribute('data-linked-ink-row-uid'); const productId = $(rowElement).find('.item-product').val(); const inkColor = $(rowElement).find('.item-ink_color').val(); const product = fullProductList.find(p => p.id == productId); if (!product || !product.product_category || !product.product_category.toUpperCase().includes('STAMP')) { return; } const targetColors = { '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡∏î‡∏≥': '‡∏î‡∏≥', '‡πÅ‡∏î‡∏á': '‡πÅ‡∏î‡∏á', '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô': '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô' }; const matchedColor = Object.keys(targetColors).find(c => inkColor.includes(c) && inkColor.includes('‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å')); if (!matchedColor) { return; } const inkProductName = `‡∏´‡∏°‡∏∂‡∏Å‡πÅ‡∏ü‡∏•‡∏ä‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å 5 ml. (${matchedColor})`; const inkProductToAdd = fullProductList.find(p => p.product_name === inkProductName); if (!inkProductToAdd) { console.warn(`Could not find product: ${inkProductName}`); return; } const newInkRowUid = 'ink-' + Date.now() + Math.random(); const newInkRow = addItemRow({ product_id: inkProductToAdd.id, quantity: 1 }, newInkRowUid); newInkRow.dataset.isAutoAdded = "true"; newInkRow.style.backgroundColor = '#f0fff0'; rowElement.dataset.linkedInkRowUid = newInkRowUid; }
            
            function addCondoStampSet(productId) {
                if (window.isExpandingCondo) return;
                window.isExpandingCondo = true;
                
                const productData = { product_id: productId };
                const groupId = 'condo-group-' + Date.now();

                for (let i = 1; i <= 5; i++) {
                    const newItemRow = addItemRow(productData);
                    newItemRow.querySelector('.item-shelf_location').value = i.toString();
                    newItemRow.dataset.isCondoPart = 'true';
                    newItemRow.dataset.condoGroupId = groupId; 
                    const qtyInput = newItemRow.querySelector('.item-quantity');
                    qtyInput.value = 1;
                    qtyInput.readOnly = true;
                }
                
                setTimeout(() => { window.isExpandingCondo = false; }, 100);
            }

            function handleCondoStampExpansion(changedRow) { 
                if (changedRow.dataset.isCondoPart || changedRow.dataset.condoGroupId) return; 
                const productId = $(changedRow).find('.item-product').val(); 
                if (!productId) return; 
                const product = fullProductList.find(p => p.id == productId); 
                if (product && product.product_category && product.product_category.trim().toUpperCase() === 'CONDO STAMP') { 
                    if (window.isExpandingCondo) return; 
                    window.isExpandingCondo = true; 
                    const templateItem = { product_id: product.id }; 
                    const groupId = 'condo-group-' + Date.now();
                    
                    changedRow.querySelector('.item-shelf_location').value = '1'; 
                    changedRow.dataset.isCondoPart = 'true'; 
                    changedRow.dataset.condoGroupId = groupId;
                    const qtyInput = changedRow.querySelector('.item-quantity'); 
                    qtyInput.value = 1; 
                    qtyInput.readOnly = true; 
                    
                    for (let i = 2; i <= 5; i++) { 
                        const newItemRow = addItemRow(templateItem); 
                        newItemRow.querySelector('.item-shelf_location').value = i.toString(); 
                        newItemRow.dataset.isCondoPart = 'true';
                        newItemRow.dataset.condoGroupId = groupId;
                        const newQtyInput = newItemRow.querySelector('.item-quantity'); 
                        newQtyInput.value = 1; 
                        newQtyInput.readOnly = true; 
                    } 
                    setTimeout(() => { window.isExpandingCondo = false; }, 100); 
                } 
            }

            function handleBillingRequest(event) {
                const taxChecked = requestTaxInvoiceCb.checked;
                const cashChecked = requestCashBillCb.checked;

                if (taxChecked || cashChecked) {
                    taxInvoiceSection.style.display = 'block';
                    document.getElementById('tax-id').closest('.form-group').style.display = taxChecked ? 'block' : 'none';
                    populateTaxItems();
                    
                    taxCustomerNameInput.value = document.getElementById('customer_name').value;
                    taxCustomerAddressInput.value = document.getElementById('customer_address').value;

                } else {
                    taxInvoiceSection.style.display = 'none';
                }
                calculateTotal(); 
            }
            
            function populateTaxItems(savedTaxItems = null) {
                const existingPrices = {};
                taxItemsTbody.querySelectorAll('tr').forEach(row => {
                    const productName = row.cells[0].textContent;
                    const unitPrice = row.querySelector('.tax-item-unit-price').value;
                    if (productName) {
                        existingPrices[productName] = unitPrice;
                    }
                });

                taxItemsTbody.innerHTML = '';

                if (savedTaxItems && savedTaxItems.length > 0) {
                    savedTaxItems.forEach(item => {
                        addTaxRow(item.product_name, item.quantity, item.unit_price);
                    });
                } else {
                    const aggregatedItems = {};
                    itemsTbody.querySelectorAll('tr').forEach(row => {
                        const productId = $(row.querySelector('.item-product')).val();
                        const productName = $(row.querySelector('.item-product')).select2('data')[0]?.text;
                        const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;

                        if (productId && productName && quantity > 0) {
                            if (!aggregatedItems[productId]) {
                                const product = fullProductList.find(p => p.id == productId);
                                const category = product ? (product.product_category || '').trim().toUpperCase() : '';
                                aggregatedItems[productId] = { name: productName, qty: 0, category: category };
                            }
                            aggregatedItems[productId].qty += quantity;
                        }
                    });

                    // 1. ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    Object.values(aggregatedItems).forEach(item => {
                        let displayQty = item.qty;
                        if (item.category === 'CONDO STAMP') {
                            displayQty = Math.ceil(item.qty / 5);
                        }
                        const savedPrice = existingPrices[item.name] || '0.00';
                        addTaxRow(item.name, displayQty, savedPrice);
                    });

                    // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß "‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á > 0)
                    const shippingCost = parseFloat(container.querySelector('#shipping_cost').value) || 0;
                    if (shippingCost > 0) {
                        addTaxRow("‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", 1, shippingCost.toFixed(2));
                    }

                    // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î > 0) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á
                    const discount = parseFloat(container.querySelector('#discount').value) || 0;
                    if (discount > 0) {
                        addTaxRow("‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", 1, (-discount).toFixed(2));
                    }
                }
                calculateTaxItemTotals();
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            function addTaxRow(name, qty, unitPrice) {
                const row = taxItemsTbody.insertRow();
                const priceNum = parseFloat(unitPrice);
                const isDiscount = priceNum < 0;
                
                row.innerHTML = `
                    <td style="${isDiscount ? 'color: red; font-weight: bold;' : ''}">${name}</td>
                    <td><input type="number" class="tax-item-qty" value="${qty}" readonly></td>
                    <td><input type="number" class="tax-item-unit-price" value="${unitPrice}" step="0.01" style="${isDiscount ? 'color: red;' : ''}"></td>
                    <td class="tax-item-total" style="text-align: right; ${isDiscount ? 'color: red;' : ''}">0.00</td>
                `;
            }

            function calculateTaxItemTotals() {
                let subtotal = 0;
                taxItemsTbody.querySelectorAll('tr').forEach(row => {
                    const qty = parseInt(row.querySelector('.tax-item-qty').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.tax-item-unit-price').value) || 0;
                    const total = qty * unitPrice;
                    row.querySelector('.tax-item-total').textContent = total.toFixed(2);
                    subtotal += total;
                });
            }


            function showPickingSlipModal(workOrderName) {
            const modal = document.getElementById('picking-slip-modal');
            const modalTitle = document.getElementById('picking-slip-modal-title');
            const previewContainer = document.getElementById('picking-slip-preview');
            const pngContainer = document.getElementById('picking-slip-png-container');
            modalTitle.textContent = `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å: ${workOrderName}`;

            const itemsInWorkOrder = [];
            allOrdersData.forEach(order => {
                if (order.work_order_name === workOrderName && order.order_items) {
                    order.order_items.forEach(item => {
                        const fullProduct = fullProductList.find(p => p.id === item.product_id);
                        itemsInWorkOrder.push({ ...item, ...fullProduct });
                    });
                }
            });

            if (itemsInWorkOrder.length === 0) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }

            const mainItemsMap = {};
            const excludedCategories = ['UV', 'STK', 'TUBE']; 
            
            itemsInWorkOrder.filter(item => {
                const cat = (item.product_category || '').toUpperCase();
                return !excludedCategories.some(ex => cat.includes(ex));
            }).forEach(item => {
                const key = item.product_id;
                if (!mainItemsMap[key]) {
                    mainItemsMap[key] = {
                        woName: workOrderName,
                        code: item.product_code || 'N/A',
                        name: item.product_name,
                        location: item.storage_location || 'N/A',
                        category: (item.product_category || '').toUpperCase(),
                        qty: 0
                    };
                }
                mainItemsMap[key].qty += 1;
            });

            const finalMainList = Object.values(mainItemsMap).map(item => {
                let displayQty = item.qty;
                if (item.category.includes('CONDO STAMP')) {
                    displayQty = Math.ceil(item.qty / 5);
                }
                return { ...item, finalQty: displayQty };
            }).sort((a, b) => a.location.localeCompare(b.location));

            const sparePartsMap = {};
            itemsInWorkOrder.forEach(item => {
                if (item.rubber_code) {
                    const key = item.rubber_code;
                    if (!sparePartsMap[key]) {
                        sparePartsMap[key] = { name: `‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏≤‡∏á+‡πÇ‡∏ü‡∏° ${item.rubber_code}`, qty: 0 };
                    }
                    sparePartsMap[key].qty += 1;
                }
            });
            const finalSpareList = Object.values(sparePartsMap);

            const today = new Date().toLocaleDateString('th-TH');
            const renderHtmlTables = (isForPNG = false) => {
                const style = isForPNG ? '' : 'border: 1px solid #ddd; padding: 6px; font-size: 12px;';
                const tableStyle = isForPNG ? '' : 'style="width: 100%; border-collapse: collapse; margin-bottom: 20px;"';
                
                let html = `<div>`;
                if(isForPNG) {
                    html += `<div style="display:flex; justify-content:space-between; border-bottom:2px solid black; padding-bottom:5px; margin-bottom:15px; font-size: 13px;">
                                <b>‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${workOrderName}</b> <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${today}</b>
                             </div>`;
                }

                html += `<h3 style="margin-top:0;">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h3><table ${tableStyle}>
                    <thead><tr style="background:#f2f2f2;">
                        <th style="${style} width:25%;">‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö</th><th style="${style} width:20%;">‡∏£‡∏´‡∏±‡∏™</th><th style="${style} width:40%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="${style} width:15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    </tr></thead><tbody>`;
                finalMainList.forEach(item => {
                    html += `<tr><td style="${style}">${item.location}</td><td style="${style}">${item.code}</td><td style="${style}">${item.name}</td><td style="${style} text-align:center;">${item.finalQty}</td></tr>`;
                });
                html += `</tbody></table>`;

                if(finalSpareList.length > 0) {
                    html += `<h3>üîß ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏≤‡∏á/‡πÇ‡∏ü‡∏°)</h3><table ${tableStyle}>
                        <thead><tr style="background:#f2f2f2;"><th style="${style}">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th><th style="${style} width:20%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead><tbody>`;
                    finalSpareList.forEach(spare => {
                        html += `<tr><td style="${style}">${spare.name}</td><td style="${style} text-align:center;">${spare.qty}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                }

                if(isForPNG) {
                    html += `<div style="display:flex; justify-content:space-between; margin-top:auto; padding-top:10px;">
                                <div style="border:1px solid black; width:48%; height:65px; display:flex; flex-direction:column; justify-content:space-between; padding:5px;">
                                    <div style="text-align:center; font-size:12px; font-weight:bold;">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å (Requester)</div>
                                    <div style="border-bottom:1px dotted black; margin: 0 10px 5px 10px; height: 30px;"></div>
                                </div>
                                <div style="border:1px solid black; width:48%; height:65px; display:flex; flex-direction:column; justify-content:space-between; padding:5px;">
                                    <div style="text-align:center; font-size:12px; font-weight:bold;">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢ (Issuer)</div>
                                    <div style="border-bottom:1px dotted black; margin: 0 10px 5px 10px; height: 30px;"></div>
                                </div>
                             </div>`;
                }
                html += `</div>`;
                return html;
            };
            previewContainer.innerHTML = renderHtmlTables(false);
            pngContainer.innerHTML = renderHtmlTables(true);

            document.getElementById('export-all-picking-btn').onclick = () => {
                exportAllPickingFinal(finalMainList, finalSpareList, workOrderName);
            };

            modal.style.display = 'flex';
        }

        function hidePickingSlipModal() { document.getElementById('picking-slip-modal').style.display = 'none'; }

        async function exportAllPickingFinal(mainData, spareData, workOrderName) {
            loadingOverlay.style.display = 'flex';
            try {
                const canvas = await html2canvas(document.getElementById("picking-slip-png-container"), { scale: 3 });
                const pngLink = document.createElement('a');
                pngLink.download = `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å_${workOrderName}.png`;
                pngLink.href = canvas.toDataURL("image/png");
                pngLink.click();

                const wb = XLSX.utils.book_new();
                
                const ws1Headers = [['‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å']];
                const ws1Rows = mainData.map(item => [item.woName, item.code, item.name, item.location, item.finalQty]);
                const ws1 = XLSX.utils.aoa_to_sheet(ws1Headers.concat(ws1Rows));
                XLSX.utils.book_append_sheet(wb, ws1, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏¥‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");

                const ws2Headers = [['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°']];
                const ws2Rows = spareData.map(item => [item.name, item.qty]);
                const ws2 = XLSX.utils.aoa_to_sheet(ws2Headers.concat(ws2Rows));
                XLSX.utils.book_append_sheet(wb, ws2, "‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà");

                XLSX.writeFile(wb, `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å_${workOrderName}.xlsx`);

                const csvHeaders = ['‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å'];
                const csvRows = [csvHeaders.join(',')];
                mainData.forEach(item => {
                    const row = [
                        `"${item.woName}"`, 
                        `"${item.code}"`, 
                        `"${item.name}"`, 
                        `"${item.location}"`, 
                        item.finalQty
                    ];
                    csvRows.push(row.join(','));
                });
                const csvContent = "\uFEFF" + csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const csvLink = document.createElement("a");
                csvLink.href = URL.createObjectURL(blob);
                csvLink.download = `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å_${workOrderName}.csv`;
                csvLink.click();

            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export");
            }
            loadingOverlay.style.display = 'none';
        }
            
            async function handleClaimSelectedOrders() {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-shipped .order-list'));
                if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå');
                if (selectedIds.length > 1) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå');

                const orderId = selectedIds[0];
                const originalOrder = allOrdersData.find(o => String(o.id) === orderId);
                if (!originalOrder) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°');

                const originalBillNo = originalOrder.bill_no.replace(/^C\d*-/, '');

                try {
                    loadingOverlay.style.display = 'flex';
                    const { data: existingTypesData, error: typesError } = await supabaseClient
                        .from('orders')
                        .select('claim_type')
                        .not('claim_type', 'is', null)
                        .neq('claim_type', '');
                        
                    if (typesError) throw typesError;

                    const existingTypes = [...new Set(existingTypesData.map(item => item.claim_type))].sort();

                    const modal = document.getElementById('claim-details-modal');
                    const form = document.getElementById('claim-details-form');
                    const typeSelect = document.getElementById('claim-type-select');
                    const newTypeGroup = document.getElementById('new-claim-type-group');
                    const newTypeInput = document.getElementById('new-claim-type-input');
                    const detailsTextarea = document.getElementById('claim-details-textarea');
                    const cancelBtn = document.getElementById('cancel-claim-modal-btn');
                    const modalTitle = document.getElementById('claim-modal-title');

                    form.reset();
                    modalTitle.textContent = `‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${originalBillNo}`;
                    typeSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>';
                    existingTypes.forEach(type => {
                        typeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                    typeSelect.innerHTML += '<option value="new">-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà --</option>';
                    newTypeGroup.style.display = 'none';
                    
                    typeSelect.onchange = () => {
                        newTypeGroup.style.display = typeSelect.value === 'new' ? 'block' : 'none';
                    };
                    
                    modal.style.display = 'flex';
                    loadingOverlay.style.display = 'none';

                    const claimData = await new Promise((resolve, reject) => {
                        const submitHandler = (e) => {
                            e.preventDefault();
                            const claim_type = typeSelect.value === 'new' ? newTypeInput.value.trim() : typeSelect.value;
                            if (!claim_type) {
                                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°');
                                return;
                            }
                            const claim_details = detailsTextarea.value.trim();
                            
                            form.removeEventListener('submit', submitHandler);
                            cancelBtn.removeEventListener('click', cancelHandler);
                            modal.style.display = 'none';
                            resolve({ claim_type, claim_details });
                        };

                        const cancelHandler = () => {
                            form.removeEventListener('submit', submitHandler);
                            cancelBtn.removeEventListener('click', cancelHandler);
                            modal.style.display = 'none';
                            reject(new Error('User cancelled'));
                        };
                        
                        form.addEventListener('submit', submitHandler);
                        cancelBtn.addEventListener('click', cancelHandler);
                    });
                    
                    loadingOverlay.style.display = 'flex';
                    const existingClaims = allOrdersData.filter(o => o.bill_no.endsWith(`-${originalBillNo}`) && o.bill_no.startsWith('C'));
                    const nextClaimNumber = existingClaims.length + 1;
                    const newBillNo = `C${nextClaimNumber}-${originalBillNo}`;

                    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${originalBillNo}?\n‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà: ${newBillNo}\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${claimData.claim_type}`)) {
                        loadingOverlay.style.display = 'none';
                        return;
                    }
                    
                    const claimOrderData = {
                        ...originalOrder,
                        channel_code: 'CLAIM',
                        bill_no: newBillNo,
                        status: '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        price: 0,
                        shipping_cost: 0,
                        discount: 0,
                        total_amount: 0,
                        payment_method: null,
                        payment_date: null,
                        payment_time: null,
                        promotion: null,
                        work_order_name: null,
                        shipped_by: null,
                        shipped_time: null,
                        tracking_number: null,
                        created_at: new Date().toISOString(),
                        entry_date: new Date().toISOString().slice(0, 10),
                        admin_user: loggedInUsername,
                        claim_type: claimData.claim_type,
                        claim_details: claimData.claim_details
                    };

                    delete claimOrderData.id;
                    delete claimOrderData.order_items;

                    const { data: insertedOrder, error: orderError } = await supabaseClient.from('orders').insert(claimOrderData).select().single();
                    if (orderError) throw orderError;

                    const originalItems = originalOrder.order_items || [];
                    if (originalItems.length > 0) {
                        let itemSequence = 1;
                        const claimItemsToInsert = originalItems.map(item => {
                            const newItem = { ...item };
                            delete newItem.id;
                            newItem.order_id = insertedOrder.id;
                            newItem.bill_no = newBillNo;
                            newItem.item_uid = `${newBillNo}-${itemSequence++}`;
                            newItem.item_scan_time = null;
                            newItem.packing_status = null;
                            return newItem;
                        });
                        const { error: itemsError } = await supabaseClient.from('order_items').insert(claimItemsToInsert);
                        if (itemsError) {
                            await supabaseClient.from('orders').delete().eq('id', insertedOrder.id);
                            throw itemsError;
                        }
                    }
                    
                    alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${newBillNo}\n‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"`);

                } catch (error) {
                    if (error.message !== 'User cancelled') {
                        console.error('Error creating claim:', error);
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                    }
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function selectAll(tabKey) {
                const listContainer = container.querySelector(`#tab-${tabKey} .order-list`);
                if (!listContainer) return;
                const checkboxes = listContainer.querySelectorAll('.order-checkbox');
                if (checkboxes.length === 0) return;
                const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => {
                    cb.checked = !isAllChecked;
                });
            }

            function initializeEventListeners() {
                if (eventListenersInitialized) return;
                const today = new Date().toISOString().split('T')[0];
	            document.getElementById('master-status-start-date').value = today;
	            document.getElementById('master-status-end-date').value = today;

                document.getElementById('export-master-status-btn').addEventListener('click', exportMasterStatusReport);
                container.querySelector('#channel-summary-container').addEventListener('click', (e) => { if (e.target.matches('.channel-summary-item')) { const channel = e.target.dataset.channel; container.querySelector('#filter-complete').value = channel; renderAllTabs(); } });
                
                document.getElementById('create-wo-smart-btn').addEventListener('click', () => {
                    const checkedItems = Array.from(container.querySelectorAll('#tab-complete .order-checkbox:checked'))
                                              .map(cb => cb.closest('.order-list-item').dataset.orderId);
                    const qtyInput = document.getElementById('create-wo-by-quantity-input');
                    const quantity = parseInt(qtyInput.value, 10);

                    if (checkedItems.length > 0) {
                        createWorkOrder(checkedItems);
                    } else if (quantity > 0) {
                        const visibleOrderIds = new Set(Array.from(container.querySelectorAll('#tab-complete .order-list-item')).map(li => li.dataset.orderId));
                        const filteredOrders = allOrdersData.filter(order => order.status === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' && visibleOrderIds.has(String(order.id)));
                        if (quantity > filteredOrders.length) {
                            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${quantity} ‡∏ö‡∏¥‡∏• ‡πÅ‡∏ï‡πà‡∏°‡∏µ ${filteredOrders.length} ‡∏ö‡∏¥‡∏•\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å ${filteredOrders.length} ‡∏ö‡∏¥‡∏•?`)) return;
                        }
                        const idsToProcess = filteredOrders.slice(0, quantity).map(order => String(order.id));
                        createWorkOrder(idsToProcess);
                        qtyInput.value = '';
                    } else {
                        const allFilteredIds = Array.from(container.querySelectorAll('#tab-complete .order-list-item')).map(item => item.dataset.orderId);
                        if (allFilteredIds.length === 0) {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç');
                            return;
                        }
                        createWorkOrder(allFilteredIds);
                    }
                });

                const completeTab = container.querySelector('#tab-complete');
                if (completeTab) {
                    completeTab.addEventListener('change', (e) => {
                        if (e.target.classList.contains('order-checkbox')) {
                            updateSmartWorkOrderButton();
                        }
                    });
                }
                document.getElementById('create-wo-by-quantity-input').addEventListener('input', updateSmartWorkOrderButton);

                trackingFileInput.addEventListener('change', (e) => handleTrackingImport(e.target.files[0]));
                
                container.querySelector('#channel_code').addEventListener('change', (e) => { 
                    const selectedChannel = e.target.value; 
                    const addressLabel = container.querySelector('label[for="customer_address"]'); 
                    const paymentSection = document.getElementById('payment-info-section'); 
                    const claimSection = document.getElementById('claim-details-section');

                    updateAllFontDropdowns(selectedChannel); 
                    
                    if (ecommerceChannels.includes(selectedChannel)) { 
                        addressLabel.textContent = '‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏'; 
                    } else { 
                        addressLabel.textContent = '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'; 
                    } 
                    
                    if (selectedChannel === 'CLAIM' || selectedChannel === 'INFU') { 
                        paymentSection.style.display = 'none'; 
                        claimSection.style.display = (selectedChannel === 'CLAIM') ? 'block' : 'none';
                        container.querySelector('#price').value = 0; 
                        container.querySelector('#shipping_cost').value = 0; 
                        container.querySelector('#discount').value = 0; 
                        calculateTotal(); 
                    } else { 
                        paymentSection.style.display = 'block'; 
                        claimSection.style.display = 'none';
                    } 
                });

                itemsTbody.addEventListener('paste', (e) => { e.preventDefault(); const pasteData = (e.clipboardData || window.clipboardData).getData('text'); const rowsData = pasteData.split(/[\r\n]+/).filter(row => row.trim() !== ''); let targetCell = e.target.closest('td'); if (!targetCell) return; let startRowIndex = Array.from(itemsTbody.children).indexOf(targetCell.parentElement); let startCellIndex = targetCell.cellIndex; const modifiedRows = []; rowsData.forEach((rowData, rowIndex) => { const cellsData = rowData.split('\t'); let currentRow; const currentRowIndex = startRowIndex + rowIndex; if (currentRowIndex >= itemsTbody.rows.length) { if (itemsTbody.rows.length === 1 && $(itemsTbody.rows[0]).find('.item-product').val() === null) { currentRow = itemsTbody.rows[0]; } else { currentRow = addItemRow(); } } else { currentRow = itemsTbody.rows[currentRowIndex]; } if (!currentRow) return; cellsData.forEach((cellData, cellIndex) => { const targetCellIndex = startCellIndex + cellIndex; if (targetCellIndex < currentRow.cells.length - 1) { const input = currentRow.cells[targetCellIndex].querySelector('input, select'); if (input) { if (input.classList.contains('item-product')) { const pastedValue = cellData.trim().toLowerCase(); const product = fullProductList.find(p => p.product_code.toLowerCase() === pastedValue || p.product_name.toLowerCase() === pastedValue); if (product) { $(input).val(product.id).trigger('change.select2'); } else { $(input).val(null).trigger('change.select2'); } } else if (input.tagName === 'SELECT') { const trimmedCellData = cellData.trim().toLowerCase(); const matchedOption = [...input.options].find(opt => opt.text.toLowerCase() === trimmedCellData || opt.value.toLowerCase() === trimmedCellData); if (matchedOption) { input.value = matchedOption.value; } } else { input.value = cellData.trim(); } } } }); modifiedRows.push(currentRow); }); modifiedRows.forEach(row => { if (row) { checkAndApplyStampInkLogic(row); } }); });
                container.addEventListener('click', (event) => {
                    const target = event.target;
                    
                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (Strong tag)
                    if (target.tagName === 'STRONG' && target.closest('.order-list-item')) { 
                        const orderId = target.closest('.order-list-item').dataset.orderId; 
                        if (orderId) { loadOrderForEditing(orderId); } 
                    }

                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏
                    const trackingSpan = target.closest('.order-tracking'); 
                    if (trackingSpan) { 
                        if (target.closest('.btn-edit-tracking')) { 
                            event.stopPropagation(); event.preventDefault(); enterTrackingEditMode(trackingSpan); 
                        } 
                        if (target.closest('.btn-save-tracking-confirm')) { 
                            event.stopPropagation(); event.preventDefault(); saveTrackingNumber(trackingSpan); 
                        } 
                        if (target.closest('.btn-cancel-tracking-edit')) { 
                            event.stopPropagation(); event.preventDefault(); exitTrackingEditMode(trackingSpan); 
                        } 
                    }

                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Work Order Header)
                    const headerForAction = target.closest('.work-order-header');
                    if (headerForAction) { 
                        const classToAction = { 
                            'picking-slip-btn': (btn) => showPickingSlipModal(btn.dataset.workOrderName), 
                            'export-production-btn': (btn) => exportForProduction(btn.dataset.workOrderName), 
                            'export-qc-btn': (btn) => exportForQC(btn.dataset.workOrderName), 
                            'export-barcode-btn': (btn) => exportForBarcode(btn.dataset.workOrderName), // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                            'prepare-waybill-btn': (btn) => prepareForWaybill(btn.dataset.workOrderName), 
                            'export-waybill-sort-btn': (btn) => window.waybillSorter.start(btn.dataset.workOrderName, allOrdersData), 
                            'import-wo-csv-btn': () => trackingFileInput.click(), 
                            'cancel-wo-btn': (btn) => cancelWorkOrder(btn.dataset.workOrderName) 
                        }; 
                        let actionTaken = false; 
                        for (const className in classToAction) { 
                            const btn = target.closest(`.${className}`); 
                            if (btn) { 
                                event.stopPropagation(); 
                                classToAction[className](btn); 
                                actionTaken = true; 
                                break; 
                            } 
                        } 
                        if (!actionTaken && !target.closest('.wo-header-actions')) { toggleWorkOrder(headerForAction); } 
                    }

                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î/‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô
                    const billsContainer = target.closest('.work-order-bills'); 
                    if(billsContainer) { 
                        const classToAction = { 
                            'select-all-in-wo-btn': (btn) => selectAllInWorkOrder(btn), 
                            'revert-to-waiting-btn': (btn) => revertSelectedBills(btn, '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'), 
                            'revert-to-complete-btn': (btn) => revertSelectedBills(btn, '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'), 
                            'cancel-bills-from-wo-btn': (btn) => cancelSelectedBillsFromWorkOrder(btn) 
                        }; 
                        for (const className in classToAction) { 
                            const btn = target.closest(`.${className}`); 
                            if (btn) { classToAction[className](btn); break; } 
                        } 
                    }
                });
                
                addItemBtn.addEventListener('click', () => {
                    const lastRow = itemsTbody.querySelector('tr:last-child');
                    
                    if (lastRow && lastRow.dataset.isCondoPart) {
                        const lastProductId = $(lastRow.querySelector('.item-product')).val();
                        const product = fullProductList.find(p => p.id == lastProductId);
                        if (product && product.product_category && product.product_category.trim().toUpperCase() === 'CONDO STAMP') {
                            addCondoStampSet(lastProductId);
                            return;
                        }
                    }

                    let itemToCopy = null;
                    if (lastRow) {
                        const lastProductId = $(lastRow).find('.item-product').val();
                        if (lastProductId) {
                            itemToCopy = { product_id: lastProductId };
                        }
                    }
                    addItemRow(itemToCopy);
                });
                
                $(itemsTbody).on('select2:select', '.item-product', function(e) {
                    const row = e.target.closest('tr');
                    const groupId = row.dataset.condoGroupId;

                    if (groupId && !window.isSyncingCondo) {
                        window.isSyncingCondo = true;
                        const newProductId = $(e.target).val();
                        document.querySelectorAll(`tr[data-condo-group-id="${groupId}"]`).forEach(groupRow => {
                            if (groupRow !== row) {
                                $(groupRow.querySelector('.item-product')).val(newProductId).trigger('change.select2', [true]);
                            }
                        });
                        window.isSyncingCondo = false;
                    }
                    
                    if (!e.params.data.fromSync) { 
                        handleCondoStampExpansion(row);
                    }
                    
                    if (!row.dataset.isAutoAdded) {
                        checkAndApplyStampInkLogic(row);
                    }
                });
                
                itemsTbody.addEventListener('change', (e) => { if (e.target.classList.contains('item-ink_color')) { const row = e.target.closest('tr'); if (!row.dataset.isAutoAdded) { checkAndApplyStampInkLogic(row); } } });
                itemsTbody.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { const rowToRemove = e.target.closest('tr'); const linkedInkRowUid = rowToRemove.dataset.linkedInkRowUid; if (linkedInkRowUid) { const inkRow = itemsTbody.querySelector(`tr[data-row-uid="${linkedInkRowUid}"]`); if (inkRow) { $(inkRow).find('.item-product').select2('destroy'); inkRow.remove(); } } $(rowToRemove).find('.item-product').select2('destroy'); rowToRemove.remove(); } });
                const pickingSlipModal = document.getElementById('picking-slip-modal'); document.getElementById('cancel-picking-slip-modal-btn').addEventListener('click', hidePickingSlipModal); pickingSlipModal.addEventListener('click', (e) => { if (e.target === pickingSlipModal) hidePickingSlipModal(); });
                [container.querySelector('#price'), container.querySelector('#shipping_cost'), container.querySelector('#discount')].forEach(input => input.addEventListener('input', calculateTotal));
                
                requestTaxInvoiceCb.addEventListener('change', (e) => {
                    if(e.target.checked) {
                        requestCashBillCb.checked = false;
                    }
                    handleBillingRequest();
                });
                requestCashBillCb.addEventListener('change', (e) => {
                    if(e.target.checked) {
                        requestTaxInvoiceCb.checked = false;
                    }
                    handleBillingRequest();
                });

                taxInvoiceSection.addEventListener('input', (e) => {
                    if (e.target.classList.contains('tax-item-unit-price')) {
                        calculateTaxItemTotals();
                    }
                });
                document.getElementById('customer_name').addEventListener('input', (e) => {
                    if(taxInvoiceSection.style.display === 'block') taxCustomerNameInput.value = e.target.value;
                });
                document.getElementById('customer_address').addEventListener('input', (e) => {
                    if(taxInvoiceSection.style.display === 'block') taxCustomerAddressInput.value = e.target.value;
                });

                tabLinks.forEach(link => { link.addEventListener('click', (e) => openTab(e, e.target.dataset.tab)); });
                ['filter-waiting', 'filter-complete', 'filter-cancelled', 'filter-shipped', 'filter-work-orders'].forEach(id => { const el = container.querySelector(`#${id}`); if (el) el.addEventListener('change', renderAllTabs); });

                const searchInputIds = ['search-waiting', 'search-complete', 'search-shipped', 'search-cancelled', 'search-work-orders'];
                searchInputIds.forEach(id => {
                    const el = container.querySelector(`#${id}`);
                    if (el) {
                        el.addEventListener('input', (e) => {
                            const query = e.target.value; 
                            searchInputIds.forEach(otherId => {
                                const otherEl = container.querySelector(`#${otherId}`);
                                if (otherEl && otherEl !== e.target) {
                                    otherEl.value = query;
                                }
                            });

                            renderAllTabs();

                            clearTimeout(searchDebounceTimer);
                            searchDebounceTimer = setTimeout(async () => {
                                const trimmedQuery = query.trim();
                                if (trimmedQuery.length >= 3) {
                                    await performDatabaseSearch(trimmedQuery);
                                } else if (trimmedQuery.length === 0) {
                                    await loadInitialData(true); 
                                }
                            }, 600);
                        });
                    }
                });
                document.getElementById('download-template-btn').addEventListener('click', downloadStandardOrderTemplate); document.getElementById('download-pgtr-template-btn')?.addEventListener('click', downloadPgtrTemplate); document.getElementById('download-wy-template-btn')?.addEventListener('click', downloadWyTemplate);
                
                importOrdersBtn.addEventListener('click', () => importOrdersFileInput.click()); 
                importOrdersFileInput.addEventListener('change', (e) => handleSmartImport(e.target.files[0]));

                document.getElementById('move-to-waiting-btn').addEventListener('click', () => moveSelectedOrders('complete', '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')); 
                
                document.getElementById('move-to-complete-from-waiting-btn').addEventListener('click', async () => {
                    const selectedIds = getSelectedOrderIds(container.querySelector('#tab-waiting .order-list'));
                    if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢');
                    
                    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢ ${selectedIds.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

                    loadingOverlay.style.display = 'flex';
                    const successIds = [];
                    const failedOrders = [];

                    for (const id of selectedIds) {
                        const order = allOrdersData.find(o => String(o.id) === id);
                        if (!order) continue;

                        const validationResult = validateOrderForCompletion(order);
                        if (validationResult.isValid) {
                            successIds.push(id);
                        } else {
                            failedOrders.push({ bill_no: order.bill_no || `ID ${id}`, reason: validationResult.reason });
                        }
                    }

                    if (successIds.length > 0) {
                        const { error } = await supabaseClient.from('orders').update({ status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' }).in('id', successIds);
                        if (error) {
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                            loadingOverlay.style.display = 'none';
                            return;
                        }
                    }
                    
                    loadingOverlay.style.display = 'none';

                    let alertMessage = "";
                    if (successIds.length > 0) {
                        alertMessage += `‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
                    }
                    if (failedOrders.length > 0) {
                        alertMessage += `‚ùå ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failedOrders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:\n`;
                        alertMessage += failedOrders.map(f => `- ${f.bill_no}: ${f.reason}`).join('\n');
                    }
                    alert(alertMessage || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢");
                });
                
                document.getElementById('select-all-waiting-btn').addEventListener('click', () => selectAll('waiting'));
                document.getElementById('cancel-selected-waiting-btn').addEventListener('click', () => cancelSelectedOrders('waiting')); 
                document.getElementById('cancel-selected-complete-btn').addEventListener('click', () => cancelSelectedOrders('complete'));
                document.getElementById('select-all-shipped-btn').addEventListener('click', () => selectAll('shipped')); 
                document.getElementById('claim-selected-shipped-btn').addEventListener('click', () => handleClaimSelectedOrders()); 
                document.getElementById('export-shipped-btn').addEventListener('click', exportShippedData);
                document.getElementById('export-tracking-csv-btn').addEventListener('click', openCarrierSelection);
                document.getElementById('confirm-export-tracking-btn').addEventListener('click', processTrackingExport);
                document.getElementById('cancel-carrier-modal').addEventListener('click', () => { 
                    document.getElementById('carrier-selection-modal').style.display = 'none'; 
                });
                $('#carrier-select').select2({
                    data: ['Flash', 'Kerry', 'J&T', 'Post'].map(c => ({id: c, text: c})),
                    tags: true, 
                    placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á',
                    dropdownParent: $('#carrier-selection-modal .modal-content')
                });
                document.getElementById('select-all-cancelled-btn').addEventListener('click', () => selectAll('cancelled')); 
                document.getElementById('restore-to-waiting-btn').addEventListener('click', () => restoreSelectedOrders('‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')); 
                document.getElementById('restore-to-complete-btn').addEventListener('click', () => restoreSelectedOrders('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'));
	            eventListenersInitialized = true;
            }

            return { initializeApp, loadInitialData, getFullProductList: () => fullProductList };
        })();
// --- PACKING SYSTEM MODULE (FULL VERSION WITH AUTO-RESET & SPEED OPTIMIZATION) ---
window.packingSystem = (() => {
    const container = document.getElementById("packing-system-container");
    const selectionView = container.querySelector("#work-order-selection-view");
    const workOrderList = container.querySelector("#work-order-list");
    const mainView = container.querySelector("#packing-main-view");
    const resetBtn = container.querySelector("#reset-packing-btn");
    const searchInput = container.querySelector("#search-input");
    const orderList = container.querySelector("#order-list");
    const orderCounter = container.querySelector("#order-counter");
    const resultContainer = container.querySelector("#result-container");
    const actionPanel = container.querySelector("#action-panel");
    const itemScanInput = container.querySelector("#item-scan-input");
    const parcelScanInput = container.querySelector("#parcel-scan-input");
    const statusMessage = container.querySelector("#status-message");
    const successSound = container.querySelector("#success-sound");
    const errorSound = container.querySelector("#error-sound");
    const headerTitle = container.querySelector("#packing-header-title");
    const backBtn = container.querySelector("#back-to-wo-selection");
    const finalizeWoBtn = container.querySelector("#finalize-wo-btn");
    const shipAllScannedBtn = document.getElementById("ship-all-scanned-btn");

    let allOrdersForPacking = [];
    let aggregatedData = [];
    let completedIndices = new Set();
    let currentIndex = -1;
    let currentWorkOrderName = null;

    // --- ‡∏£‡∏∞‡∏ö‡∏ö Auto-Reset ---
    let inactivityTimer = null;
    const INACTIVITY_LIMIT = 60000; // 1 ‡∏ô‡∏≤‡∏ó‡∏µ (60,000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏ô‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)
    function startInactivityTimer() {
        clearTimeout(inactivityTimer);
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 100%
        if (currentIndex >= 0 && !completedIndices.has(currentIndex)) {
            inactivityTimer = setTimeout(async () => {
                const group = aggregatedData[currentIndex];
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏Å‡∏ô‡πÑ‡∏õ‡∏ö‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏Å‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)
                const hasStarted = group.some(item => item.scanned || item.parcelScanned);
                if (hasStarted) {
                    console.log("Auto-reset: No activity for 1 minute.");
                    await performResetAction();
                    updateStatus("‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ", "error");
                }
            }, INACTIVITY_LIMIT);
        }
    }
    
    // NEW FUNCTION: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
    async function checkAndResetCurrentIncompleteOrder() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        if (currentIndex !== -1 && currentWorkOrderName && aggregatedData.length > 0) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô aggregatedData
            if (!completedIndices.has(currentIndex) && aggregatedData[currentIndex]) {
                const group = aggregatedData[currentIndex];
                const hasStarted = group.some(item => item.scanned || item.parcelScanned);
                
                if (hasStarted) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                    console.log(`Auto-resetting incomplete order (${group[0].tracking_number}) from WO ${currentWorkOrderName} before switching.`);
                    // NOTE: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å performResetAction() ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ currentIndex
                    await performResetAction();
                }
            }
        }
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Database (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÇ‡∏ï‡πâ)
    async function performResetAction() {
        if (currentIndex < 0) return;
        
        // 1. Clear inactivity timer ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        clearTimeout(inactivityTimer);
        
        const group = aggregatedData[currentIndex];
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Database ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏Å‡∏ô'
        const { error: itemError } = await supabaseClient.from('order_items')
            .update({ packing_status: null, item_scan_time: null })
            .in('item_uid', group.map(i => i.item_uid));
            
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏' ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï
        const { error: orderError } = await supabaseClient.from('orders')
            .update({ 
                status: '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)', 
                packing_meta: null, 
                shipped_by: null, 
                shipped_time: null 
            })
            .eq('id', group[0].order_id);

        if (!itemError && !orderError) {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            await loadPackingData(currentWorkOrderName, true); // Pass true to skip inner reset check
        } else {
            console.error("Reset Error:", itemError || orderError);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (1, 2, 10 ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 1, 10, 2)
    function naturalSortCompare(a, b) {
        const re = /(\d+)/g;
        const aParts = String(a).split(re);
        const bParts = String(b).split(re);
        for (let i = 0; i < Math.min(aParts.length, bParts.length); i++) {
            const partA = aParts[i]; const partB = bParts[i];
            if (i % 2 === 1) {
                const numA = parseInt(partA, 10); const numB = parseInt(partB, 10);
                if (numA !== numB) return numA - numB;
            } else if (partA !== partB) return partA.localeCompare(partB);
        }
        return aParts.length - bParts.length;
    }

    async function loadWorkOrdersForPacking() {
        // --- ADDED: Check and reset when going back to WO selection ---
        await checkAndResetCurrentIncompleteOrder();
        
        showPackingView("selection");
        workOrderList.innerHTML = "<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>";
        const { data: workOrders, error: woError } = await supabaseClient.from("work_orders").select("*").eq('status', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï').order("created_at", { ascending: false });
        if (woError) { workOrderList.innerHTML = "<li>‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</li>"; return; }
        if (!workOrders || workOrders.length === 0) { workOrderList.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</li>"; return; }
        
        const { data: allProductionOrders } = await supabaseClient.from("orders").select("work_order_name, tracking_number, packing_meta, order_items(packing_status)").in('work_order_name', workOrders.map(wo => wo.work_order_name));
        
        workOrderList.innerHTML = "";
        workOrders.forEach(wo => {
            const ordersInWo = allProductionOrders.filter(o => o.work_order_name === wo.work_order_name);
            const hasTracking = ordersInWo.some(o => o.tracking_number);
            const isPartiallyPacked = ordersInWo.some(o => o.packing_meta?.parcelScanned || o.order_items.some(oi => oi.packing_status === '‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß'));
            let statusIcon = 'üì¶'; let statusClass = ''; let statusText = '';
            if (!hasTracking) { statusIcon = '‚ö†Ô∏è'; statusClass = 'no-tracking'; statusText = ' (‡∏£‡∏≠‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏)'; }
            else if (isPartiallyPacked) { statusIcon = 'üîÑ'; }
            const li = document.createElement("li"); li.className = "work-order-item";
            const btn = document.createElement("button");
            btn.className = statusClass;
            btn.innerHTML = `<span class="status-icon">${statusIcon}</span> <span>${wo.work_order_name} (${wo.order_count} ‡∏ö‡∏¥‡∏•)${statusText}</span>`;
            btn.addEventListener("click", () => {
                if (!hasTracking) { alert('‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ'); return; }
                loadPackingData(wo.work_order_name);
            });
            li.appendChild(btn);
            workOrderList.appendChild(li);
        });
    }

    // MODIFIED: Added skipReset parameter
    async function loadPackingData(workOrderName, skipReset = false) {
        // --- ADDED: Check and reset when loading a NEW WO ---
        if (workOrderName !== currentWorkOrderName && !skipReset) {
            await checkAndResetCurrentIncompleteOrder();
        }

        loadingOverlay.style.display = "flex";
        currentWorkOrderName = workOrderName;
        // 1. Clear inactivity timer
        clearTimeout(inactivityTimer);

        const { data, error } = await supabaseClient.from("orders").select("*, order_items(*)").eq("work_order_name", workOrderName).order('bill_no', { ascending: true });
        loadingOverlay.style.display = "none";
        if (error) { alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message); return; }
        const ordersWithTracking = data.filter(order => order.tracking_number && order.tracking_number.trim() !== "");
        prepareDataForPacking(ordersWithTracking);
        if (aggregatedData.length > 0) {
            headerTitle.textContent = `‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á: ${workOrderName}`;
            showPackingView("main");
            renderOrderNav();
            const nextIndex = aggregatedData.findIndex((_, i) => !completedIndices.has(i) && !aggregatedData[i][0].isOrderComplete);
            displayOrder(nextIndex !== -1 ? nextIndex : 0);
        }
    }

    function prepareDataForPacking(orders) {
        let flatData = [];
        completedIndices.clear();

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Product ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const allProducts = orderSystem.getFullProductList();

        orders.forEach(order => {
            const isOrderShipped = order.status === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
            const isParcelScanned = order.packing_meta?.parcelScanned || false;
            
            if (order.order_items) {
                order.order_items.forEach(item => {
                    // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô)
                    const productInfo = allProducts.find(p => p.id === item.product_id);
                    let finalImageUrl = productInfo ? productInfo.image_url : null;

                    // 2. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô:
                    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ "‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô" ‡πÑ‡∏ß‡πâ
                    if (item.cartoon_pattern && window.cartoonPatternList) {
                        const searchName = String(item.cartoon_pattern).trim().toLowerCase();
                        
                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Database
                        const foundPattern = window.cartoonPatternList.find(p => 
                            String(p.pattern_name).trim().toLowerCase() === searchName
                        );

                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏ó‡∏ô
                        if (foundPattern && foundPattern.image_url) {
                            finalImageUrl = foundPattern.image_url;
                        }
                    }

                    // 3. ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Flat Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á
                    flatData.push({
                        'tracking_number': order.tracking_number,
                        'customer_name': order.customer_name,
                        'order_id': order.id,
                        'product_name': item.product_name,
                        'image_url': finalImageUrl, // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                        'details': [item.line_1, item.line_2, item.line_3].filter(Boolean).join(" // "),
                        'ink_color': item.ink_color,
                        'notes': item.notes,
                        'shelf_location': item.product_type,
                        'cartoon_pattern': item.cartoon_pattern,
                        'line_pattern': item.line_pattern,
                        'font': item.font,
                        'item_uid': item.item_uid,
                        'scanned': item.packing_status === '‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                        'parcelScanned': isParcelScanned,
                        'isOrderComplete': isOrderShipped,
                        'needsTaxInvoice': order.billing_details?.request_tax_invoice || false,
                        'needsCashBill': order.billing_details?.request_cash_bill || false,
                        'claim_type': order.claim_type,
                        'claim_details': order.claim_details,
                        'file_attachment': item.file_attachment
                    });
                });
            }
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ (Grouping by Tracking Number)
        const grouped = {}; 
        const tOrder = [];
        flatData.forEach(item => {
            if (!grouped[item.tracking_number]) { 
                grouped[item.tracking_number] = []; 
                tOrder.push(item.tracking_number); 
            }
            grouped[item.tracking_number].push(item);
        });

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå
        aggregatedData = tOrder.map(t => grouped[t]);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
        aggregatedData.forEach((group, index) => {
            if (group.every(i => i.scanned)) {
                completedIndices.add(index);
            }
        });

        currentIndex = -1;
        updateFinalizeButtonVisibility();
    }

    function renderOrderNav() {
        orderList.innerHTML = "";
        aggregatedData.forEach((group, index) => {
            const isDone = group[0].isOrderComplete;
            const isFullScanned = completedIndices.has(index);
            const li = document.createElement("li");
            li.className = "order-item";
            if (isDone) li.classList.add("completed");
            li.dataset.index = index;
            li.dataset.trackingId = group[0].tracking_number;
            let icon = isDone ? '‚úÖ' : (isFullScanned ? 'üü¢' : 'üì¶');
            li.innerHTML = `<span class="tracking-id">${icon} ${group[0].tracking_number}</span><span class="customer-name">${group[0].customer_name || 'N/A'}</span>`;
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
            li.addEventListener("click", async () => {
                // --- MODIFIED: Check and reset when switching orders WITHIN the WO ---
                if (currentIndex !== -1 && currentIndex !== index) {
                    await checkAndResetCurrentIncompleteOrder();
                }
                displayOrder(index);
            });
            orderList.appendChild(li);
        });
        updateCounter();
    }

    function displayOrder(index) {
        if (index < 0 || index >= aggregatedData.length) return;
        currentIndex = index;
        const orderGroup = aggregatedData[index];
        orderGroup.sort((a, b) => (a.scanned === b.scanned) ? naturalSortCompare(a.item_uid, b.item_uid) : (a.scanned ? 1 : -1));

        const scannedItems = orderGroup.filter(item => item.scanned).length;
        
        let notifHTML = '';
        if (orderGroup[0].claim_type) {
            notifHTML += `<div style="background-color: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.2em;"><strong>‚ö†Ô∏è ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏•‡∏°:</strong> ${orderGroup[0].claim_type}: ${orderGroup[0].claim_details || ''}</div>`;
        }
        if (orderGroup[0].needsTaxInvoice) {
            notifHTML += `<div style="background-color: #f8d7da; color: #721c24; padding: 15px; border: 1px solid #f5c6cb; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.2em;"><strong>‚ÄºÔ∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö:</strong> ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ <strong>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</strong></div>`;
        } else if (orderGroup[0].needsCashBill) {
            notifHTML += `<div style="background-color: #d1ecf1; color: #0c5460; padding: 15px; border: 1px solid #bee5eb; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.2em;"><strong>‚ÄºÔ∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö:</strong> ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ <strong>‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</strong></div>`;
        }

        let headerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;"><h2>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: ${orderGroup[0].tracking_number} <span style="font-weight: normal; color: #555;">(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${orderGroup[0].customer_name})</span></h2><div style="text-align: right;"><h3 style="margin:0 0 5px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3><span style="font-size: 2em; font-weight: bold;" id="packing-item-counter">${scannedItems}/${orderGroup.length}</span></div></div>`;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
        let tableHTML = `<table style="table-layout: fixed; width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 125px;">QR ItemUID</th>
                    <th style="width: 180px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width: 80px;">‡∏ä‡∏±‡πâ‡∏ô</th>
                    <th style="width: 140px;">‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å</th>
                    <th style="width: 120px;">‡∏•‡∏≤‡∏¢//‡πÄ‡∏™‡πâ‡∏ô</th>
                    <th style="width: 80px;">‡∏ü‡∏≠‡∏ô‡∏ï‡πå</th>
                    <th style="width: 210px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th style="width: 210px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th style="width: 210px;">‡πÑ‡∏ü‡∏•‡πå</th>
                </tr>
            </thead>
            <tbody>`;
        
        orderGroup.forEach(item => {
            const combinedPattern = [item.cartoon_pattern, item.line_pattern].filter(Boolean).join(" // ");
            const displayNotes = (item.notes || '').replace(/\[SET-.*?\]/g, '').trim();
            const fileLink = (item.file_attachment && (item.file_attachment.startsWith('http') || item.file_attachment.includes('www.'))) 
                ? `<a href="${item.file_attachment.startsWith('http') ? item.file_attachment : 'https://' + item.file_attachment}" target="_blank" style="color: #0071e3; text-decoration: underline; font-weight: bold;">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a>`
                : (item.file_attachment || '');

            const rowClass = item.scanned ? 'item-scanned' : '';
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™‡∏Ç‡∏¢‡∏≤‡∏¢ (Zoom)
            const productImageHtml = item.image_url 
                ? `<img src="${item.image_url}" class="packing-product-img" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; display: block; margin: 0 auto 5px auto; border: 1px solid #eee;">`
                : `<div style="width: 80px; height: 80px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #ccc; margin: 0 auto 5px auto; border: 1px solid #eee;">No Pic</div>`;

            tableHTML += `<tr class="${rowClass}" data-item-uid="${item.item_uid}">
                <td style="text-align: center; vertical-align: middle; padding: 10px 5px;">
                    <div id="qr-${item.item_uid}" class="qr-code-container"></div>
                    <small style="display: block; text-align: center; margin-top: 4px; font-size: 10px;">${item.item_uid || ''}</small>
                </td>
                <td style="text-align: center; vertical-align: top; padding: 10px 5px;">
                    ${productImageHtml}
                    <div style="font-weight: bold; line-height: 1.2; font-size: 12px;">${item.product_name || ''}</div>
                </td>
                <td style="text-align: center; vertical-align: middle;">${item.shelf_location || ''}</td>
                <td style="text-align: center; vertical-align: middle;">
    ${(() => {
        const ink = item.ink_color || '';
        let icon = ''; let bgColor = '#f8f9fa'; let textColor = '#333';   
        if (ink.includes('‡∏ú‡πâ‡∏≤')) icon = 'üëï'; else if (ink.includes('‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å')) icon = 'ü•§'; else if (ink.includes('‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©')) icon = 'üìÑ';
        if (ink.includes('‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô')) { bgColor = '#0040ff'; textColor = '#fff'; }
        else if (ink.includes('‡πÅ‡∏î‡∏á')) { bgColor = '#e60000'; textColor = '#fff'; }
        else if (ink.includes('‡∏î‡∏≥')) { bgColor = '#222'; textColor = '#fff'; }
        else if (ink.includes('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß')) { bgColor = '#008000'; textColor = '#fff'; }
        else if (ink.includes('‡∏ä‡∏°‡∏û‡∏π')) { bgColor = '#ff66b2'; textColor = '#fff'; }
        if (!ink) return ''; 
        return `<span class="ink-tag" style="background-color: ${bgColor}; color: ${textColor}; display: inline-flex; align-items: center; justify-content: center; padding: 2px 10px; border-radius: 8px; font-weight: bold; font-size: 12px; min-height: 38px; line-height: 1;">
                    <span class="ink-icon" style="font-size: 30px; margin-right: 6px; display: flex; align-items: center;">${icon}</span>
                    <span style="display: flex; align-items: center;">${ink}</span>
                </span>`;
    })()}
                </td>
                <td style="text-align: center; vertical-align: middle;">${combinedPattern}</td>
                <td style="text-align: center; vertical-align: middle;">${item.font || ''}</td> 
                <td style="vertical-align: middle;">${item.details || ''}</td>
                <td style="vertical-align: middle;">${displayNotes}</td>
                <td style="text-align: center; vertical-align: middle;">${fileLink}</td>
            </tr>`;
        });
        tableHTML += "</tbody></table>";
        
        resultContainer.innerHTML = notifHTML + headerHTML + tableHTML;
        actionPanel.style.display = "block";
        updateInputStates();
        updateActiveNavItem();
        
        orderGroup.forEach(item => { 
            if (item.item_uid) { 
                const qrContainer = document.getElementById(`qr-${item.item_uid}`);
                if(qrContainer) {
                    qrContainer.innerHTML = ''; 
                    new QRCode(qrContainer, { text: item.item_uid, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.H }); 
                }
            } 
        });
        startInactivityTimer();
    }

    // ************ FIX 1: OPTIMIZE PARCEL SCAN ************
    async function handleParcelScan() {
        const scanValue = parcelScanInput.value.trim().toUpperCase();
        if (!scanValue || currentIndex < 0) return;
        const group = aggregatedData[currentIndex];
        
        if (scanValue === String(group[0].tracking_number).trim().toUpperCase()) {
            
            // 1. FAST ACTIONS: Update local state, clear input, play sound
            group.forEach(item => item.parcelScanned = true);
            parcelScanInput.value = "";
            successSound.play();
            updateInputStates(); // <-- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢ Focus ‡πÑ‡∏õ‡∏ó‡∏µ‡πà itemScanInput ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            
            // 2. ASYNCHRONOUS DB WRITE (Non-blocking)
            supabaseClient.from("orders")
                .update({ packing_meta: { parcelScanned: true, scannedBy: loggedInUsername, scanTime: new Date().toISOString() } })
                .eq('id', group[0].order_id)
                .then(({ error }) => {
                    if (error) console.error("Async Parcel DB update failed:", error);
                });
            
            // 3. Reset inactivity timer
            startInactivityTimer();
        } else {
            errorSound.play();
            updateStatus("‚ùå ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", "error");
        }
    }

    // ************ FIX 2: OPTIMIZE ITEM SCAN ************
    async function scanItem() {
        const scanValue = itemScanInput.value.trim().toUpperCase();
        if (!scanValue || currentIndex < 0) return;
        const group = aggregatedData[currentIndex];
        const itemToScan = group.find(item => !item.scanned && item.item_uid === scanValue);
        
        if (itemToScan) {
            
            // 1. FAST ACTIONS: Update local state, clear input, play sound
            itemScanInput.value = "";
            successSound.play();
            itemToScan.scanned = true;
            
            // 2. MINIMAL DOM UPDATE (Bypass slow displayOrder)
            const row = resultContainer.querySelector(`tr[data-item-uid="${itemToScan.item_uid}"]`);
            if (row) {
                row.classList.add('item-scanned');
            }
            const scannedItems = group.filter(i => i.scanned).length;
            const itemCounterEl = document.getElementById("packing-item-counter");
            if (itemCounterEl) {
                itemCounterEl.textContent = `${scannedItems}/${group.length}`;
            }
            updateStatus("‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
            itemScanInput.focus(); // <-- Re-focus ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

            // 3. ASYNCHRONOUS DB WRITE (Non-blocking)
            supabaseClient.from('order_items')
                .update({ item_scan_time: new Date().toISOString(), packing_status: '‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß' })
                .eq('item_uid', itemToScan.item_uid)
                .then(({ error }) => {
                    if (error) console.error("Async Item DB update failed:", error);
                });
            
            // 4. CHECK COMPLETION (SLOW, only run once when complete)
            if (scannedItems === group.length) {
                completedIndices.add(currentIndex);
                clearTimeout(inactivityTimer); // ‡πÅ‡∏™‡∏Å‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                updateStatus("‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!", "success");
                updateFinalizeButtonVisibility();
                renderOrderNav();
                setTimeout(() => {
                    const nextIndex = aggregatedData.findIndex((_, i) => !completedIndices.has(i) && !aggregatedData[i][0].isOrderComplete);
                    if (nextIndex !== -1) displayOrder(nextIndex);
                }, 700);
            }

            // 5. Reset inactivity timer
            startInactivityTimer();
            
        } else {
            errorSound.play();
            updateStatus("‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "error");
        }
    }

    async function shipAllScannedOrders() {
        loadingOverlay.style.display = 'flex';
        try {
            const ids = [];
            completedIndices.forEach(index => {
                const group = aggregatedData[index];
                if (group && !group[0].isOrderComplete) ids.push(group[0].order_id);
            });
            if (ids.length === 0) { 
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏Å‡∏ô‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏™‡πà‡∏á"); 
                loadingOverlay.style.display = 'none'; 
                return; 
            }

            const { error } = await supabaseClient.from('orders').update({
                status: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', 
                shipped_by: loggedInUsername, 
                shipped_time: new Date().toISOString()
            }).in('id', ids);
            
            if (error) throw error;
            
            alert(`‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!`);
            successSound.play();
            await loadPackingData(currentWorkOrderName);
        } catch (err) { 
            alert(err.message); 
        } finally { 
            loadingOverlay.style.display = 'none'; 
        }
    }

    function updateFinalizeButtonVisibility() {
        let hasPending = false;
        completedIndices.forEach(idx => { if (aggregatedData[idx] && !aggregatedData[idx][0].isOrderComplete) hasPending = true; });
        if (shipAllScannedBtn) shipAllScannedBtn.style.display = hasPending ? 'inline-block' : 'none';

        if (currentWorkOrderName && aggregatedData.length > 0 && completedIndices.size === aggregatedData.length) {
            if (aggregatedData.every(g => g[0].isOrderComplete)) finalizeWoBtn.style.display = 'inline-block';
        } else { finalizeWoBtn.style.display = 'none'; }
    }

    const updateStatus = (t, c) => { statusMessage.textContent = t; statusMessage.className = `status-${c}`; };
    const updateCounter = () => { orderCounter.textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${completedIndices.size} / ${aggregatedData.length}`; };
    const updateActiveNavItem = () => { container.querySelectorAll(".order-item").forEach(i => i.classList.toggle("active", parseInt(i.dataset.index) === currentIndex)); };
    const showPackingView = (v) => { selectionView.style.display = (v === 'selection' ? "block" : "none"); mainView.style.display = (v === 'main' ? "block" : "none"); };
    
    const updateInputStates = () => {
        if (currentIndex < 0) return;
        const g = aggregatedData[currentIndex];
        const isParcelScanned = g[0].parcelScanned;
        const isDone = g[0].isOrderComplete;
        parcelScanInput.disabled = isParcelScanned || isDone;
        itemScanInput.disabled = !isParcelScanned || isDone || g.every(i => i.scanned);
        if (isDone) updateStatus("‚úÖ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
        else if (!isParcelScanned) { updateStatus("‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏...", ""); parcelScanInput.focus(); }
        else if (g.every(i => i.scanned)) updateStatus("üü¢ ‡πÅ‡∏™‡∏Å‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!", "success");
        else { updateStatus("‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...", ""); itemScanInput.focus(); }
    };

    searchInput.addEventListener("input", () => {
        const f = searchInput.value.toLowerCase();
        orderList.querySelectorAll(".order-item").forEach(it => it.style.display = it.dataset.trackingId.toLowerCase().includes(f) ? "" : "none");
    });
    
    // NOTE: ‡πÉ‡∏ä‡πâ "change" event ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Scanner ‡∏à‡∏∞‡∏™‡πà‡∏á Enter ‡∏°‡∏≤‡πÉ‡∏´‡πâ
    parcelScanInput.addEventListener("change", handleParcelScan);
    itemScanInput.addEventListener("change", scanItem);
    
    resetBtn.addEventListener("click", async () => {
        if (currentIndex < 0 || !confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô "‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏°‡πà"? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏Å‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)')) return;
        await performResetAction();
    });
    
    // --- MODIFIED: Back button now checks and resets ---
    backBtn.addEventListener('click', async () => {
        await checkAndResetCurrentIncompleteOrder();
        loadWorkOrdersForPacking();
    });
    
    shipAllScannedBtn.addEventListener("click", shipAllScannedOrders);
    finalizeWoBtn.addEventListener('click', async () => {
        if (!confirm('‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) return;
        await supabaseClient.from('work_orders').update({ status: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' }).eq('work_order_name', currentWorkOrderName);
        await supabaseClient.from('jobs').update({ status: 'DONE' }).eq('name', currentWorkOrderName);
        alert("‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); loadWorkOrdersForPacking();
    });

    return { loadWorkOrdersForPacking };
})();
        
        // --- PRODUCT SYSTEM MODULE ---
        window.productSystem = (() => {
            let isInitialized = false; 
            const addBtn = document.getElementById('add-product-btn'); 
            const importBtn = document.getElementById('import-product-btn'); 
            const importInput = document.getElementById('import-product-input'); 
            const downloadTemplateBtn = document.getElementById('download-product-template-btn'); 
            const searchInput = document.getElementById('search-product-input'); 
            const tableBody = document.getElementById('products-tbody'); 
            const modal = document.getElementById('product-modal'); 
            const modalTitle = document.getElementById('product-modal-title'); 
            const productForm = document.getElementById('product-form'); 
            const cancelModalBtn = document.getElementById('cancel-product-modal-btn'); 
            const categoryInput = document.getElementById('product-category-input'); 
            const rubberCodeGroup = document.getElementById('rubber-code-group');
            const imgInput = document.getElementById('product-image-input');
            const imgPreview = document.getElementById('product-image-preview');
            const bulkUploadBtn = document.getElementById('bulk-upload-images-btn');
            const bulkImageInput = document.getElementById('bulk-image-input');

            let allProductsData = [];

            function initializeApp() { 
                if(isInitialized) return; 
                if(addBtn) addBtn.addEventListener('click', () => showProductModal()); 
                if(importBtn) importBtn.addEventListener('click', () => importInput.click()); 
                if(importInput) importInput.addEventListener('change', (e) => handleProductImport(e.target.files[0])); 
                if(downloadTemplateBtn) downloadTemplateBtn.addEventListener('click', downloadProductTemplate); 
                if(cancelModalBtn) cancelModalBtn.addEventListener('click', hideProductModal); 
                if(modal) modal.addEventListener('click', (e) => { if(e.target === modal) hideProductModal(); }); 
                if(productForm) productForm.addEventListener('submit', saveProduct); 
                if(tableBody) tableBody.addEventListener('click', handleTableClick); 
                if(searchInput) searchInput.addEventListener('input', () => renderProductTable(searchInput.value)); 
                if(bulkUploadBtn) bulkUploadBtn.addEventListener('click', () => bulkImageInput.click());
                if(bulkImageInput) bulkImageInput.addEventListener('change', (e) => handleBulkImageUpload(e.target.files));
                
                if(categoryInput) {
                    categoryInput.addEventListener('input', (e) => { 
                        const isStamp = (e.target.value || '').toUpperCase().includes('STAMP'); 
                        if(rubberCodeGroup) rubberCodeGroup.style.display = isStamp ? 'block' : 'none'; 
                    });
                }

                if (imgInput) {
                    imgInput.addEventListener('change', function() {
                        const file = this.files[0];
                        if (file && imgPreview) {
                            const reader = new FileReader();
                            reader.onload = (e) => { imgPreview.src = e.target.result; imgPreview.style.display = 'inline-block'; }
                            reader.readAsDataURL(file);
                        }
                    });
                }
                loadProducts(); 
                isInitialized = true; 
            }

            async function loadProducts() { 
                loadingOverlay.style.display = 'flex'; 
                try { 
                    const { data, error } = await supabaseClient.from('products').select('*').order('product_code'); 
                    if (error) throw error; 
                    allProductsData = data; 
                    renderProductTable(); 
                } catch (err) { alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { loadingOverlay.style.display = 'none'; } 
            }

            function renderProductTable(searchTerm = '') { 
                tableBody.innerHTML = ''; 
                const lowercasedFilter = searchTerm.toLowerCase(); 
                const filteredData = allProductsData.filter(p => (p.product_code || '').toLowerCase().includes(lowercasedFilter) || (p.product_name || '').toLowerCase().includes(lowercasedFilter)); 
                
                if (filteredData.length === 0) { 
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; 
                    return; 
                } 

                filteredData.forEach(product => { 
                    const inactiveStyle = product.is_active === false ? 'style="color: #999; text-decoration: line-through;"' : ''; 
                    
                    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° class="packing-product-img" ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö cursor ---
                    const imgHTML = product.image_url 
                        ? `<img src="${product.image_url}" class="packing-product-img" style="width: 45px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; cursor: zoom-in;" onclick="window.open('${product.image_url}', '_blank')">` 
                        : `<div style="width: 45px; height: 45px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #ccc;">No Pic</div>`;
                    
                    const row = `<tr ${inactiveStyle}>
                        <td>${imgHTML}</td>
                        <td>${product.product_code || ''}</td>
                        <td>${product.product_name || ''}</td>
                        <td>${product.product_category || ''}</td>
                        <td>${product.product_type || ''}</td>
                        <td>${product.rubber_code || ''}</td>
                        <td>${product.storage_location || ''}</td>
                        <td>
                            <div class="action-cell-buttons">
                                <button class="btn btn-warning btn-sm edit-product-btn" data-product-code="${product.product_code}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn btn-danger btn-sm delete-product-btn" data-product-code="${product.product_code}">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    </tr>`; 
                    tableBody.insertAdjacentHTML('beforeend', row); 
                }); 
            }

            function showProductModal(product = null) { 
                if (!productForm) return;
                productForm.reset(); 
                if (imgInput) imgInput.value = ""; 
                if (imgPreview) {
                    imgPreview.src = (product && product.image_url) ? product.image_url : "";
                    imgPreview.style.display = (product && product.image_url) ? 'inline-block' : 'none';
                }
                if (product) { 
                    modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'; 
                    document.getElementById('product-id-input').value = product.id; 
                    document.getElementById('product-code-input').value = product.product_code; 
                    document.getElementById('product-code-input').readOnly = true; 
                    document.getElementById('product-name-input').value = product.product_name; 
                    document.getElementById('product-category-input').value = product.product_category || ''; 
                    document.getElementById('product-type-input').value = product.product_type || ''; 
                    document.getElementById('product-rubber-code-input').value = product.rubber_code || ''; 
                    document.getElementById('storage-location-input').value = product.storage_location || ''; 
                } else { 
                    modalTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà'; 
                    document.getElementById('product-code-input').readOnly = false; 
                } 
                modal.style.display = 'flex'; 
            }

            function hideProductModal() { if(modal) modal.style.display = 'none'; }

            async function saveProduct(e) {
                e.preventDefault();
                loadingOverlay.style.display = 'flex';
                const productCode = document.getElementById('product-code-input').value.trim();
                const file = imgInput.files[0];
                let imageUrl = imgPreview.src;
                try {
                    if (file) {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${productCode}-${Date.now()}.${fileExt}`;
                        const filePath = `products/${fileName}`;
                        let { error: uploadError } = await supabaseClient.storage.from('product-images').upload(filePath, file);
                        if (uploadError) throw uploadError;
                        const { data: publicUrlData } = supabaseClient.storage.from('product-images').getPublicUrl(filePath);
                        imageUrl = publicUrlData.publicUrl;
                    }
                    const productData = {
                        product_code: productCode,
                        product_name: document.getElementById('product-name-input').value.trim(),
                        product_category: document.getElementById('product-category-input').value.trim() || null,
                        product_type: document.getElementById('product-type-input').value.trim() || null,
                        rubber_code: document.getElementById('product-rubber-code-input').value.trim() || null,
                        storage_location: document.getElementById('storage-location-input').value.trim() || null,
                        image_url: imageUrl.startsWith('data:') || imageUrl.includes('blob:') ? null : imageUrl,
                        is_active: true
                    };
                    const { error } = await supabaseClient.from('products').upsert(productData, { onConflict: 'product_code' });
                    if (error) throw error;
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); hideProductModal(); await loadProducts(); await window.orderSystem.loadInitialData(true); 
                } catch (err) { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { loadingOverlay.style.display = 'none'; }
            }

            async function deleteProduct(productCode) { 
                if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${productCode}"?`)) return; 
                loadingOverlay.style.display = 'flex'; 
                try { 
                    const { error } = await supabaseClient.from('products').delete().eq('product_code', productCode); 
                    if (error) throw error; 
                    alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await loadProducts(); await window.orderSystem.loadInitialData(true); 
                } catch (err) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { loadingOverlay.style.display = 'none'; } 
            }

            function handleTableClick(e) { 
                const btn = e.target.closest('button'); if (!btn) return;
                const productCode = btn.dataset.productCode;
                if (btn.classList.contains('edit-product-btn')) { const p = allProductsData.find(p => p.product_code === productCode); if (p) showProductModal(p); } 
                if (btn.classList.contains('delete-product-btn')) deleteProduct(productCode); 
            }

            function downloadProductTemplate() { 
                const headers = ["product_code", "product_name", "product_category", "product_type", "rubber_code", "storage_location"]; 
                const sampleData = [ ["P001", "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥", "STK", "FINISHPRODUCT", "", "3A‡∏ä‡∏±‡πâ‡∏ô2‡πÅ‡∏ñ‡∏ß2"] ]; 
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]); 
                const workbook = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(workbook, worksheet, "ProductTemplate"); 
                XLSX.writeFile(workbook, "Product_Import_Template.xlsx"); 
            }
            
            function handleProductImport(file) { /* ...‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... */ }

            async function handleBulkImageUpload(files) {
                if (files.length === 0) return;
                if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${files.length} ‡πÑ‡∏ü‡∏•‡πå\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏° "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)\n\n‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    bulkImageInput.value = ""; return;
                }
                loadingOverlay.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...";
                loadingOverlay.style.display = 'flex';
                let successCount = 0; let failCount = 0;
                for (let file of files) {
                    try {
                        const productCode = file.name.substring(0, file.name.lastIndexOf('.')).trim();
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${productCode}-${Date.now()}.${fileExt}`;
                        const filePath = `products/${fileName}`;
                        await supabaseClient.storage.from('product-images').upload(filePath, file);
                        const { data: urlData } = supabaseClient.storage.from('product-images').getPublicUrl(filePath);
                        await supabaseClient.from('products').update({ image_url: urlData.publicUrl }).eq('product_code', productCode);
                        successCount++;
                    } catch (err) { failCount++; }
                }
                loadingOverlay.style.display = 'none';
                bulkImageInput.value = "";
                alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                await loadProducts();
            }

            return { initializeApp };
        })();

window.patternSystem = (() => {
    let isInitialized = false;
    let currentEditingId = null;

    async function initializeApp() {
        if(isInitialized) return;
        const addBtn = document.getElementById('add-pattern-btn');
        if (addBtn) {
            addBtn.onclick = () => {
                currentEditingId = null;
                document.getElementById('pattern-modal-title-text').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô';
                document.getElementById('pattern-form').reset();
                document.getElementById('pattern-modal').style.display = 'flex';
            };
        }
        document.getElementById('cancel-pattern-modal-btn').onclick = () => document.getElementById('pattern-modal').style.display = 'none';
        document.getElementById('bulk-upload-patterns-btn').onclick = () => document.getElementById('bulk-pattern-input').click();
        document.getElementById('bulk-pattern-input').onchange = (e) => handleBulk(e.target.files);
        document.getElementById('pattern-form').onsubmit = save;
        document.getElementById('search-pattern-input').oninput = (e) => render(e.target.value);
        await load();
        isInitialized = true;
    }

    async function load() {
        const { data, error } = await supabaseClient.from('cartoon_patterns').select('*').order('pattern_name');
        if (error) return;
        window.cartoonPatternList = data || [];
        render();
    }

    function render(search = '') {
        const tbody = document.getElementById('patterns-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const list = window.cartoonPatternList || [];
        list.filter(p => p.pattern_name.toLowerCase().includes(search.toLowerCase())).forEach(p => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding:10px; border:1px solid #ddd; text-align:center; vertical-align: middle;">
                        <img src="${p.image_url}" class="packing-product-img" style="width:50px; height:50px; object-fit:cover; border-radius:4px; cursor:zoom-in;">
                    </td>
                    <td style="padding:10px 15px; border:1px solid #ddd; text-align:left; vertical-align: middle; font-weight: 600;">
                        ${p.pattern_name}
                    </td>
                    <td style="padding:10px; border:1px solid #ddd; text-align:center; vertical-align: middle;">
                        <div class="action-cell-buttons">
                            <button class="btn btn-warning btn-sm" onclick="window.patternSystem.edit('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-danger btn-sm" onclick="window.patternSystem.remove('${p.id}')">‡∏•‡∏ö</button>
                        </div>
                    </td>
                </tr>
            `);
        });
    }

    function edit(id) {
        const pattern = window.cartoonPatternList.find(p => p.id === id);
        if (!pattern) return;
        currentEditingId = id;
        document.getElementById('pattern-modal-title-text').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô';
        document.getElementById('pattern-name-input').value = pattern.pattern_name;
        document.getElementById('pattern-modal').style.display = 'flex';
    }

    async function save(e) {
        e.preventDefault();
        const name = document.getElementById('pattern-name-input').value.trim();
        const file = document.getElementById('pattern-image-input').files[0];
        loadingOverlay.style.display = 'flex';
        try {
            let imageUrl = null;
            if (file) {
                const fileName = `patterns/${Date.now()}_${file.name}`;
                const { error: upErr } = await supabaseClient.storage.from('product-images').upload(fileName, file);
                if (upErr) throw upErr;
                const { data: urlData } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            }
            const patternData = { pattern_name: name };
            if (imageUrl) patternData.image_url = imageUrl;
            if (currentEditingId) {
                const { error } = await supabaseClient.from('cartoon_patterns').update(patternData).eq('id', currentEditingId);
                if (error) throw error;
            } else {
                if (!imageUrl) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
                const { error } = await supabaseClient.from('cartoon_patterns').insert(patternData);
                if (error) throw error;
            }
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            document.getElementById('pattern-modal').style.display = 'none';
            await load();
        } catch (err) {
            alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    async function remove(id) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?')) return;
        loadingOverlay.style.display = 'flex';
        await supabaseClient.from('cartoon_patterns').delete().eq('id', id);
        loadingOverlay.style.display = 'none';
        await load();
    }

    async function handleBulk(files) {
        loadingOverlay.style.display = 'flex';
        for(let f of files) {
            try {
                const name = f.name.substring(0, f.name.lastIndexOf('.'));
                const fileName = `patterns/${Date.now()}_${f.name}`;
                await supabaseClient.storage.from('product-images').upload(fileName, f);
                const { data } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
                await supabaseClient.from('cartoon_patterns').upsert({ pattern_name: name, image_url: data.publicUrl }, { onConflict: 'pattern_name' });
            } catch(err) {}
        }
        loadingOverlay.style.display = 'none';
        await load();
    }

    return { initializeApp, remove, edit };
})();

        // --- PLANNER SYSTEM MODULE (FIXED SELECT ALL & EXPORT SELECTED) ---
        window.plannerSystem = (() => {
            let isInitialized = false; let container = null; let currentUserRole = null; let state = { jobs: [] };
            const el = (sel, context = document) => context.querySelector(sel); const cel = (tag, attrs = {}) => { const n = document.createElement(tag); for (const k in attrs) { if (k === 'text') n.textContent = attrs[k]; else n.setAttribute(k, attrs[k]); } return n; }; const sameDay = (d1, d2) => d1 === d2;

            function setupEventListeners() { 
                el('#j_date').addEventListener('change', renderJobs); 
                el('#j_search').addEventListener('input', renderJobs); 
                el('#j_clear').addEventListener('click', () => { el('#j_date').value = ''; el('#j_search').value = ''; renderJobs(); }); 
                el('#btnExportForSorting').addEventListener('click', exportJobsForSorting); 
                el('#tableJobs').addEventListener('click', handleTableClick); 

                // FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏° Event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                el('#j_selectAll').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    container.querySelectorAll('.job-checkbox').forEach(cb => {
                        cb.checked = isChecked;
                        const row = cb.closest('tr');
                        if (row) row.classList.toggle('row-selected', isChecked);
                    });
                });
            }

            async function initializeApp(userRole) { if (isInitialized && currentUserRole === userRole) { await internal_load(); return; } container = el('#planner-system-container'); currentUserRole = userRole; loadingOverlay.style.display = 'flex'; await internal_load(); loadingOverlay.style.display = 'none'; if (!isInitialized) { setupEventListeners(); setupRealtimeSubscriptions(); } updateAccessControls(); isInitialized = true; }
            
            async function internal_load() { try { const { data: jobsData, error: jobsError } = await supabaseClient.from('jobs').select('*').order('created_at', { ascending: false }); if (jobsError) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + jobsError.message); state.jobs = jobsData || []; } catch (e) { console.error("Planner load error:", e); alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ' + e.message); state.jobs = []; } renderAll(); }
            
            function updateAccessControls() { 
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ manager ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ
    const unlocked = currentUserRole === 'superadmin' || currentUserRole === 'production' || currentUserRole === 'manager'; 
    
    container.querySelectorAll('#viewJobs input, #viewJobs select, #viewJobs button').forEach(elem => { 
        if(elem.id !== 'j_selectAll' && !elem.classList.contains('job-checkbox')) {
            elem.disabled = !unlocked; 
        }
    }); 
    renderAll(); 
}

            function renderAll() { if (!container) return; populateJobDateFilter(); renderJobs(); }
            
            function populateJobDateFilter() { const dateSelect = el('#j_date'); if (!dateSelect) return; const today = new Date().toISOString().slice(0, 10); const jobDates = state.jobs.map(j => j.date); const allDates = [...new Set([today, ...jobDates])].sort().reverse(); dateSelect.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>'; allDates.forEach(d => dateSelect.add(new Option(d, d))); dateSelect.value = today; }
            
            function renderJobs() { 
                const tbody = el('#tableJobs tbody'); 
                if (!tbody) return; 
                tbody.innerHTML = ''; 
                // Reset select all checkbox
                if(el('#j_selectAll')) el('#j_selectAll').checked = false;

                const qDate = el('#j_date').value; 
                const qStr = (el('#j_search').value || '').toLowerCase(); 
                const filteredJobs = state.jobs.filter(j => { const dateMatch = !qDate || sameDay(j.date, qDate); const searchMatch = !qStr || j.name.toLowerCase().includes(qStr); return dateMatch && searchMatch; }); 
                
                if (filteredJobs.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`; return; } 
                
                filteredJobs.forEach(j => { 
                    const tr = cel('tr'); 
                    tr.dataset.jobId = j.id; 
                    tr.innerHTML = `<td class="checkbox-cell"><input type="checkbox" class="job-checkbox" data-id="${j.id}"></td>`; 
                    
                    const qtyCell = cel('td'); 
                    const qtyContainer = cel('div', { class: 'qty-pills-container' }); 
                    const depts = ['STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK']; 
                    depts.forEach(d => { const q = j.qty?.[d] || 0; if (q > 0) qtyContainer.appendChild(cel('span', { class: 'pill', text: `${d}: ${q}` })); }); 
                    qtyCell.appendChild(qtyContainer); 
                    
                    let cutTimeText = j.cut || '-'; if (cutTimeText && cutTimeText.length > 5) cutTimeText = cutTimeText.substring(0, 5); 
                    const nameCell = cel('td'); nameCell.innerHTML = `<strong>${j.name}</strong>`; 
                    const dateCell = cel('td', { text: j.date }); 
                    const cutCell = cel('td', { text: cutTimeText }); 
                    const tdAct = cel('td', { class: 'action-cell-buttons'}); 
                    tdAct.innerHTML = `<button class="btn btn-warning btn-sm edit-job-btn" data-job-id="${j.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-danger btn-sm delete-job-btn" data-job-id="${j.id}">‡∏•‡∏ö</button>`; 
                    tr.append(nameCell, dateCell, cutCell, qtyCell, tdAct); 
                    tbody.appendChild(tr); 

                    // Highlight row on checkbox change
                    tr.querySelector('.job-checkbox').addEventListener('change', (e) => {
                        tr.classList.toggle('row-selected', e.target.checked);
                    });
                }); 
            }

            function handleTableClick(e) { const target = e.target; if (target.classList.contains('edit-job-btn')) { const jobId = target.dataset.jobId; showJobEditor(jobId); } if (target.classList.contains('delete-job-btn')) { const jobId = target.dataset.jobId; deleteJob(jobId); } }
            
            async function deleteJob(jobId) { const jobToDelete = state.jobs.find(j => j.id == jobId); if(!jobToDelete) return; if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${jobToDelete.name}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('jobs').delete().eq('id', jobId); if (error) throw error; alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } catch(err) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } finally { loadingOverlay.style.display = 'none'; } }
            
            function showJobEditor(jobId) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô Editor ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ... */
                const job = state.jobs.find(j => j.id == jobId); if (!job) return; const formContainer = document.createElement('div'); formContainer.id = 'job-editor-modal-container'; formContainer.innerHTML = `<div class="modal-overlay" style="display: flex;"><div class="modal-content" style="max-width: 600px;"><h2 id="job-editor-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${job.name}</h2><div id="job-editor-form"><div class="planner-form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px;"><div class="planner-form-group"><label for="edit_j_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="edit_j_date" value="${job.date}"></div><div class="planner-form-group"><label for="edit_j_cut">‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡∏î</label><input type="time" id="edit_j_cut" value="${job.cut || ''}"></div></div><h3 class="planner-section-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å</h3><div id="edit_j_qty" class="planner-form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px 20px;"></div><div class="modal-actions"><button type="button" class="btn btn-secondary" id="edit_j_cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary" id="edit_j_save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>`; document.body.appendChild(formContainer); const qtyHost = formContainer.querySelector('#edit_j_qty'); const depts = ['STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK']; depts.forEach(d => { const qty = job.qty?.[d] || 0; const div = cel('div', { class: 'planner-qty-group' }); div.innerHTML = `<label>${d}</label><input type="number" class="edit-qty" data-dept="${d}" value="${qty}" min="0">`; qtyHost.appendChild(div); }); const closeModal = () => document.body.removeChild(formContainer); formContainer.querySelector('#edit_j_save').onclick = async () => { const newQty = {}; qtyHost.querySelectorAll('.edit-qty').forEach(inp => { newQty[inp.dataset.dept] = parseInt(inp.value, 10) || 0; }); const updates = { date: formContainer.querySelector('#edit_j_date').value, cut: formContainer.querySelector('#edit_j_cut').value, qty: newQty, }; loadingOverlay.style.display = 'flex'; const { error } = await supabaseClient.from('jobs').update(updates).eq('id', jobId); loadingOverlay.style.display = 'none'; if (error) { alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message); } else { alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); closeModal(); } }; formContainer.querySelector('#edit_j_cancel').onclick = closeModal; formContainer.querySelector('.modal-overlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
            }

            // MODIFIED: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Export ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            function exportJobsForSorting() {
                const checkedCheckboxes = container.querySelectorAll('.job-checkbox:checked');
                const checkedIds = Array.from(checkedCheckboxes).map(cb => String(cb.dataset.id));

                let jobsToExport;

                if (checkedIds.length > 0) {
                    // 1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -> Export ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    jobsToExport = state.jobs.filter(j => checkedIds.includes(String(j.id)));
                } else {
                    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏¢ -> Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡∏≤‡∏° Filter)
                    const qDate = el('#j_date').value;
                    const qStr = (el('#j_search').value || '').toLowerCase();
                    jobsToExport = state.jobs.filter(j => {
                        const dateMatch = !qDate || sameDay(j.date, qDate);
                        const searchMatch = !qStr || j.name.toLowerCase().includes(qStr);
                        return dateMatch && searchMatch;
                    });
                }

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡∏î
                jobsToExport.sort((a, b) => (a.cut || "").localeCompare(b.cut || ""));

                if (jobsToExport.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export');
                    return;
                }

                const headers = ['date', 'name', 'cut', 'STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK'];
                const dataToExport = jobsToExport.map(job => {
                    const qty = job.qty || {};
                    return [
                        job.date,
                        job.name,
                        job.cut || '',
                        qty.STAMP || 0,
                        qty.STK || 0,
                        qty.CTT || 0,
                        qty.LASER || 0,
                        qty.TUBE || 0,
                        qty.PACK || 0
                    ];
                });

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Jobs");
                
                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `Jobs_For_Sorting_${today}.xlsx`);
            }

            function setupRealtimeSubscriptions() { const jobChannel = supabaseClient.channel('public:jobs'); jobChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' }, async (payload) => { await internal_load(); }).subscribe(); }
            return { initializeApp };
        })();
        
        // --- SALES REPORT SYSTEM MODULE ---
        window.salesReportSystem = (() => {
            let isInitialized = false;
            let container, startDateInput, endDateInput, generateBtn, exportBtn, reportTbody, reportTableHead, reportPlaceholder, categoryFilter, productSearch;
            let reportData = [];
            let allChannels = [];

            function initializeApp() {
                if (isInitialized) return;
                container = document.getElementById('sales-report-system-container');
                startDateInput = container.querySelector('#report-start-date');
                endDateInput = container.querySelector('#report-end-date');
                generateBtn = container.querySelector('#generate-report-btn');
                exportBtn = container.querySelector('#export-report-btn');
                reportTableHead = container.querySelector('#report-table thead');
                reportTbody = container.querySelector('#report-tbody');
                reportPlaceholder = container.querySelector('#report-placeholder');
                categoryFilter = container.querySelector('#report-category-filter');
                productSearch = container.querySelector('#report-product-search');

                const todayStr = new Date().toLocaleDateString('en-CA'); // ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï YYYY-MM-DD ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
	document.getElementById('master-status-start-date').value = todayStr;
	document.getElementById('master-status-end-date').value = todayStr;

                generateBtn.addEventListener('click', generateReport);
                exportBtn.addEventListener('click', exportToExcel);
                
                categoryFilter.addEventListener('change', renderReportTable);
                productSearch.addEventListener('input', renderReportTable);

                isInitialized = true;
                populateCategories();
            }
            
            async function populateCategories() {
                try {
                    const { data, error } = await supabaseClient
                        .from('products')
                        .select('product_category');
                    if (error) throw error;
                    
                    const categories = [...new Set(data.map(p => p.product_category).filter(Boolean))].sort();
                    
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilter.appendChild(option);
                    });

                } catch (err) {
                    console.error("Error populating categories:", err);
                }
            }

            async function generateReport() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                if (!startDate || !endDate) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                    return;
                }
                loadingOverlay.style.display = 'flex';
                reportPlaceholder.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                reportTbody.innerHTML = '';
                exportBtn.style.display = 'none';

                try {
                    let allData = [];
                    let from = 0;
                    let to = 999;
                    let hasMore = true;

                    // --- ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞ 1,000 ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î ---
                    while (hasMore) {
                        const { data, error } = await supabaseClient.from('orders')
                            .select('channel_code, order_items(*, products(product_code, product_category))')
                            .in('status', ['‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)'])
                            .gte('entry_date', startDate)
                            .lte('entry_date', endDate)
                            .range(from, to); // ‡πÉ‡∏ä‡πâ range ‡πÅ‡∏ó‡∏ô limit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡πÜ

                        if (error) throw error;

                        allData = allData.concat(data);
                        
                        if (data.length < 1000) {
                            hasMore = false; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1,000 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
                        } else {
                            from += 1000;
                            to += 1000;
                        }
                    }
                    
                    const productMap = new Map();
                    const channelSet = new Set();

                    // ‡πÉ‡∏ä‡πâ allData ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                    allData.forEach(order => {
                        const channel = (order.channel_code || 'N/A').toUpperCase();
                        channelSet.add(channel);
                        (order.order_items || []).forEach(item => {
                            if (item.products) {
                                const productId = item.product_id;
                                if (!productMap.has(productId)) {
                                    productMap.set(productId, {
                                        code: item.products.product_code,
                                        name: item.product_name,
                                        category: item.products.product_category,
                                        channels: {},
                                        total: 0
                                    });
                                }
                                const pData = productMap.get(productId);
                                pData.channels[channel] = (pData.channels[channel] || 0) + 1;
                                pData.total += 1;
                            }
                        });
                    });

                    allChannels = Array.from(channelSet).sort();
                    reportData = Array.from(productMap.values());
                    renderReportTable();

                } catch (err) {
                    console.error('Error generating report:', err);
                    reportPlaceholder.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + err.message;
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function renderReportTable() {
                const selectedCategory = categoryFilter.value;
                const searchTerm = productSearch.value.toLowerCase();

                const filteredData = reportData.filter(product => {
                    const categoryMatch = (selectedCategory === 'all') || (product.category === selectedCategory);
                    const searchMatch = !searchTerm || product.name.toLowerCase().includes(searchTerm);
                    return categoryMatch && searchMatch;
                });

                reportTbody.innerHTML = '';
                reportTableHead.innerHTML = '';

                if (filteredData.length === 0) {
                    reportPlaceholder.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                    reportPlaceholder.style.display = 'block';
                    exportBtn.style.display = 'none';
                    reportTableHead.innerHTML = '<tr><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th></tr>';
                    return;
                }
                let headerHTML = '<tr><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>';
                allChannels.forEach(channel => {
                    headerHTML += `<th style="text-align: center;">${channel}</th>`;
                });
                headerHTML += '<th style="text-align: center; background-color: #e2e3e5;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th></tr>';
                reportTableHead.innerHTML = headerHTML;
                
                filteredData.sort((a, b) => b.total - a.total);
                
                const columnTotals = {};
                allChannels.forEach(ch => columnTotals[ch] = 0);
                let grandTotal = 0;

                filteredData.forEach(product => {
                    let rowHTML = `<tr><td>${product.code || 'N/A'}</td><td>${product.name}</td><td>${product.category || ''}</td>`;
                    allChannels.forEach(channel => {
                        const qty = product.channels[channel] || 0;
                        columnTotals[channel] += qty;
                        const displayQty = qty === 0 ? '<span style="color:#ccc;">-</span>' : `<b>${qty}</b>`;
                        rowHTML += `<td style="text-align: center;">${displayQty}</td>`;
                    });
                    grandTotal += product.total;
                    rowHTML += `<td style="text-align: center; font-weight: bold; background-color: #f8f9fa;">${product.total}</td></tr>`;
                    reportTbody.insertAdjacentHTML('beforeend', rowHTML);
                });

                let summaryRowHTML = `<tr style="background-color: #343a40; color: white; font-weight: bold; border-top: 2px solid #000;"><td colspan="3" style="text-align: right;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>`;
                allChannels.forEach(channel => {
                    summaryRowHTML += `<td style="text-align: center;">${columnTotals[channel]}</td>`;
                });
                summaryRowHTML += `<td style="text-align: center; font-size: 1.1em; background-color: #212529;">${grandTotal}</td></tr>`;
                reportTbody.insertAdjacentHTML('beforeend', summaryRowHTML);

                reportPlaceholder.style.display = 'none';
                exportBtn.style.display = 'inline-block';
            }

            function exportToExcel() {
                const selectedCategory = categoryFilter.value;
                const searchTerm = productSearch.value.toLowerCase();
                const filteredData = reportData.filter(product => {
                    const categoryMatch = (selectedCategory === 'all') || (product.category === selectedCategory);
                    const searchMatch = !searchTerm || product.name.toLowerCase().includes(searchTerm);
                    return categoryMatch && searchMatch;
                });

                if (filteredData.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export');
                    return;
                }

                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const headers = ["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", ...allChannels, "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"];
                
                const dataToExport = filteredData.map(item => {
                    const row = [item.code, item.name, item.category];
                    allChannels.forEach(ch => {
                        row.push(item.channels[ch] || 0);
                    });
                    row.push(item.total);
                    return row;
                });
                
                const summaryRow = ["", "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", ""];
                allChannels.forEach(ch => {
                    const sum = filteredData.reduce((acc, item) => acc + (item.channels[ch] || 0), 0);
                    summaryRow.push(sum);
                });
                const grandSum = filteredData.reduce((acc, item) => acc + item.total, 0);
                summaryRow.push(grandSum);
                dataToExport.push(summaryRow);

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Sales Report");
                
                const colWidths = headers.map(() => ({ wch: 15 }));
                colWidths[1].wch = 40; // product_name
                colWidths[2].wch = 25; // product_category
                worksheet['!cols'] = colWidths;
                
                XLSX.writeFile(workbook, `SalesReport_${startDate}_to_${endDate}.xlsx`);
            }
            return { initializeApp };
        })();
        
        // --- INITIAL LOAD ---
        checkAuth();
        window.addEventListener('pageshow', function (event) { if (event.persisted) { console.log("Page loaded from bfcache. Re-initializing."); checkAuth(); } });
    });
</script>

    <!-- Product Add/Edit Modal -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="product-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="product-form">
                <input type="hidden" id="product-id-input">
                <div class="modal-form-group">
                    <label for="product-code-input">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (product_code)</label>
                    <input type="text" id="product-code-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="product-name-input">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (product_name)</label>
                    <input type="text" id="product-name-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="product-category-input">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (product_category)</label>
                    <input type="text" id="product-category-input">
                </div>
                 <div class="modal-form-group">
                    <label for="product-type-input">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (product_type)</label>
                    <input type="text" id="product-type-input">
                </div>
                <div id="rubber-code-group" class="modal-form-group" style="display: none;">
                    <label for="product-rubber-code-input">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤‡∏á (rubber_code)</label>
                    <input type="text" id="product-rubber-code-input">
                </div>
                <div class="modal-form-group">
                    <label for="storage-location-input">‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö (storage_location)</label>
                    <input type="text" id="storage-location-input">
                </div>
	<div class="modal-form-group">
    	<label for="product-image-input">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà)</label>
   	<input type="file" id="product-image-input" accept="image/*">
    	<div id="image-preview-container" style="margin-top: 10px; text-align: center;">
        	<img id="product-image-preview" src="" style="max-width: 100%; height: 150px; object-fit: contain; border: 1px solid #ddd; display: none;">
    </div>
</div>
                <div class="modal-actions">
                    <button type="button" id="cancel-product-modal-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

<!-- Carrier Selection Modal -->
<div id="carrier-selection-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏™‡πà‡∏á</h3>
        <p style="font-size: 14px; color: #666;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV</p>
        <div class="modal-form-group">
            <select id="carrier-select" style="width: 100%;"></select>
        </div>
        <div class="modal-actions">
            <button type="button" id="cancel-carrier-modal" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="button" id="confirm-export-tracking-btn" class="btn btn-success">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
        </div>
    </div>
</div>    

    <!-- Picking Slip Modal -->
    <div id="picking-slip-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="picking-slip-modal-title">‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div id="picking-slip-preview"></div>
            <div class="modal-actions">
                <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
                <button type="button" id="export-all-picking-btn" class="btn btn-primary" style="background-color: #6610f2;">
                    üöÄ Export All (PNG, CSV, XLSX)
                </button>
                <button type="button" id="cancel-picking-slip-modal-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Claim Details Modal -->
    <div id="claim-details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="claim-modal-title">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</h2>
            <form id="claim-details-form">
                <div class="modal-form-group">
                    <label for="claim-type-select">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</label>
                    <select id="claim-type-select" class="modal-input" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                        <!-- Options will be populated by JS -->
                        <option value="new">-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà --</option>
                    </select>
                </div>
                <div class="modal-form-group" id="new-claim-type-group" style="display: none;">
                    <label for="new-claim-type-input">‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="text" id="new-claim-type-input" class="modal-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î, ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏û‡∏•‡∏≤‡∏î">
                </div>
                <div class="modal-form-group">
                    <label for="claim-details-textarea">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="claim-details-textarea" rows="4" class="modal-input" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-claim-modal-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Ñ‡∏•‡∏°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden Container for PNG Generation -->
    <div id="picking-slip-png-container"></div>

    <!-- Waybill Sorter Modal -->
    <div id="waybill-sorter-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <h2>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h2>
            <p id="waybill-sorter-wo-name" style="margin-bottom: 15px; color: #6c757d;"></p>
            
            <div style="text-align: center; margin-bottom: 15px;">
                 <button id="select-pdf-folder-btn" class="btn btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå PDF ‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤</button>
                 <input type="file" id="pdf-folder-input" style="display: none;" webkitdirectory multiple accept="application/pdf">
                 <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>

            <!-- Settings -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; margin-bottom: 20px; padding: 15px 0; border-top: 1px solid #e9ecef; border-bottom: 1px solid #e9ecef;">
                <div>
                    <label for="ws-crop-top" style="font-size: 14px; color: #6c757d; display: block; margin-bottom: 5px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OCR (%)</label>
                    <input type="number" id="ws-crop-top" value="25" min="10" max="60" step="5" style="width: 120px; margin: 0 auto; padding: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: center;">
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà 20-30% ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏°‡∏∏‡∏°‡∏ö‡∏ô</p>
                </div>
                <div>
                    <label for="ws-batch-size" style="font-size: 14px; color: #6c757d; display: block; margin-bottom: 5px;">‡∏Ç‡∏ô‡∏≤‡∏î batch ‡∏ï‡∏≠‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡∏ô‡πâ‡∏≤/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</label>
                    <input type="number" id="ws-batch-size" value="25" min="5" max="100" step="5" style="width: 120px; margin: 0 auto; padding: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: center;">
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô = ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ RAM ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô</p>
                </div>
            </div>

            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 20px;">
              <div><p style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</p><p id="ws-stat-csv" style="font-size: 22px; font-weight: bold;">--</p></div>
              <div><p style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">‡πÑ‡∏ü‡∏•‡πå PDF</p><p id="ws-stat-pdf" style="font-size: 22px; font-weight: bold;">--</p></div>
              <div><p style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p><p id="ws-stat-found" style="font-size: 22px; font-weight: bold; color: #28a745;">--</p></div>
            </div>

            <!-- Progress + log -->
            <div>
              <div style="width: 100%; background: #e9ecef; border-radius: 99px; height: 12px; overflow: hidden;"><div id="ws-progress-bar" style="background: #0071e3; height: 100%; width: 0%; transition: width 0.3s;"></div></div>
              <pre id="ws-status-log" style="margin-top: 10px; font-size: 13px; color: #495057; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; height: 120px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>

            <div class="modal-actions">
                <button type="button" id="ws-download-missing-btn" class="btn btn-info" disabled>CSV ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö</button>
                <button type="button" id="ws-close-btn" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
</body>
</html>
