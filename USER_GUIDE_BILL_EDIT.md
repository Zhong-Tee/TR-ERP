# คู่มือการใช้งาน: ระบบยกเลิกและสร้างบิลใหม่

## สารบัญ
1. [ภาพรวม](#ภาพรวม)
2. [โซนการแก้ไข](#โซนการแก้ไข)
3. [การแก้ไขโดยตรง (โซนเขียว)](#การแก้ไขโดยตรง-โซนเขียว)
4. [การขอยกเลิกบิล (โซนเหลือง)](#การขอยกเลิกบิล-โซนเหลือง)
5. [บิลจัดส่งแล้ว (โซนแดง)](#บิลจัดส่งแล้วโซนแดง)
6. [Plan Dashboard: จัดการสินค้าที่ยกเลิก](#plan-dashboard-จัดการสินค้าที่ยกเลิก)
7. [สิทธิ์ผู้ใช้งาน](#สิทธิ์ผู้ใช้งาน)
8. [คำถามที่พบบ่อย](#คำถามที่พบบ่อย)

---

## ภาพรวม

ระบบนี้ออกแบบมาเพื่อจัดการกรณีที่ต้องแก้ไขบิลที่ลงข้อมูลผิดหรือลูกค้าขอเปลี่ยนแปลง โดยแบ่งการทำงานตาม **สถานะของบิล** ออกเป็น 3 โซน:

| โซน | สถานะบิล | วิธีจัดการ |
|------|----------|-----------|
| เขียว | ก่อนเข้า WMS (รอลงข้อมูล, ตรวจสอบแล้ว, ฯลฯ) | แก้ไขได้โดยตรง |
| เหลือง | อยู่ใน WMS/กำลังผลิต (ใบสั่งงาน, ใบงานกำลังผลิต) | ยกเลิกบิลเดิม แล้วสร้างใหม่ |
| แดง | จัดส่งแล้ว | ใช้ระบบเคลม (REQxxx) |

---

## โซนการแก้ไข

### ตรวจสอบโซนของบิล
1. ไปที่ **เมนูบัญชี** > **แก้ไขบิล**
2. ค้นหาบิลที่ต้องการ
3. คอลัมน์ **"โซนแก้ไข"** จะแสดง:
   - **แก้ไขได้** (เขียว) — กดแก้ไขได้เลย
   - **ขอยกเลิก** (เหลือง) — ต้องส่งคำขอยกเลิก
   - **เคลม** (แดง) — ใช้ระบบเคลมแทน
   - **ปิด** (เทา) — บิลถูกยกเลิกแล้ว

---

## การแก้ไขโดยตรง (โซนเขียว)

สำหรับบิลที่ยังไม่เข้า WMS:

1. กดปุ่ม **"แก้ไข"** ที่บิลที่ต้องการ
2. ระบบจะเปิดฟอร์มแก้ไขบิลพร้อมข้อมูลเดิม
3. แก้ไขข้อมูลตามต้องการ (ชื่อลูกค้า, ที่อยู่, รายการสินค้า, ฯลฯ)
4. สามารถเปลี่ยนสถานะบิลได้จาก dropdown ด้านบน
5. กด **"บันทึกการแก้ไข"** เมื่อเสร็จ
6. ระบบจะบันทึก revision อัตโนมัติเพื่อเก็บประวัติ

---

## การขอยกเลิกบิล (โซนเหลือง)

สำหรับบิลที่อยู่ในขั้นตอนผลิต/จัดสินค้าแล้ว:

### ขั้นตอนสำหรับผู้ขอ (พนักงานแอดมิน)
1. ค้นหาบิลในหน้า **แก้ไขบิล**
2. กดที่บิลที่มีป้าย **"ขอยกเลิก"** (เหลือง)
3. ระบบจะแสดง popup แจ้งว่าต้องขอยกเลิกก่อน
4. กดปุ่ม **"ขอยกเลิกบิลนี้"**
5. เลือกประเภทเหตุผล:
   - **พนักงานลงผิด** — กรณีแอดมินเปิดบิลผิด
   - **ลูกค้าขอเปลี่ยน** — กรณีลูกค้าเปลี่ยนใจ
6. กรอกรายละเอียดเหตุผล
7. กด **"ส่งคำขอยกเลิกบิล"**
8. รอการอนุมัติจากผู้มีสิทธิ์ (superadmin / admin)

### ขั้นตอนสำหรับผู้อนุมัติ (superadmin / admin)
1. ไปที่ **เมนูบัญชี** > **ขอยกเลิกบิล**
2. ดูรายการคำขอที่สถานะ **"รออนุมัติ"**
3. กดเพื่อดูรายละเอียด
4. ตรวจสอบเหตุผลและรายการสินค้า
5. กด **"อนุมัติยกเลิกบิล"** หรือ **"ปฏิเสธ"**

### หลังจากอนุมัติ
- สถานะบิลเปลี่ยนเป็น **"ยกเลิก"**
- WMS orders ที่เกี่ยวข้องจะถูกยกเลิก
- พนักงานจัดสินค้าจะได้รับแจ้งเตือน
- **สลิปเดิม** สามารถใช้กับบิลใหม่ได้ (ไม่ถูกตรวจจับว่าซ้ำ)
- ผู้ขอสามารถ **สร้างบิลใหม่** ได้ในหน้าออเดอร์

---

## บิลจัดส่งแล้ว (โซนแดง)

บิลที่จัดส่งแล้วไม่สามารถแก้ไขหรือยกเลิกได้ ระบบจะแสดงข้อความแนะนำให้ใช้ **ระบบเคลม** ที่มีอยู่แล้ว:

1. ไปที่หน้า **ออเดอร์**
2. สร้าง **เคลม (REQxxx)** อ้างอิงบิลเดิม
3. ดำเนินการตามกระบวนการเคลมปกติ

---

## Plan Dashboard: จัดการสินค้าที่ยกเลิก

เมื่อบิลถูกยกเลิกแล้ว สินค้าที่อยู่ในขั้นตอนผลิตจะต้องจัดการโดยหัวหน้าแผนก

### สัญลักษณ์ Badge สีแดง
- ในหน้า **Plan Dashboard** ใบงาน (work order) ที่มีบิลถูกยกเลิกจะแสดง **badge สีแดง** เช่น `ยกเลิก 1`
- badge นี้จะปรากฏทั้งใน:
  - มุมมอง **Dashboard** (ตาราง)
  - มุมมอง **แผนก** (การ์ด)
  - มุมมอง **ปรับลำดับ** (drag & drop)

### การจัดการสินค้า
1. กดที่ **badge สีแดง** เพื่อเปิดรายละเอียด
2. ระบบจะแสดง:
   - รายชื่อบิลที่ยกเลิกในใบงานนั้น
   - รายการ WMS ที่ถูกยกเลิก (product_code, จำนวน)
   - สถานะการดำเนินการ

3. สำหรับแต่ละรายการ WMS ที่ยังรอดำเนินการ:
   - กด **"เรียกคืนได้"** — หากสินค้ายังสมบูรณ์ เรียกคืนเข้าสต๊อก
   - กด **"ของเสีย"** — หากสินค้าเสียหาย/ใช้ไปแล้ว บันทึกเป็นของเสีย

### ความหมายของสถานะสต๊อก
| สถานะ | ความหมาย |
|--------|----------|
| รอดำเนินการ (เหลือง) | ยังไม่มีการจัดการ |
| เรียกคืนแล้ว (เขียว) | สต๊อกถูกคืนกลับเข้าระบบแล้ว |
| ของเสีย (ส้ม) | บันทึกเป็นของเสีย สต๊อกไม่คืน |

> **สำคัญ:** ระบบจะ **ไม่** คืนสต๊อกอัตโนมัติเมื่อยกเลิกบิล เพราะสินค้าอาจผลิตไปแล้วและเสียหาย หัวหน้าแผนกที่เห็นสินค้าจริงจะเป็นผู้ตัดสินใจ

---

## สิทธิ์ผู้ใช้งาน

| การดำเนินการ | role ที่ใช้ได้ |
|-------------|--------------|
| ค้นหา/ดูรายการบิล | ทุก role ที่มีสิทธิ์เมนูบัญชี |
| แก้ไขบิลโดยตรง (โซนเขียว) | ทุก role ที่มีสิทธิ์ `account-bill-edit` |
| ส่งคำขอยกเลิกบิล | ทุก role ที่มีสิทธิ์ `account-amendment` |
| อนุมัติ/ปฏิเสธคำขอยกเลิก | **superadmin**, **admin** เท่านั้น |
| จัดการสต๊อก (เรียกคืน/ของเสีย) | **superadmin**, **admin** เท่านั้น |

### หมายเหตุเรื่อง Role
- `admin-tr`, `admin-pump` — พนักงานแอดมินเปิดบิลของบริษัท TR หรือ PUMP (ไม่ใช่ผู้อนุมัติ)
- `admin_qc` — พนักงานตรวจสอบคำสั่งซื้อ (ไม่ใช่ผู้อนุมัติ)
- การอนุมัติจะเป็นสิทธิ์ของ **superadmin** และ **admin** เท่านั้น

---

## คำถามที่พบบ่อย

### Q: สลิปจากบิลเก่าที่ยกเลิกจะใช้กับบิลใหม่ได้ไหม?
**A:** ได้ ระบบจะไม่ตรวจจับว่าสลิปซ้ำเมื่อบิลเดิมมีสถานะ "ยกเลิก"

### Q: สินค้าที่ผลิตไปแล้วจะจัดการอย่างไร?
**A:** หัวหน้าแผนกจะเป็นผู้ตัดสินใจในหน้า Plan Dashboard ว่าจะ "เรียกคืน" (สต๊อกคืน) หรือ "ของเสีย" (ไม่คืนสต๊อก)

### Q: ถ้ายกเลิก 1 บิลใน work order ที่มีหลายบิล บิลอื่นจะหยุดไหม?
**A:** ไม่ บิลอื่นในใบงานเดียวกันยังผลิตต่อได้ตามปกติ เฉพาะบิลที่ยกเลิกเท่านั้นที่จะแสดง badge สีแดง

### Q: ใครจะเห็นว่ามีบิลถูกยกเลิก?
**A:** ทุกคนที่เข้าหน้า Plan Dashboard จะเห็น badge สีแดงบนใบงาน แต่เฉพาะ superadmin/admin เท่านั้นที่กดปุ่มดำเนินการได้

### Q: บิลที่จัดส่งแล้วต้องทำอย่างไร?
**A:** ใช้ระบบเคลมที่มีอยู่แล้ว สร้างเคลม (REQxxx) อ้างอิงบิลเดิม
